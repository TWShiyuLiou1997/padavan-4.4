name: Custom-Router-Build-Final-Fix

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "é¸æ“‡æ©Ÿå‹ (æ”¯æ´ K2P, K2P-NANO, K2P-USB ç­‰)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
          - MI-R3G
          - NEWIFI3
          - RM2100
        default: K2P

      nanoversion:
        description: "æ˜¯å¦åŸ·è¡Œæ¥µé™ç˜¦èº«"
        type: boolean
        default: true
      
      customization:
        description: 'è‡ªå®šç¾©é…ç½® JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'
      
      toolchain_select:
        description: "é¸æ“‡ç·¨è­¯å·¥å…·éˆ"
        required: true
        type: choice
        options:
          - Default (hanwckf/linux-4.4-v1.0, uclibc)
          - Padavan-NG (GCC 13+, uClibc-ng, ZSTD)
          - TurboTse/musl (gcc 13.3.0, musl 1.2.5)
          - TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)
          - tsl0922/musl (gcc 13.2.0, musl 1.2.4)
          - tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)
          - hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)
        default: Default (hanwckf/linux-4.4-v1.0, uclibc)

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: ğŸ“¥-Checkout-Repository
        uses: actions/checkout@master
      
      - name: ğŸš€-Install-Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git zstd \
            build-essential fakeroot flex bison gawk gperf \
            autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq
          # è¨­å®šå°ç£æ™‚é–“ YYYYMMDD-HHMM
          echo "BUILD_TIME=$(TZ='Asia/Taipei' date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir -p /opt/images/

      - name: ğŸ”-Export-Custom-Variables
        run: |
          jq empty <<< '${{ inputs.customization }}' || { echo "âŒ Invalid JSON"; exit 1; }
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            echo "${k^^}=$v" >> $GITHUB_ENV  
          done

      - name: â¬‡ï¸-Clone-Source-Code
        run: |
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-4.4.git /opt/rt-n56u

      # =======================================================
      # [å®Œå…¨æ¬é‹ç‰ˆ] BusyBox 1.37.0 (Sync from padavan-ng)
      # =======================================================
      - name: ğŸ”¥ Sync BusyBox from padavan-ng
        run: |
          echo "::group::Sync BusyBox 1.37.0"
          
          # å®šç¾©è·¯å¾‘
          BASE_DIR="/opt/rt-n56u/trunk/user"
          TARGET_DIR="$BASE_DIR/busybox"
          
          # 1. æ¸…ç†èˆŠç›®éŒ„ (åŸæœ¬æ˜¯ 1.24.x)
          echo "ğŸ—‘ï¸ Removing old busybox directory..."
          rm -rf "$TARGET_DIR"
          
          # 2. é€éè‡¨æ™‚ç›®éŒ„ Clone padavan-ng
          # (å¦‚æœä¹‹å‰æ­¥é©Ÿå·²ç¶“ clone éï¼Œé€™è£¡å¯ä»¥æª¢æŸ¥ä¸¦é‡ç”¨ï¼Œæˆ–æ˜¯é‡æ–° clone)
          if [ ! -d "/tmp/padavan-ng" ]; then
              echo "â¬‡ï¸ Cloning padavan-ng repo..."
              git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-ng.git /tmp/padavan-ng
          else
              echo "â„¹ï¸ Repo already cloned, syncing..."
              cd /tmp/padavan-ng && git pull
          fi
          
          # 3. æ¬é‹ busybox ç›®éŒ„
          echo "ğŸšš Syncing busybox folder..."
          if [ -d "/tmp/padavan-ng/trunk/user/busybox" ]; then
              cp -rf /tmp/padavan-ng/trunk/user/busybox "$TARGET_DIR"
              echo "âœ… æˆåŠŸå¾ padavan-ng åŒæ­¥ busybox ç›®éŒ„"
          else
              echo "âŒ Error: ä¾†æº Repo ä¸­æ‰¾ä¸åˆ° busybox ç›®éŒ„"
              exit 1
          fi
          
          # 4. é€²å…¥ç›®éŒ„æº–å‚™ç·¨è­¯ç’°å¢ƒ
          cd "$TARGET_DIR"
          
          # 5. é©—è­‰ Makefile æ˜¯å¦æ­£ç¢º (ç¢ºèªæ˜¯å¦ç‚º 1.37.0)
          if grep -q "SRC_NAME=busybox-1.37.0" Makefile; then
              echo "âœ… ç‰ˆæœ¬ç¢ºèª: 1.37.0 (Makefile é©—è­‰é€šé)"
              
              # [é—œéµæ­¥é©Ÿ] åŸ·è¡Œ Makefile å…§çš„ä¸‹è¼‰èˆ‡è§£å£“è¦å‰‡
              # æ–°ç‰ˆ Makefile å®šç¾©äº† download_test å’Œ extract_test
              # æˆ‘å€‘å¿…é ˆæ‰‹å‹•è§¸ç™¼å®ƒå€‘ï¼Œå¦å‰‡ç·¨è­¯æ™‚æœƒå› ç‚ºæ²’æœ‰æºç¢¼è€Œå¤±æ•—
              
              echo "â¬‡ï¸ Running make download_test..."
              make download_test || { echo "âŒ Download failed"; exit 1; }
              
              echo "ğŸ“¦ Running make extract_test..."
              # æ³¨æ„ï¼šæ–°ç‰ˆ Makefile çš„ extract_test åŒ…å«äº† patch æ‡‰ç”¨é‚è¼¯
              make extract_test || { echo "âŒ Extract/Patch failed"; exit 1; }
              
              # å†æ¬¡ç¢ºèªè§£å£“çµæœ
              if [ -d "busybox-1.37.0" ]; then
                  echo "âœ… æºç¢¼å·²å°±ç·’ (busybox-1.37.0)"
              else
                  echo "âŒ æºç¢¼è§£å£“å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Makefile è¨­å®š"
                  exit 1
              fi
          else
              echo "âš ï¸ è­¦å‘Šï¼šåŒæ­¥éä¾†çš„ Makefile ç‰ˆæœ¬ä¼¼ä¹ä¸æ˜¯ 1.37.0ï¼Œè«‹æª¢æŸ¥ï¼"
              cat Makefile | grep SRC_NAME
              # é€™è£¡ä¸ exitï¼Œè®“æµç¨‹å˜—è©¦ç¹¼çºŒï¼Œæˆ–è¨±åªæ˜¯ç‰ˆæœ¬è™Ÿè®Šæ•¸ä¸åŒ
          fi
          
          # 6. å…¨å±€ä¾è³´ä¿®å¾©
          # èˆŠç‰ˆè·¯å¾‘é€šå¸¸æ˜¯ busybox-1.24.xï¼Œæ–°ç‰ˆæ˜¯ busybox-1.37.0
          # æˆ‘å€‘éœ€è¦æƒæ trunk/user ä¸‹æ‰€æœ‰ Makefileï¼ŒæŠŠèˆŠç‰ˆè·¯å¾‘æ›¿æ›æ‰
          echo "ğŸ” ä¿®å¾©ä¾è³´èˆŠç‰ˆ (busybox-1.24.x) çš„å…¶ä»–çµ„ä»¶..."
          
          # å®šç¾©èˆŠç‰ˆå­—ä¸² (æ ¹æ“šä½ æä¾›çš„è³‡è¨Š)
          OLD_VER_STR="busybox-1.24.x"
          NEW_VER_STR="busybox-1.37.0"
          
          # æœå°‹ä¸¦æ›¿æ›
          grep -rl "$OLD_VER_STR" "$BASE_DIR" | while read -r file ; do
              echo "  - Patching dependency in: $file"
              sed -i "s/$OLD_VER_STR/$NEW_VER_STR/g" "$file"
          done
          
          # é¡å¤–æª¢æŸ¥ï¼šæœ‰äº›åœ°æ–¹å¯èƒ½å¯«æ­» busybox-1.24.2
          grep -rl "busybox-1.24.2" "$BASE_DIR" | while read -r file ; do
              echo "  - Patching specific version dependency in: $file"
              sed -i "s/busybox-1.24.2/$NEW_VER_STR/g" "$file"
          done
          
          echo "ğŸ‰ BusyBox åŒæ­¥èˆ‡ç’°å¢ƒä¿®å¾©å®Œæˆï¼"
          echo "::endgroup::"
      
      # =======================================================
      # [å®Œå…¨æ¬é‹ç‰ˆ] ç›´æ¥å¾ Repo ä¸‹è¼‰ libmnl è¦†è“‹
      # =======================================================
      - name: ğŸ”¥ Sync libmnl from padavan-ng repo
        run: |
          echo "::group::Direct Sync libmnl"
          
          # 1. é€²å…¥ libs ç›®éŒ„ä¸¦ç§»é™¤èˆŠçš„ libmnl
          cd /opt/rt-n56u/trunk/libs
          rm -rf libmnl
          
          # 2. é€éè‡¨æ™‚ç›®éŒ„ Clone è©² Repo (åªæŠ“ master åˆ†æ”¯)
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-ng.git /tmp/padavan-ng
          
          # 3. æŠŠè©² Repo è£¡çš„ libmnl å®Œæ•´æ‹·è²éä¾†
          cp -rf /tmp/padavan-ng/trunk/libs/libmnl ./libmnl
          
          # 4. æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
          rm -rf /tmp/padavan-ng
          
          # 5. æª¢æŸ¥ç¢ºèªæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "./libmnl/Makefile" ]; then
            echo "âœ… libmnl æ¬é‹æˆåŠŸï¼ä½¿ç”¨ padavan-ng åŸå§‹è…³æœ¬ã€‚"
            ls -al ./libmnl
          else
            echo "::error::âŒ æ¬é‹å¤±æ•—ï¼æ‰¾ä¸åˆ° Makefile"
            exit 1
          fi
          
          echo "::endgroup::"

      # =======================================================
      # [çµ‚æ¥µæ”¶é›†ç‰ˆ] iptables Patch Collector & Patcher
      # =======================================================
      - name: ğŸ”¥ Collect & Patch iptables (Enhanced Logic)
        run: |
          set +e  # é—œé–‰éŒ¯èª¤ä¸­æ–·ï¼Œç¢ºä¿è·‘å®Œå…¨ç¨‹
          set -x  # å¦‚æœéœ€è¦æ¥µè‡´ Debug å¯æ‰“é–‹æ­¤è¡Œ
          
          echo "::group::Patching Iptables 1.8.7 (Collector Mode)"
          
          # =======================================================
          # âš™ï¸ è¨­å®šå€
          # =======================================================
          # æ˜¯å¦è¦åŸ·è¡Œå¥—ç”¨ Patchï¼Ÿ (true=å¥—ç”¨, false=åƒ…ä¸‹è¼‰æ”¶é›†)
          APPLY_PATCHES=true
          
          IPT_ROOT="/opt/rt-n56u/trunk/user/iptables/iptables-1.8.7"
          PATCH_DIR="patches_archive"
          LOG_FILE="patch_summary.log"
          
          # å„ªåŒ–å…¨å±€ç¶²è·¯è¨­ç½®
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global http.sslVerify false
          
          if [ ! -d "$IPT_ROOT" ]; then
             echo "âŒ Error: æ‰¾ä¸åˆ°åŸå§‹ç¢¼ç›®éŒ„ $IPT_ROOT"
             exit 1
          fi
          
          cd "$IPT_ROOT"
          mkdir -p "$PATCH_DIR"
          touch "$LOG_FILE"

          # =======================================================
          # ğŸ› ï¸ V4 çµ‚æ¥µå‡½æ•¸: æ··åˆç­–ç•¥ (ä½é »è«‹æ±‚ + å‹•æ…‹å½è£ + è‡ªå‹•æ¸…æ´—)
          # =======================================================
          download_and_process() {
              local DATE=$1
              local RAW_NAME=$2
              local URL=$3
              local COUNT=$4
              
              # å‘½åæ¸…æ´—
              local SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9]/_/g')
              local PATCH_FILENAME="$PATCH_DIR/${COUNT}_${DATE}_${SAFE_NAME}.patch"
              local COOKIE_FILE="cookies.txt"
              
              echo "---------------------------------------------------"
              echo "Processing Patch #$COUNT: $RAW_NAME"

              # [æˆ°ç•¥ 1] é™ä½ç‰¹å¾µè®Šæ›´é »ç‡ï¼šæ¯ 10 å€‹æª”æ¡ˆæ‰æ›ä¸€æ¬¡ UA
              # æ¨¡æ“¬åŒä¸€å€‹äººåœ¨åŒä¸€å€‹ç€è¦½å™¨è¦–çª—æ“ä½œï¼Œè€Œä¸æ˜¯ç²¾ç¥åˆ†è£‚æ¯ç§’æ›ä¸€å€‹ç‰ˆæœ¬
              if [ $((COUNT % 10)) -eq 1 ] || [ ! -f ua_cache.txt ]; then
                  local MINOR_VER=$((RANDOM % 100))
                  echo "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.${MINOR_VER}.0 Safari/537.36" > ua_cache.txt
                  # åŒæ™‚é‡ç½® Cookieï¼Œæ¨¡æ“¬æ–° Session
                  rm -f "$COOKIE_FILE"
                  echo "ğŸ”„ Session Rotate: New UA & Cookies generated."
              fi
              local UA=$(cat ua_cache.txt)

              # [æˆ°ç•¥ 2] Header å›ºå®šåŒ–
              local H_SEC_CH_UA='"Not(A:Brand";v="8", "Chromium";v="144", "Google Chrome";v="144"'
              local H_SEC_PLATFORM='"Windows"'
              local H_LANG="en-US,en;q=0.9" 
              local ACCEPT_FILE="text/x-diff,text/plain,application/octet-stream;q=0.9,*/*;q=0.8"
              
              # è¨ˆç®— URL
              local COMMIT_URL=$(echo "$URL" | sed 's|/patch/|/commit/|')
              local LOG_URL="https://git.netfilter.org/iptables/log/"
              
              # [æˆ°ç•¥ 3] éš¨æ©Ÿé•·ä¼‘æ¯ (Human Fatigue)
              # åœ¨ #30, #60, #90 é™„è¿‘éš¨æ©Ÿé€²è¡Œé•·ä¼‘æ¯ï¼Œé¿é–‹ V3 åœ¨ #33 è¢«æ®ºçš„é–€æª»
              if [ $((COUNT % 30)) -eq 0 ]; then
                  local SLEEP_LONG=$(shuf -i 20-40 -n 1)
                  echo "â˜• Coffee Break: Sleeping for ${SLEEP_LONG}s..."
                  sleep $SLEEP_LONG
              else
                  # ä¸€èˆ¬éš¨æ©Ÿå»¶é² 2-4 ç§’
                  sleep $(shuf -i 2-4 -n 1)
              fi

              # ===================================================
              # åŸ·è¡Œä¸‹è¼‰
              # ===================================================
              local MAX_RETRIES=5
              local DOWNLOAD_SUCCESS=false

              for ((i=1; i<=MAX_RETRIES; i++)); do
                  local BACKOFF_TIME=$((5 * i + 5))
                  
                  # æ±ºå®šæ˜¯å¦è¦ã€Œæ¼”å…¨å¥—ã€(è«‹æ±‚ Commit é é¢)
                  # V3 å¤±æ•—æ˜¯å› ç‚ºæ¯æ¬¡éƒ½æ¼”ï¼Œå°è‡´è«‹æ±‚é‡çˆ†ç‚¸ã€‚
                  # V4 ç­–ç•¥ï¼šåªæœ‰ 20% æ©Ÿç‡æ¼”å…¨å¥—ï¼Œæˆ–è€…å¤±æ•—é‡è©¦æ™‚æ‰æ¼”ã€‚
                  local PREFLIGHT_DONE=false
                  if [ $((RANDOM % 5)) -eq 0 ] || [ $i -gt 1 ]; then
                      echo "ğŸ­ Performing Pre-flight check (Visiting Commit Page)..."
                      curl -k -L -s -o /dev/null \
                           -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                           -H "User-Agent: $UA" \
                           -H "Referer: $LOG_URL" \
                           "$COMMIT_URL"
                      sleep 1
                      PREFLIGHT_DONE=true
                  fi

                  # è¨­å®š Referer
                  # å¦‚æœå‰›æ‰æ¼”éå…¨å¥—ï¼ŒReferer å°±æ˜¯ Commit é  (çœŸå¯¦)
                  # å¦‚æœæ²’æ¼”ï¼ŒReferer è¨­ç‚º Log åˆ—è¡¨é  (V1 çš„æˆåŠŸç¶“é©—)
                  if [ "$PREFLIGHT_DONE" = true ]; then
                      local CUR_REFERER="$COMMIT_URL"
                  else
                      local CUR_REFERER="$LOG_URL"
                  fi

                  # å˜—è©¦ä¸‹è¼‰
                  if curl -k -L -s \
                       -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                       -H "User-Agent: $UA" \
                       -H "Accept: $ACCEPT_FILE" \
                       -H "Accept-Language: $H_LANG" \
                       -H "Referer: $CUR_REFERER" \
                       -H "sec-ch-ua: $H_SEC_CH_UA" \
                       -H "sec-ch-ua-platform: $H_SEC_PLATFORM" \
                       --connect-timeout 20 \
                       --retry 2 \
                       -o "$PATCH_FILENAME" "$URL"; then
                      
                      # é©—è­‰å…§å®¹
                      if [ -s "$PATCH_FILENAME" ] && grep -qE "^diff --git|^--- a/" "$PATCH_FILENAME"; then
                          echo "âœ… [Attempt $i] Download Success"
                          DOWNLOAD_SUCCESS=true
                          break
                      else
                          echo "âš ï¸ Invalid content detected. Rotating identity..."
                          # å…§å®¹éŒ¯èª¤ï¼Œç«‹å³åˆªé™¤ Cookie å’Œ UA Cache å¼·åˆ¶æ›èº«ä»½
                          rm -f "$COOKIE_FILE" "ua_cache.txt"
                      fi
                  fi
                  
                  # ç­–ç•¥ B: Wget (Clean Request)
                  # å¦‚æœ Curl å¤±æ•—ï¼Œå¯èƒ½æ˜¯ Cookie å•é¡Œï¼Œç”¨ Wget å˜—è©¦ç„¡ Cookie ä¸‹è¼‰
                  # ä½† Referer ä¾ç„¶è¦é¨™å®ƒæ˜¯å¾ Commit é é¢ä¾†çš„
                  echo "âš ï¸ Curl failed. Switching to Wget..."
                  rm -f "$PATCH_FILENAME"
                  
                  if wget --no-check-certificate -q \
                       --user-agent="$UA" \
                       --header="Accept: $ACCEPT_FILE" \
                       --header="Referer: $COMMIT_URL" \
                       --header="sec-ch-ua: $H_SEC_CH_UA" \
                       --header="sec-ch-ua-platform: $H_SEC_PLATFORM" \
                       -O "$PATCH_FILENAME" "$URL"; then
                       
                      if [ -s "$PATCH_FILENAME" ] && grep -qE "^diff --git|^--- a/" "$PATCH_FILENAME"; then
                          echo "âœ… [Attempt $i] Download Success (Wget)"
                          DOWNLOAD_SUCCESS=true
                          break
                      fi
                  fi
                  
                  # å¤±æ•—å¾Œçš„å†·å»
                  echo "âŒ [Attempt $i] Failed. Cooling down ${BACKOFF_TIME}s..."
                  rm -f "$PATCH_FILENAME"
                  if [ $i -lt $MAX_RETRIES ]; then
                      sleep $BACKOFF_TIME
                  fi
              done

              # ---------------------------------------------------
              # çµæœåˆ¤å®šèˆ‡åŸ·è¡Œ
              # ---------------------------------------------------
              if [ "$DOWNLOAD_SUCCESS" = false ]; then
                  echo "âŒ DOWNLOAD FAILED: $RAW_NAME"
                  echo "[$DATE] #$COUNT DOWNLOAD_FAIL : $RAW_NAME" >> "$LOG_FILE"
                  rm -f "$PATCH_FILENAME" # æ¸…ç†ç„¡æ•ˆæª”æ¡ˆ
                  return 0
              fi
              
              # å¦‚æœé–‹é—œé–‹å•Ÿï¼ŒåŸ·è¡Œ Patch å¥—ç”¨
              if [ "$APPLY_PATCHES" = true ]; then
                  echo "ğŸ©¹ Applying patch (Max Fuzz Mode)..."
                  # -t: è‡ªå‹•è·³éç¼ºæª”, -N: è·³éå·²ä¿®å¾©, -F 10: å…è¨±10è¡Œèª¤å·®
                  if patch -t -N -l -F 10 -p1 --no-backup-if-mismatch --reject-file=- < "$PATCH_FILENAME"; then
                      echo "âœ… Patch Applied."
                  else
                      echo "âš ï¸ PATCH FAILED (Skipped/Mismatch)"
                      echo "[$DATE] #$COUNT PATCH_FAIL : $RAW_NAME" >> "$LOG_FILE"
                  fi
              else
                  echo "ğŸ“¦ Patch downloaded but NOT applied (Collection Mode)"
              fi
          }

          # -------------------------------------------------------
          # 2. å¯«å…¥ "ä¹¾æ·¨ç‰ˆ" Patch æ¸…å–® (Final Clean List - 53 Patches)
          # å·²ç§»é™¤: xsharedé‡æ§‹, xlateç¿»è­¯, ICMPè§£æ, IPv6è¨ˆæ•¸å™¨(-c)
          # -------------------------------------------------------
          cat << 'EOL' > patch_list.txt
          2021-03-09|libxtables: Simplify xtables_ipmask_to_cidr() a bit|https://git.netfilter.org/iptables/patch/?id=831f57c7fbdc8d79e34b1d7d81ca6f6a8e6bae87
          2021-04-02|extensions: libxt_conntrack: use bitops for state negation|https://git.netfilter.org/iptables/patch/?id=18e334da7363ba186edb1700056e26ded27ca5ba
          2021-04-02|extensions: libxt_conntrack: use bitops for status negation|https://git.netfilter.org/iptables/patch/?id=18d7535d8bce1a13668e9982f53cbd3e56e8c634
          2021-06-07|libxtables: Fix memleak in xtopt_parse_hostmask()|https://git.netfilter.org/iptables/patch/?id=ffe88f8f01263687e82ef4d3d2bdc0cb5444711e
          2021-06-07|nft: Avoid memleak in error path of nft_cmd_new()|https://git.netfilter.org/iptables/patch/?id=eab75ed36a4f204ddab0c40ba42c5a300634d5c3
          2021-07-14|xtables: Call init_extensions6() for static builds|https://git.netfilter.org/iptables/patch/?id=e727ccad036e2cdba3339536c65c7ceef43c0740
          2021-08-04|libxtables: exit if called by setuid executeable|https://git.netfilter.org/iptables/patch/?id=ef7781eb1437a2d6fd37eb3567c599e3ea682b96
          2021-08-04|ip6tables: masquerade: use fully-random so that nft can understand the rule|https://git.netfilter.org/iptables/patch/?id=943fbf3e1850ae1f52f29c2f4f2aca399779b368
          2021-08-10|extensions: hashlimit: Fix tests with HZ=100|https://git.netfilter.org/iptables/patch/?id=bef9dc575625a98a5e6ed8ca37e49031cdba5937
          2021-08-31|extensions: libxt_mac: Fix for missing space in listing|https://git.netfilter.org/iptables/patch/?id=cf410aa6604d92faf2a2a5051ec18b7d9482e752
          2021-10-20|xtables-standalone: Drop version number from init errors|https://git.netfilter.org/iptables/patch/?id=0687852da7ed0a7ec8ebc88b41031dcae18c8898
          2021-11-23|extensions: hashlimit: Fix tests with HZ=1000|https://git.netfilter.org/iptables/patch/?id=1eab8e83aec0e6965f11f8cad460add1caeae629
          2022-01-18|extensions: libxt_NFLOG: don't truncate log prefix on print/save|https://git.netfilter.org/iptables/patch/?id=62ad29e9b778f4419573c6b43fe7a0a00d783fe6
          2022-01-18|extensions: libxt_NFLOG: fix --nflog-prefix Python test-cases|https://git.netfilter.org/iptables/patch/?id=f0d02998883d2efcb316cd6f524e2f7b3c4d055b
          2022-01-18|extensions: libxt_NFLOG: remove extra space when saving targets with prefixes|https://git.netfilter.org/iptables/patch/?id=05286bab77a6e0f9502e8fb99e1c53ed15663f3f
          2022-02-04|iptables-restore: Support for extra debug output|https://git.netfilter.org/iptables/patch/?id=17ed253f9dd401d7b83b81f5db93411bee592a40
          2022-03-02|libxtables: Register only the highest revision extension|https://git.netfilter.org/iptables/patch/?id=2dbb49d15fb44ddd521a734eca3be3f940b7c1ba
          2022-05-25|build: Fix error during out of tree build|https://git.netfilter.org/iptables/patch/?id=0ebf52fc951b2a4d98a166afb34af4f364bbeece
          2022-06-17|iptables.8: mention that iptables exits when setuid|https://git.netfilter.org/iptables/patch/?id=15a31ba8e8e146a5dafce59160b2eeefb00bccca
          2022-07-23|extensions: libxt_conntrack: remove always-false conditionals|https://git.netfilter.org/iptables/patch/?id=e88085ac41b4c962e1d85dcc8dc6fa0d1f80dc12
          2022-10-02|extensions: TCPOPTSTRIP: Do not print empty options|https://git.netfilter.org/iptables/patch/?id=dba32a76aacf84181a9bd3ba1e301e59ab49d370
          2022-10-07|libiptc: Fix for segfault when renaming a chain|https://git.netfilter.org/iptables/patch/?id=97bf4e68fc0794adba3243fd96f40f4568e7216f
          2022-12-02|iptables-xml: Free allocated chain strings|https://git.netfilter.org/iptables/patch/?id=73da7fb74c1089391dac0aca70e13e5f5999ace7
          2022-12-02|nft: Plug memleak in nft_rule_zero_counters()|https://git.netfilter.org/iptables/patch/?id=aa0c54030300441e9fd66c7016d0090f6736d449
          2022-12-02|iptables-restore: Free handle with --test also|https://git.netfilter.org/iptables/patch/?id=18880dbde615449d00a3e38f3713a19d4566258e
          2022-12-02|iptables: Plug memleaks in print_firewall()|https://git.netfilter.org/iptables/patch/?id=fb63f8b7337aa11a667537e6a3b399062ede2eb5
          2022-12-02|libiptc: Eliminate garbage access|https://git.netfilter.org/iptables/patch/?id=39a2aa8cbfc99f4a75dfc0786a80ced90952ab29
          2023-01-31|Proper fix for unknown argument error message|https://git.netfilter.org/iptables/patch/?id=d6eb6a9fd3878ce4fa01f8d4127f1735988bd07b
          2023-06-21|iptables: Fix handling of non-existent chains|https://git.netfilter.org/iptables/patch/?id=82ccfb488eeac5507471099b9b4e6d136cc06e3b
          2023-08-01|iptables-restore: Drop dead code|https://git.netfilter.org/iptables/patch/?id=4d9453233538200e9663c6bd0c2df09e1671b5f4
          2023-08-01|iptables-apply: Eliminate shellcheck warnings|https://git.netfilter.org/iptables/patch/?id=9f98550d58a49fc95d529ebdc0173579d957b425
          2023-08-04|extensions: libipt_icmp: Fix confusion between 255/255 and any|https://git.netfilter.org/iptables/patch/?id=5b5430d627bbc227a2d51d4312c371f2015834c6
          2023-08-10|Revert libiptc: fix wrong maptype of base chain counters on restore|https://git.netfilter.org/iptables/patch/?id=43f78733059ecd28d8567d8205cab5ed62d93458
          2023-09-14|extensions: Fix checking of conntrack --ctproto 0|https://git.netfilter.org/iptables/patch/?id=2e704f6ddd6d056e360f3d9c11e8b6c56a20cf23
          2023-10-12|libiptc: Fix for another segfault due to chain index NULL pointer|https://git.netfilter.org/iptables/patch/?id=e2d7ee9c49b582f399ad4ba2da2ee1b3e1f89620
          2023-10-12|extensions: string: Clarify description of --to|https://git.netfilter.org/iptables/patch/?id=920ece2b392fb83bd26416e0e6f8f6a847aacbaa
          2023-10-25|extensions: string: Adjust description of --to to recent kernel changes|https://git.netfilter.org/iptables/patch/?id=ccecb1b90ae2af6e963d27ada8d5fd69d40231c4
          2023-11-07|ebtables: Fix corner-case noflush restore bug|https://git.netfilter.org/iptables/patch/?id=c1083acea70787eea3f7929fd04718434bb05ba8
          2023-12-15|build: replace echo -e with printf|https://git.netfilter.org/iptables/patch/?id=f5cf76626d95d2c491a80288bccc160c53b44e88
          2024-01-10|extensions: libxt_limit: Use guided option parser for NFPROTO_BRIDGE, too|https://git.netfilter.org/iptables/patch/?id=84915856a892ca316ecf427cb17f8344a999083b
          2024-01-10|extensions: libxt_HMARK: Review HMARK_parse()|https://git.netfilter.org/iptables/patch/?id=f4721951baca81b7d74c5551d0f5c599dbb89bf1
          2024-01-24|iptables: Add missing error codes|https://git.netfilter.org/iptables/patch/?id=0a118c474924f05224b215cf38b7b3a19a9f0265
          2024-02-01|libxtables: Fix memleak of matches udata|https://git.netfilter.org/iptables/patch/?id=e7366db80740d34d2fe4ba8d12ef86a423e66280
          2024-02-01|ebtables: Fix for memleak with change counters command|https://git.netfilter.org/iptables/patch/?id=11c77ed471f2d8a6dc60c17aef1e1a3b52ff3591
          2024-02-07|libxtables: Add dccp and ipcomp to xtables_chain_protos|https://git.netfilter.org/iptables/patch/?id=a369c736a7fa88a176dbdb17fd50cf30074f54ab
          2024-04-25|configure: Add option to enable/disable libnfnetlink|https://git.netfilter.org/iptables/patch/?id=653db8b938166db7833135f615b90c38a3f27a30
          2024-06-12|man: extensions: recent: Clarify default value of ip_list_hash_size|https://git.netfilter.org/iptables/patch/?id=14f313ec68e2e4ff7eeb94b0fd125f7adcab77e3
          2024-07-27|extensions: conntrack: Use the right callbacks|https://git.netfilter.org/iptables/patch/?id=bb2ee075d8a626f2249ef9507927fae155b24093
          2024-07-27|extensions: recent: Fix format string for unsigned values|https://git.netfilter.org/iptables/patch/?id=8696f659eadd58505469841a3af16ad2c830e8e5
          2024-07-27|extensions: recent: New kernels support 999 hits|https://git.netfilter.org/iptables/patch/?id=d859b91e6f3ed055c22ee7b984b481c5b518d9e1
          2024-07-31|extensions: conntrack: Reuse print_state() for old state match|https://git.netfilter.org/iptables/patch/?id=1c86d5513cd79c1df1a5e473ce51256129723f3e
          2024-08-14|ebtables: Zero freed pointers in ebt_cs_clean()|https://git.netfilter.org/iptables/patch/?id=7b7c0936303abd0a7b26c8bc1382136265815677
          2024-08-29|configure: Determine if musl is used for build|https://git.netfilter.org/iptables/patch/?id=76fce22826f8e860b5eb5b5a2463040c17ff85da
          EOL

          # -------------------------------------------------------
          # 2. è®€å–æ¸…å–®ä¸¦åŸ·è¡Œ
          # -------------------------------------------------------
          count=0
          while IFS='|' read -r p_date p_name p_url; do
              # è·³éç©ºè¡Œ
              [ -z "$p_date" ] && continue
              
              count=$((count+1))
              download_and_process "$p_date" "$p_name" "$p_url" "$count"
              
          done < patch_list.txt

          echo "ğŸ‰ Patch processing cycle completed!"
          
          if [ -s "$LOG_FILE" ]; then
              echo "âš ï¸ ================= SUMMARY ================="
              cat "$LOG_FILE"
              echo "=========================================="
          else
              echo "âœ… Perfect! No errors recorded."
          fi

          # =======================================================
          # [ç¬¬100è™Ÿ Patch] æ‡‰ç”¨å±è”½è­¦å‘Šè£œä¸ (å¯¬å®¹æ¨¡å¼)
          # =======================================================
          echo "ğŸ”§ Generating warning suppression patch (Patch #100)..."
          
          PATCH_100="$PATCH_DIR/100_Custom_Suppress_Warnings.patch"
          
          # æ³¨æ„ï¼šé€™è£¡å˜—è©¦é‡å° 1.8.7 çš„è¡Œè™Ÿé€²è¡Œå¾®èª¿ï¼Œä½†ä»å¯èƒ½å¤±æ•—
          cat << 'END_PATCH' > "$PATCH_100"
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          END_PATCH

          # åªæœ‰åœ¨é–‹å•Ÿå¥—ç”¨æ¨¡å¼æ™‚æ‰åŸ·è¡Œ
          if [ "$APPLY_PATCHES" = true ]; then
              echo "ğŸ©¹ Applying Custom Patch #100..."
              
              # å˜—è©¦ç›´æ¥ Patch (é‡å°å·²è§£å£“çš„æƒ…æ³)
              # åŠ å€‹ç°¡å–®åˆ¤æ–·é¿å… clean build å ±éŒ¯ï¼Œä½†ä¸»è¦ä¾è³´ Makefile æ³¨å…¥
              if [ -f "libxtables/xtables.c" ]; then
                  if patch -t -N -l -F 10 -p1 --no-backup-if-mismatch < "$PATCH_100"; then
                      echo "âœ… Patch #100 Applied Successfully!"
                  else
                      echo "âš ï¸ Patch #100 Failed to apply (Context mismatch)."
                  fi
              fi
              
              echo "ğŸ“¦ Patch #100 ready for Makefile injection."
          else
              echo "ğŸ“¦ Custom Patch #100 generated but NOT applied."
          fi
          
          # =======================================================
          # ğŸ” ç„¡æ¢ä»¶é©—è­‰ä»£ç¢¼å…§å®¹ (å¢å¼·ç‰ˆï¼šé¡¯ç¤ºç¨‹å¼ç¢¼ä¸Šä¸‹æ–‡)
          # =======================================================
          echo "ğŸ” Verifying code content..."
          TARGET_FILE="libxtables/xtables.c"
          
          if [ -f "$TARGET_FILE" ]; then
              # æª¢æŸ¥æ˜¯å¦å«æœ‰ç‰¹å¾µç¢¼ (#if 0 åŒ…è£¹è‘— Warning)
              if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
                  echo "âœ… Verification Passed: Code is correctly patched!"
                  echo "ğŸ‘‡ Current Code Snippet (Looks Good):"
                  # é¡¯ç¤ºåŒ¹é…è¡ŒåŠå…¶ä¸Šä¸‹ 3 è¡Œï¼Œæ–¹ä¾¿äººå·¥ç¢ºèª
                  grep -nC 3 "Warning: Extension %s is not supported" "$TARGET_FILE"
              else
                  echo "âš ï¸ Verification Failed: Code was NOT patched. (Warning suppression might not work)"
                  echo "ğŸ‘‡ Current Code Snippet (Original/Unpatched):"
                  grep -nC 3 "Warning: Extension %s is not supported" "$TARGET_FILE"
              fi
          else
              echo "â„¹ï¸ Verification skipped: Source file '$TARGET_FILE' not found yet."
              echo "   (This is normal for a clean build before compilation starts)"
          fi
          
          echo "::endgroup::"

      # =======================================================
      # [æ–°å¢] ç¶²è·¯å·¥å…·å‡ç´š v31 (è·¯å¾‘é©é… /opt/rt-n56u)
      # =======================================================
      - name: ğŸ”¥ Network Tools (Smart Compile & Robust Kernel Config)
        run: |
          echo "::group::Smart Compile Network Tools"
          
          # === è¨­å®šè·¯å¾‘ (é©é…æ­¤ workflow) ===
          BASE_DIR="/opt/rt-n56u/trunk/user"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. Arptables (ä¿®å¾© Tab é…å°å•é¡Œ + ç¢ºä¿åå–®æœ‰å®ƒ)
          # ========================================
          echo "â¬‡ï¸ Processing Arptables..."
          
          # [æ­¥é©Ÿ A] ç¢ºä¿ Userland Config é–‹å•Ÿ
          USER_CONFIG="/opt/rt-n56u/trunk/.config"
          if [ -f "$USER_CONFIG" ]; then
              echo "ğŸ”§ Enabling CONFIG_USER_ARPTABLES in Userland .config..."
              sed -i 's/^CONFIG_USER_ARPTABLES=.*/CONFIG_USER_ARPTABLES=y/' "$USER_CONFIG"
              if ! grep -q "CONFIG_USER_ARPTABLES=y" "$USER_CONFIG"; then
                  echo "CONFIG_USER_ARPTABLES=y" >> "$USER_CONFIG"
              fi
          fi

          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          # ä¸‹è¼‰åŸå§‹ç¢¼
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            wget --no-check-certificate "https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz" -O src.tar.gz
            tar -xf src.tar.gz && rm -f src.tar.gz
            
            ARP_SRC_NAME=$(ls -d arptables-0*/ | head -n 1 | sed 's/\///')
            chmod -R u+w "$ARP_SRC_NAME"
            
            echo "ğŸ”§ Creating Arptables Wrapper Makefile..."
            
            # [æ­¥é©Ÿ B] Wrapper
            cat << EOF > Makefile
          SRC_NAME=$ARP_SRC_NAME
          all:
          	\$(MAKE) -C \$(SRC_NAME) \
          		CC="\$(CC)" \
          		KERNEL_DIR=\$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		all
          	@if [ -f \$(SRC_NAME)/arptables ] && [ ! -f \$(SRC_NAME)/arptables-legacy ]; then \
          		cp \$(SRC_NAME)/arptables \$(SRC_NAME)/arptables-legacy; \
          	fi
          romfs:
          	\$(ROMFSINST) \$(SRC_NAME)/arptables-legacy /bin/arptables
          clean:
          	\$(MAKE) -C \$(SRC_NAME) clean
          	rm -f \$(SRC_NAME)/arptables-legacy
          EOF
          
            # [æ­¥é©Ÿ C] è¨»å†Šç›®éŒ„ (é‡å° Tab æœ€ä½³åŒ–)
            echo "ğŸ”§ Registering arptables in trunk/user/Makefile..."
            cd "$BASE_DIR" || exit 1
            
            # 1. å…ˆå‚™ä»½ä¸€ä¸‹
            cp Makefile Makefile.bak
            
            # 2. ä½¿ç”¨ .* ä¾†å¿½ç•¥ç©ºæ ¼æˆ– Tab çš„å·®ç•°ï¼Œç¢ºä¿æŠ“å¾—åˆ° ebtables é‚£ä¸€è¡Œ
            #    å¦‚æœ Makefile è£¡æ²’æœ‰ arptablesï¼Œå°±æ’åœ¨ ebtables å¾Œé¢
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                sed -i '/dir_y.*+=.*ebtables/a dir_y += arptables' Makefile
            else
                echo "âš ï¸ Arptables already in Makefile."
            fi

            # 3. [é›™é‡ä¿éšª] å¦‚æœ sed é‚„æ˜¯å¤±æ•—ï¼Œç›´æ¥è¿½åŠ åˆ°æª”æ¡ˆæœ€å¾Œé¢ (ä½†æ˜¯åœ¨ all: ä¹‹å‰)
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                echo "âš ï¸ Sed failed, forcing append..."
                # é€™è£¡æ¯”è¼ƒæš´åŠ›ï¼Œç›´æ¥æ’åœ¨ busybox å¾Œé¢ (busybox è‚¯å®šåœ¨æœ€å‰é¢)
                sed -i '/dir_y.*+=.*busybox/a dir_y += arptables' Makefile
            fi
            
            # 4. [é©—è­‰] å°å‡ºçµæœçµ¦ä½ çœ‹ï¼Œè®“ä½ æ”¾å¿ƒ
            echo "ğŸ” Checking Makefile content for arptables:"
            grep "arptables" Makefile || echo "âŒ ERROR: Arptables install failed!"
          fi
          
          # ========================================
          # 2. æ ¸å¿ƒæ¨¡çµ„æ”¯æ´ (Kernel Config)
          # ========================================
          cd "/opt/rt-n56u"
          # è‡ªå‹•åˆ¤æ–·æ ¸å¿ƒç‰ˆæœ¬è·¯å¾‘
          TARGET_KCONF="trunk/linux-4.4.x/.config"
          [ ! -f "$TARGET_KCONF" ] && TARGET_KCONF="trunk/linux-3.4.x/.config"
          
          if [ -f "$TARGET_KCONF" ]; then
             MODULES="CONFIG_IP_NF_ARPTABLES CONFIG_IP_NF_ARPFILTER CONFIG_IP_NF_ARP_MANGLE CONFIG_NF_LOG_ARP CONFIG_BRIDGE_EBT_ARP CONFIG_BRIDGE_EBT_ARPREPLY"
             for mod in $MODULES; do
                if grep -q "$mod" "$TARGET_KCONF"; then
                   sed -i "s|^.*$mod.*$|$mod=m|" "$TARGET_KCONF"
                else
                   echo "$mod=m" >> "$TARGET_KCONF"
                fi
             done
          fi
          
          echo "::endgroup::"

      - name: â¬‡ï¸-Prepare-Toolchain
        env:
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
          TOOLCHAIN_DIR: /opt/rt-n56u/toolchain-mipsel/toolchain-4.4.x
        run: |
          cd /opt/rt-n56u/toolchain-mipsel
          TOOLCHAIN_TAG_FOR_NAME=$(echo "${{ inputs.toolchain_select }}" | sed 's/ (.*//g' | sed 's/\//-/g')
          echo "TOOLCHAIN_TAG_FOR_NAME=$TOOLCHAIN_TAG_FOR_NAME" >> $GITHUB_ENV
          
          # æ¸…ç†ç’°å¢ƒ
          rm -rf "$TOOLCHAIN_DIR" toolchain-4.4.x
          # å»ºç«‹ä¸€å€‹è‡¨æ™‚è§£å£“å€ï¼Œé¿å…è·¯å¾‘æ··äº‚
          mkdir -p "temp_extract"

          echo "ğŸ”§ Processing: $TOOLCHAIN_CHOICE"

          case "$TOOLCHAIN_CHOICE" in
            "Padavan-NG (GCC 13+, uClibc-ng, ZSTD)")
              URL="https://gitlab.com/api/v4/projects/hadzhioglu%2Fpadavan-ng/packages/generic/toolchain/latest/toolchain.tzst"
              echo "â¬‡ï¸ Downloading Padavan-NG..."
              curl -L "$URL" | tar --zstd -xf - -C "temp_extract"
              ;;
            
            "Default (hanwckf/linux-4.4-v1.0, uclibc)") 
              sh dl_toolchain.sh 
              # Default è…³æœ¬é€šå¸¸æœƒå»ºç«‹æ­£ç¢ºç›®éŒ„ï¼Œä¸éœ€è¦å¾ŒçºŒæ¬ç§»
              rm -rf temp_extract
              exit 0
              ;;
            
            "TurboTse/musl (gcc 13.3.0, musl 1.2.5)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
              
            "tsl0922/musl (gcc 13.2.0, musl 1.2.4)") 
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)") 
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)") 
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
          esac
          
          # === æ™ºæ…§å‹ç›®éŒ„åµæ¸¬èˆ‡æ¬ç§» ===
          echo "ğŸ” Locating toolchain bin directory..."
          # æ‰¾å‡ºå«æœ‰ 'mipsel-linux-gcc' çš„ bin ç›®éŒ„
          BIN_PATH=$(find temp_extract -type f -name "mipsel-linux-gcc" -o -name "mipsel-linux-uclibc-gcc" | head -n 1 | xargs dirname)
          
          if [ -z "$BIN_PATH" ]; then
             echo "::error:: âŒ Critical: Could not find gcc binary in extracted files!"
             ls -R temp_extract
             exit 1
          fi
          
          # BIN_PATH çš„ä¸Šä¸€å±¤å°±æ˜¯æˆ‘å€‘è¦çš„ Toolchain Root
          ACTUAL_ROOT=$(dirname "$BIN_PATH")
          echo "âœ… Found toolchain root at: $ACTUAL_ROOT"
          
          # ç§»å‹•åˆ°ç›®æ¨™ä½ç½®
          mkdir -p "$(dirname "$TOOLCHAIN_DIR")"
          mv "$ACTUAL_ROOT" "$TOOLCHAIN_DIR"
          rm -rf temp_extract
          
          # === ä¿®æ­£åŸ·è¡Œæª”åç¨± (å»ºç«‹ Symlink) ===
          # è¨±å¤šè…³æœ¬å¯«æ­»å‘¼å« mipsel-linux-gccï¼Œä½†æ–° Toolchain åªæœ‰ mipsel-linux-uclibc-gcc
          cd "$TOOLCHAIN_DIR/bin"
          if [ ! -f "mipsel-linux-gcc" ] && [ -f "mipsel-linux-uclibc-gcc" ]; then
             echo "ğŸ”§ Creating symlinks for compatibility..."
             ln -sf mipsel-linux-uclibc-gcc mipsel-linux-gcc
             ln -sf mipsel-linux-uclibc-g++ mipsel-linux-g++
             ln -sf mipsel-linux-uclibc-ld mipsel-linux-ld
             ln -sf mipsel-linux-uclibc-ar mipsel-linux-ar
             ln -sf mipsel-linux-uclibc-strip mipsel-linux-strip
          fi
          
          ls -lh "$TOOLCHAIN_DIR/bin" | head -n 5
          
          # å»ºç«‹ç³»çµ±é€£çµ
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s "$TOOLCHAIN_DIR" /toolchain-4.4.x

      - name: ğŸ“-CORE-Modify-Template-and-Sync-Config
        env:
          RAW_TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
        run: |
          TEMPLATE_DIR="/opt/rt-n56u/trunk/configs/templates"
          TRUNK_CONFIG="/opt/rt-n56u/trunk/.config"
          
          PATTERN_A=$(echo "$RAW_TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$RAW_TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 1 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ] || [ ! -f "$TARGET_FILE" ]; then
             echo "::error:: âŒ æ‰¾ä¸åˆ°è¨­å®šæª”ï¼" && exit 1
          fi
          
          REAL_MODEL=$(basename "$TARGET_FILE" .config)
          echo "REAL_MODEL=$REAL_MODEL" >> $GITHUB_ENV

          # æ¥µé™ç˜¦èº«é‚è¼¯
          if [ "$NANO_OPT" = "true" ] || [[ "$REAL_MODEL" =~ "nano" ]]; then
            modules=(
              UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS \
              NTFS_3G LPRD U2EC HDPARM PARTED SMBD WINS SMBD_SYSLOG \
              FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN \
              SSWAN XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION \
              TRANSMISSION_WEB_CONTROL ARIA ARIA_WEB_CONTROL SCUTCLIENT \
              GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER \
              SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE \
              LRZSZ IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY \
              MENTOHUST FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY \
              TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER \
              SMARTDNS ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER \
              SQM WIREGUARD
            )
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" "$TARGET_FILE"
            done
          fi

          # æ ¸å¿ƒä¿ç•™æ¨¡çµ„
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SFE QOS)
          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$TARGET_FILE"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$TARGET_FILE"
          done
          
          # 3. ã€çµ‚æ¥µå®‰å…¨ç‰ˆã€‘é‡å° GCC 13+ çš„ç·¨è­¯æœ€ä½³åŒ–
          # ä¸ä¿®æ”¹ä»»ä½•æ ¸å¿ƒä»£ç¢¼ï¼Œåƒ…é€éåƒæ•¸æŠ‘åˆ¶å ±éŒ¯ï¼Œç¢ºä¿é‚è¼¯çµ•å°å®‰å…¨ï¼
          if [[ "$TOOLCHAIN_CHOICE" == *"Padavan-NG"* ]] || [[ "$TOOLCHAIN_CHOICE" == *"TurboTse"* ]]; then
             echo "ğŸ”§ GCC 13+ detected. Applying SAFE compiler flags..."
             
             # çµ„åˆå®‰å…¨åƒæ•¸ï¼š
             # -std=gnu99: ä½¿ç”¨èˆŠç‰ˆ C æ¨™æº–
             # -Wno-error=...: å°‡ç‰¹å®šçš„éŒ¯èª¤é™ç´šç‚ºè­¦å‘Šï¼Œä¸ä¸­æ–·ç·¨è­¯
             # array-bounds: è§£æ±º traps.c çš„ -1 å ±éŒ¯
             # stringop-overflow: è§£æ±º Realtek é©…å‹•å ±éŒ¯
             # maybe-uninitialized: è§£æ±ºè®Šæ•¸åˆå§‹åŒ–èª¤åˆ¤
             SAFE_FLAGS="-std=gnu99 -Wno-error=array-bounds -Wno-array-bounds -Wno-error=stringop-overflow -Wno-error=maybe-uninitialized -Wno-error=implicit-function-declaration -Wno-error=int-conversion"
             
             echo "CONFIG_FIRMWARE_CFLAGS=\"$SAFE_FLAGS\"" >> "$TARGET_FILE"
             
             echo "âœ… Safe flags injected. Kernel source remains UNTOUCHED."
          fi
          
          cp -f "$TARGET_FILE" "$TRUNK_CONFIG"

      - name: ğŸ”¨-Build-Host-Tools
        run: |
          cd /opt/rt-n56u/trunk
          [ -f "tools/mkimage/mkimage.c" ] && sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
          make tools

      - name: ğŸ“-Apply-Custom-Settings
        run: |
          cd /opt/rt-n56u
          chmod +x trunk/custom/scripts/*.sh
          bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict
          bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/defaults.h
          bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/defaults.h

      - name: ğŸ—ï¸-Build-Firmware
        run: |
          cd /opt/rt-n56u/trunk
          sudo ./clear_tree
          # ä¿®æ”¹é‡é»ï¼š
          # 1. 2>&1 : æŠŠéŒ¯èª¤è¨Šæ¯ (stderr) ä¹Ÿå°å‘åˆ°æ¨™æº–è¼¸å‡ºï¼Œé€™æ¨£å ±éŒ¯ä¹Ÿæœƒè¢«è¨˜éŒ„ã€‚
          # 2. | tee build.log : åƒ T å‹æ°´ç®¡ä¸€æ¨£ï¼Œä¸€é‚Šæµå‘è¢å¹•(çµ¦ä½ çœ‹)ï¼Œä¸€é‚Šæµå‘æª”æ¡ˆ(å­˜æª”)ã€‚
          sudo ./build_firmware_modify "${{ env.REAL_MODEL }}" 0 2>&1 | tee build.log
          
          # æª¢æŸ¥ä¸€ä¸‹æ˜¯å¦çœŸçš„ç”¢ç”Ÿäº† (é™¤éŒ¯ç”¨)
          ls -lh build.log
          
          FINAL_FILENAME="${{ env.REAL_MODEL }}-${{ env.TOOLCHAIN_TAG_FOR_NAME }}-${{ env.BUILD_TIME }}.trx"
          FOUND_FILE=$(find images -name "*.trx" | head -n 1)
          if [ -z "$FOUND_FILE" ]; then echo "::error::æœªç”¢å‡º TRX æª”æ¡ˆ"; exit 1; fi
          sudo mv -f "$FOUND_FILE" "/opt/images/$FINAL_FILENAME"
          echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV

      # =======================================================
      # [ä¿®æ”¹] æ™ºæ…§æ‰“åŒ… (Debugè¿½è¹¤ + ç”¢ç‰©æ”¶é›†)
      # =======================================================
      - name: ğŸ“¦-Smart-Pack-Artifacts-Debug
        run: |
          echo "::group::Smart Packing & Debug Collection"
          
          # å®šç¾©è·¯å¾‘ (é©é… /opt/rt-n56u)
          WORK_DIR="/opt/rt-n56u"
          PACK_DIR="/opt/images/output_pack"
          IMAGES_DIR="/opt/images"
          
          mkdir -p "$PACK_DIR"
          
          # 1. æ”¶é›†é—œéµé…ç½®èˆ‡æ—¥èªŒ
          echo "Collecting Configs and Logs..."
          [ -f "$WORK_DIR/trunk/.config" ] && cp "$WORK_DIR/trunk/.config" "$PACK_DIR/build.config"
          [ -f "$WORK_DIR/trunk/user/shared/defaults.h" ] && cp "$WORK_DIR/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "$WORK_DIR/trunk/linux-4.4.x/.config" ] && cp "$WORK_DIR/trunk/linux-4.4.x/.config" "$PACK_DIR/kernel.config"
          # é€™è£¡è·¯å¾‘è¦å°æ‡‰ä¸Šé¢ç”¢ç”Ÿçš„ä½ç½®
          # å› ç‚ºä¸Šé¢æ˜¯åœ¨ trunk è³‡æ–™å¤¾ä¸‹ç”¢ç”Ÿçš„ build.log
          if [ -f "$WORK_DIR/trunk/build.log" ]; then
              echo "âœ… Found build.log, copying..."
              cp "$WORK_DIR/trunk/build.log" "$PACK_DIR/build.log"
          else
              echo "âš ï¸ Warning: build.log not found in trunk/"
          fi

          # =======================================================
          # ğŸ”¥ 2. å¼·åŒ–ï¼šæ”¶é›† iptables ç›¸é—œç”¢ç‰© (æ™ºæ…§é©—è­‰ç‰ˆ)
          # =======================================================
          # å®šç¾© Padavan 4.4 çš„ iptables è·¯å¾‘
          IPT_SRC_DIR="$WORK_DIR/trunk/user/iptables/iptables-1.8.7"
          PATCH_ARCHIVE_DIR="$IPT_SRC_DIR/patches_archive"
          DEBUG_DIR="$PACK_DIR/debug_iptables"
          
          mkdir -p "$DEBUG_DIR"
          
          # 2.1 æ”¶é›† Patch æª”æ¡ˆ
          if [ -d "$PATCH_ARCHIVE_DIR" ]; then
              cp "$PATCH_ARCHIVE_DIR"/*.patch "$DEBUG_DIR/"
              echo "âœ… All patches collected in debug_iptables"
          else
              echo "âš ï¸ Warning: Patches archive directory not found!"
          fi
          
          # 2.2 æ”¶é›† Patch éç¨‹æ—¥èªŒ
          if [ -f "$IPT_SRC_DIR/patch_summary.log" ]; then
              cp "$IPT_SRC_DIR/patch_summary.log" "$DEBUG_DIR/patch_summary.log"
              echo "âœ… patch_summary.log collected"
          fi

          # 2.3 æ™ºæ…§è¤‡è£½ xtables.c (æ ¹æ“šå…§å®¹æ±ºå®šæª”å)
          TARGET_FILE="$IPT_SRC_DIR/libxtables/xtables.c"
          
          if [ -f "$TARGET_FILE" ]; then
              # æª¢æŸ¥æ˜¯å¦å«æœ‰æˆ‘å€‘ Patch #100 çš„ç‰¹å¾µç¢¼ (å±è”½è­¦å‘Šçš„ if 0)
              if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
                  # åˆ¤å®šç‚ºå·² Patch
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_patched.c"
                  echo "âœ… Detected PATCHED xtables.c - Saving as xtables_patched.c"
              else
                  # åˆ¤å®šç‚ºæœª Patch (åŸç‰ˆæˆ– Patch å¤±æ•—)
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_original.c"
                  echo "â„¹ï¸ Detected UNPATCHED xtables.c - Saving as xtables_original.c"
              fi
          else
               echo "âš ï¸ Warning: xtables.c not found (Maybe build failed or path differs)"
          fi
          
          # 2.4 é¡å¤–æ”¶é›† config.log
          if [ -f "$IPT_SRC_DIR/config.log" ]; then
              cp "$IPT_SRC_DIR/config.log" "$DEBUG_DIR/config.log"
              echo "âœ… config.log collected"
          fi
          # =======================================================

          # 3. ç§»å‹•éŸŒé«”æª”æ¡ˆåˆ°æ‰“åŒ…ç›®éŒ„
          if [ -f "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" ]; then
             cp "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" "$PACK_DIR/"
          else
             echo "::warning:: Firmware file not found in images dir!"
          fi

          # 4. ç”¢ç”Ÿ MD5
          cd "$PACK_DIR"
          md5sum * > md5sum.txt 2>/dev/null || true
          
          # 5. æ‰“åŒ… Zip
          cd "/opt/images"
          ZIP_NAME="Padavan-${{ env.REAL_MODEL }}-${{ env.BUILD_TIME }}.zip"
          zip -j -r "$ZIP_NAME" "$PACK_DIR"
          
          # è¨­å®šç’°å¢ƒè®Šæ•¸ä¾› Upload èˆ‡ Release ä½¿ç”¨
          echo "FINAL_ZIP_PATH=/opt/images/$ZIP_NAME" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: ğŸ“¦-Upload-Artifacts
        uses: actions/upload-artifact@master
        with:
          name: ${{ inputs.target_select }}-${{ env.BUILD_TIME }}
          path: ${{ env.FINAL_ZIP_PATH }}

      - name: ğŸ·ï¸-Set-Release-Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=build-${{ inputs.target_select }}-${{ env.BUILD_TIME }}" >> $GITHUB_ENV

      - name: ğŸš€-Publish-Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: Build ${{ inputs.target_select }} (${{ env.BUILD_TIME }})
          body: |
            **Padavan ç·¨è­¯å ±å‘Š (Enhanced)**
            * æ©Ÿå‹: ${{ inputs.target_select }}
            * æ™‚é–“: ${{ env.BUILD_TIME }}
            * LAN IP: ${{ env.LANIP }}
            * å·¥å…·éˆ: ${{ inputs.toolchain_select }}
            
            ### åŒ…å«å…§å®¹
            * éŸŒé«”æª”æ¡ˆ (.trx)
            * ç³»çµ±é…ç½® (build.config, kernel.config)
            * Debug è³‡è¨Š (defaults.h, iptables patch check)
          artifacts: ${{ env.FINAL_ZIP_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
