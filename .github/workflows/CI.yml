name: Custom-Router-Build-Final-Fix

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "é¸æ“‡æ©Ÿå‹ (æ”¯æ´ K2P, K2P-NANO, K2P-USB ç­‰)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
          - MI-R3G
          - NEWIFI3
          - RM2100
        default: K2P

      nanoversion:
        description: "æ˜¯å¦åŸ·è¡Œæ¥µé™ç˜¦èº«"
        type: boolean
        default: true
      
      customization:
        description: 'è‡ªå®šç¾©é…ç½® JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'
      
      toolchain_select:
        description: "é¸æ“‡ç·¨è­¯å·¥å…·éˆ"
        required: true
        type: choice
        options:
          - Default (hanwckf/linux-4.4-v1.0, uclibc)
          - Padavan-NG (GCC 13+, uClibc-ng, ZSTD)
          - TurboTse/musl (gcc 13.3.0, musl 1.2.5)
          - TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)
          - tsl0922/musl (gcc 13.2.0, musl 1.2.4)
          - tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)
          - hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)
        default: Default (hanwckf/linux-4.4-v1.0, uclibc)

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: ğŸ“¥-Checkout-Repository
        uses: actions/checkout@master
      
      - name: ğŸš€-Install-Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git zstd \
            build-essential fakeroot flex bison gawk gperf \
            autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq
          # è¨­å®šå°ç£æ™‚é–“ YYYYMMDD-HHMM
          echo "BUILD_TIME=$(TZ='Asia/Taipei' date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir -p /opt/images/

      - name: ğŸ”-Export-Custom-Variables
        run: |
          jq empty <<< '${{ inputs.customization }}' || { echo "âŒ Invalid JSON"; exit 1; }
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            echo "${k^^}=$v" >> $GITHUB_ENV  
          done

      - name: â¬‡ï¸-Clone-Source-Code
        run: |
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-4.4.git /opt/rt-n56u

      # =======================================================
      # [å®Œå…¨æ¬é‹ç‰ˆ] ç›´æ¥å¾ Repo ä¸‹è¼‰ libmnl è¦†è“‹
      # =======================================================
      - name: ğŸ”¥ Sync libmnl from padavan-ng repo
        run: |
          echo "::group::Direct Sync libmnl"
          
          # 1. é€²å…¥ libs ç›®éŒ„ä¸¦ç§»é™¤èˆŠçš„ libmnl
          cd /opt/rt-n56u/trunk/libs
          rm -rf libmnl
          
          # 2. é€éè‡¨æ™‚ç›®éŒ„ Clone è©² Repo (åªæŠ“ master åˆ†æ”¯)
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-ng.git /tmp/padavan-ng
          
          # 3. æŠŠè©² Repo è£¡çš„ libmnl å®Œæ•´æ‹·è²éä¾†
          cp -rf /tmp/padavan-ng/trunk/libs/libmnl ./libmnl
          
          # 4. æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
          rm -rf /tmp/padavan-ng
          
          # 5. æª¢æŸ¥ç¢ºèªæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "./libmnl/Makefile" ]; then
            echo "âœ… libmnl æ¬é‹æˆåŠŸï¼ä½¿ç”¨ padavan-ng åŸå§‹è…³æœ¬ã€‚"
            ls -al ./libmnl
          else
            echo "::error::âŒ æ¬é‹å¤±æ•—ï¼æ‰¾ä¸åˆ° Makefile"
            exit 1
          fi
          
          echo "::endgroup::"

      # =======================================================
      # [å®Œå…¨æ¬é‹ç‰ˆ] iptables 1.8.10 (Sync from padavan-ng)
      # =======================================================
      - name: ğŸ”¥ Sync iptables from padavan-ng
        run: |
          echo "::group::Sync Iptables 1.8.10"
          
          # å®šç¾©ç›®æ¨™è·¯å¾‘
          IPT_ROOT="/opt/rt-n56u/trunk/user/iptables"
          
          # 1. æ¸…ç†èˆŠç›®éŒ„ (åŸæœ¬æ˜¯ 1.8.7)
          echo "ğŸ—‘ï¸ Removing old iptables directory..."
          rm -rf "$IPT_ROOT"
          
          # 2. é€éè‡¨æ™‚ç›®éŒ„ Clone padavan-ng
          # é€™è£¡æˆ‘å€‘åˆ©ç”¨ Github çš„ repo ä¾†ç²å–æœ€æ–°çš„ Makefile é…ç½®
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-ng.git /tmp/padavan-ng
          
          # 3. æ¬é‹ iptables ç›®éŒ„
          echo "ğŸšš Syncing iptables folder..."
          if [ -d "/tmp/padavan-ng/trunk/user/iptables" ]; then
              cp -rf /tmp/padavan-ng/trunk/user/iptables "$IPT_ROOT"
              echo "âœ… æˆåŠŸå¾ padavan-ng åŒæ­¥ iptables ç›®éŒ„"
          else
              echo "âŒ Error: ä¾†æº Repo ä¸­æ‰¾ä¸åˆ° iptables ç›®éŒ„"
              exit 1
          fi
          
          # 4. æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
          rm -rf /tmp/padavan-ng
          
          # 5. é€²å…¥ç›®éŒ„æº–å‚™ç·¨è­¯ç’°å¢ƒ
          cd "$IPT_ROOT"
          
          # é©—è­‰ Makefile æ˜¯å¦æ­£ç¢º (ç¢ºèªæ˜¯å¦ç‚º 1.8.10)
          if grep -q "SRC_NAME=iptables-1.8.10" Makefile; then
              echo "âœ… ç‰ˆæœ¬ç¢ºèª: 1.8.10 (Makefile é©—è­‰é€šé)"
              
              # [é—œéµæ­¥é©Ÿ] åŸ·è¡Œ Makefile å…§çš„ä¸‹è¼‰èˆ‡è§£å£“è¦å‰‡
              # ä¾æ“šä½ æä¾›çš„ Makefileï¼Œ'all' ç›®æ¨™æ²’æœ‰åŒ…å« download/extract
              # æ‰€ä»¥æˆ‘å€‘å¿…é ˆæ‰‹å‹•åŸ·è¡Œé€™å…©å€‹ targetï¼Œå¦å‰‡å¾ŒçºŒç·¨è­¯æœƒæ‰¾ä¸åˆ°åŸå§‹ç¢¼
              
              echo "â¬‡ï¸ Running make download_test..."
              make download_test || { echo "âŒ Download failed"; exit 1; }
              
              echo "ğŸ“¦ Running make extract_test..."
              make extract_test || { echo "âŒ Extract failed"; exit 1; }
              
              # å†æ¬¡ç¢ºèªè§£å£“çµæœ
              if [ -d "iptables-1.8.10" ]; then
                  echo "âœ… æºç¢¼å·²å°±ç·’ (iptables-1.8.10)"
              else
                  echo "âŒ æºç¢¼è§£å£“å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Makefile è¨­å®š"
                  exit 1
              fi
          else
              echo "âš ï¸ è­¦å‘Šï¼šåŒæ­¥éä¾†çš„ Makefile ç‰ˆæœ¬ä¼¼ä¹ä¸æ˜¯ 1.8.10ï¼Œè«‹æª¢æŸ¥ï¼"
              cat Makefile | grep SRC_NAME
          fi

          # =======================================================
          # [æ’å…¥é»] æ‡‰ç”¨å±è”½è­¦å‘Šè£œä¸ (Smart Patching)
          # =======================================================
          echo "ğŸ”§ Generating warning suppression patch..."
          
          cat << 'EOF' > 999-suppress-warnings.patch
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          EOF

          echo "ğŸ©¹ Applying patch..."
          # é€™è£¡æˆ‘å€‘å…è¨± patch å¤±æ•— (å»æ‰ || exit 1)ï¼Œå› ç‚ºå¦‚æœå·²ç¶“ Patch éäº†ï¼Œå®ƒæœƒå¤±æ•—
          patch -d iptables-1.8.10 -p1 < 999-suppress-warnings.patch || echo "âš ï¸ Patch return error (Might be already applied), proceeding to verification..."
          
          echo "ğŸ” verifying code content..."
          TARGET_FILE="iptables-1.8.10/libxtables/xtables.c"
          
          # [é—œéµé©—è­‰é‚è¼¯]
          # ç›´æ¥ grep é¡¯ç¤ºåŒ…å« Warning çš„é‚£å¹¾è¡Œï¼Œä¸¦æª¢æŸ¥æ˜¯å¦æœ‰ #if 0
          # -n é¡¯ç¤ºè¡Œè™Ÿ, -C 3 é¡¯ç¤ºä¸Šä¸‹ä¸‰è¡Œä¸Šä¸‹æ–‡
          if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
              echo "âœ… Verification Passed: Code is correctly patched!"
              echo "ğŸ‘‡ Current Code Snippet in $TARGET_FILE:"
              grep -nC 3 "Warning: Extension %s is not supported" "$TARGET_FILE"
          else
              echo "âŒ Verification Failed: Code is NOT patched properly!"
              echo "ğŸ‘‡ Current Code Snippet (BAD):"
              grep -nC 3 "Warning: Extension %s is not supported" "$TARGET_FILE"
              exit 1
          fi
          
          # =======================================================

          # 6. å…¨å±€ä¾è³´ä¿®å¾© (Part 2)
          # å› ç‚ºæˆ‘å€‘æŠŠç‰ˆæœ¬å¾ 1.8.7 æ›æˆäº† 1.8.10ï¼Œå¿…é ˆä¿®å¾©å…¶ä»–å¥—ä»¶çš„å¼•ç”¨è·¯å¾‘
          echo "ğŸ” ä¿®å¾©ä¾è³´èˆŠç‰ˆ (1.8.7) çš„å…¶ä»–çµ„ä»¶..."
          grep -rl "iptables-1.8.7" /opt/rt-n56u/trunk/user/ | while read -r file ; do
              echo "  - Patching dependency in: $file"
              sed -i "s/iptables-1.8.7/iptables-1.8.10/g" "$file"
          done
          
          echo "ğŸ‰ Iptables åŒæ­¥èˆ‡ç’°å¢ƒä¿®å¾©å®Œæˆï¼"
          echo "::endgroup::"

      # =======================================================
      # [æ–°å¢] ç¶²è·¯å·¥å…·å‡ç´š v31 (è·¯å¾‘é©é… /opt/rt-n56u)
      # =======================================================
      - name: ğŸ”¥ Network Tools (Smart Compile & Robust Kernel Config)
        run: |
          echo "::group::Smart Compile Network Tools"
          
          # === è¨­å®šè·¯å¾‘ (é©é…æ­¤ workflow) ===
          BASE_DIR="/opt/rt-n56u/trunk/user"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. Arptables (ä¿®å¾© Tab åŒ¹é…å•é¡Œ + ç¢ºä¿åå–®æœ‰å®ƒ)
          # ========================================
          echo "â¬‡ï¸ Processing Arptables..."
          
          # [æ­¥é©Ÿ A] ç¢ºä¿ Userland Config é–‹å•Ÿ
          USER_CONFIG="/opt/rt-n56u/trunk/.config"
          if [ -f "$USER_CONFIG" ]; then
              echo "ğŸ”§ Enabling CONFIG_USER_ARPTABLES in Userland .config..."
              sed -i 's/^CONFIG_USER_ARPTABLES=.*/CONFIG_USER_ARPTABLES=y/' "$USER_CONFIG"
              if ! grep -q "CONFIG_USER_ARPTABLES=y" "$USER_CONFIG"; then
                  echo "CONFIG_USER_ARPTABLES=y" >> "$USER_CONFIG"
              fi
          fi

          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          # ä¸‹è¼‰æºç¢¼
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            wget --no-check-certificate "https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz" -O src.tar.gz
            tar -xf src.tar.gz && rm -f src.tar.gz
            
            ARP_SRC_NAME=$(ls -d arptables-0*/ | head -n 1 | sed 's/\///')
            chmod -R u+w "$ARP_SRC_NAME"
            
            echo "ğŸ”§ Creating Arptables Wrapper Makefile..."
            
            # [æ­¥é©Ÿ B] Wrapper
            cat << EOF > Makefile
          SRC_NAME=$ARP_SRC_NAME
          all:
          	\$(MAKE) -C \$(SRC_NAME) \
          		CC="\$(CC)" \
          		KERNEL_DIR=\$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		all
          	@if [ -f \$(SRC_NAME)/arptables ] && [ ! -f \$(SRC_NAME)/arptables-legacy ]; then \
          		cp \$(SRC_NAME)/arptables \$(SRC_NAME)/arptables-legacy; \
          	fi
          romfs:
          	\$(ROMFSINST) \$(SRC_NAME)/arptables-legacy /bin/arptables
          clean:
          	\$(MAKE) -C \$(SRC_NAME) clean
          	rm -f \$(SRC_NAME)/arptables-legacy
          EOF
          
            # [æ­¥é©Ÿ C] è¨»å†Šç›®éŒ„ (é‡å° Tab å„ªåŒ–)
            echo "ğŸ”§ Registering arptables in trunk/user/Makefile..."
            cd "$BASE_DIR" || exit 1
            
            # 1. å…ˆå‚™ä»½ä¸€ä¸‹
            cp Makefile Makefile.bak
            
            # 2. ä½¿ç”¨ .* ä¾†å¿½ç•¥ç©ºæ ¼æˆ– Tab çš„å·®ç•°ï¼Œç¢ºä¿æŠ“å¾—åˆ° ebtables é‚£ä¸€è¡Œ
            #    å¦‚æœ Makefile è£¡æ²’æœ‰ arptablesï¼Œå°±æ’åœ¨ ebtables å¾Œé¢
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                sed -i '/dir_y.*+=.*ebtables/a dir_y += arptables' Makefile
            else
                echo "âš ï¸ Arptables already in Makefile."
            fi

            # 3. [é›™é‡ä¿éšª] å¦‚æœ sed é‚„æ˜¯å¤±æ•—ï¼Œç›´æ¥è¿½åŠ åˆ°æª”æ¡ˆæœ€å¾Œé¢ (ä½†æ˜¯åœ¨ all: ä¹‹å‰)
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                echo "âš ï¸ Sed failed, forcing append..."
                # é€™è£¡æ¯”è¼ƒæš´åŠ›ï¼Œç›´æ¥æ’åœ¨ busybox å¾Œé¢ (busybox è‚¯å®šåœ¨æœ€å‰é¢)
                sed -i '/dir_y.*+=.*busybox/a dir_y += arptables' Makefile
            fi
            
            # 4. [é©—è­‰] å°å‡ºçµæœçµ¦ä½ çœ‹ï¼Œè®“ä½ æ”¾å¿ƒ
            echo "ğŸ” Checking Makefile content for arptables:"
            grep "arptables" Makefile || echo "âŒ ERROR: Arptables install failed!"
          fi
          
          # ========================================
          # 2. æ ¸å¿ƒæ¨¡çµ„æ”¯æ´ (Kernel Config)
          # ========================================
          cd "/opt/rt-n56u"
          # è‡ªå‹•åˆ¤æ–·æ ¸å¿ƒç‰ˆæœ¬è·¯å¾‘
          TARGET_KCONF="trunk/linux-4.4.x/.config"
          [ ! -f "$TARGET_KCONF" ] && TARGET_KCONF="trunk/linux-3.4.x/.config"
          
          if [ -f "$TARGET_KCONF" ]; then
             MODULES="CONFIG_IP_NF_ARPTABLES CONFIG_IP_NF_ARPFILTER CONFIG_IP_NF_ARP_MANGLE CONFIG_NF_LOG_ARP CONFIG_BRIDGE_EBT_ARP CONFIG_BRIDGE_EBT_ARPREPLY"
             for mod in $MODULES; do
                if grep -q "$mod" "$TARGET_KCONF"; then
                   sed -i "s|^.*$mod.*$|$mod=m|" "$TARGET_KCONF"
                else
                   echo "$mod=m" >> "$TARGET_KCONF"
                fi
             done
          fi
          
          echo "::endgroup::"

      - name: â¬‡ï¸-Prepare-Toolchain
        env:
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
          TOOLCHAIN_DIR: /opt/rt-n56u/toolchain-mipsel/toolchain-4.4.x
        run: |
          cd /opt/rt-n56u/toolchain-mipsel
          TOOLCHAIN_TAG_FOR_NAME=$(echo "${{ inputs.toolchain_select }}" | sed 's/ (.*//g' | sed 's/\//-/g')
          echo "TOOLCHAIN_TAG_FOR_NAME=$TOOLCHAIN_TAG_FOR_NAME" >> $GITHUB_ENV
          
          # æ¸…ç†ç’°å¢ƒ
          rm -rf "$TOOLCHAIN_DIR" toolchain-4.4.x
          # å»ºç«‹ä¸€å€‹è‡¨æ™‚è§£å£“å€ï¼Œé¿å…è·¯å¾‘æ··äº‚
          mkdir -p "temp_extract"

          echo "ğŸ”§ Processing: $TOOLCHAIN_CHOICE"

          case "$TOOLCHAIN_CHOICE" in
            "Padavan-NG (GCC 13+, uClibc-ng, ZSTD)")
              URL="https://gitlab.com/api/v4/projects/hadzhioglu%2Fpadavan-ng/packages/generic/toolchain/latest/toolchain.tzst"
              echo "â¬‡ï¸ Downloading Padavan-NG..."
              curl -L "$URL" | tar --zstd -xf - -C "temp_extract"
              ;;
            
            "Default (hanwckf/linux-4.4-v1.0, uclibc)") 
              sh dl_toolchain.sh 
              # Default è…³æœ¬é€šå¸¸æœƒå»ºç«‹æ­£ç¢ºç›®éŒ„ï¼Œä¸éœ€è¦å¾ŒçºŒæ¬ç§»
              rm -rf temp_extract
              exit 0
              ;;
            
            "TurboTse/musl (gcc 13.3.0, musl 1.2.5)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
              
            # ... å…¶ä»– tsl/hanwckf é¸é …é‚è¼¯åŒä¸Šï¼Œçš†è§£å£“è‡³ temp_extract ...
            *)
              # é è¨­è™•ç†
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz"
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
          esac
          
          # === æ™ºæ…§å‹ç›®éŒ„åµæ¸¬èˆ‡æ¬ç§» ===
          echo "ğŸ” Locating toolchain bin directory..."
          # æ‰¾å‡ºå«æœ‰ 'mipsel-linux-gcc' çš„ bin ç›®éŒ„
          BIN_PATH=$(find temp_extract -type f -name "mipsel-linux-gcc" -o -name "mipsel-linux-uclibc-gcc" | head -n 1 | xargs dirname)
          
          if [ -z "$BIN_PATH" ]; then
             echo "::error:: âŒ Critical: Could not find gcc binary in extracted files!"
             ls -R temp_extract
             exit 1
          fi
          
          # BIN_PATH çš„ä¸Šä¸€å±¤å°±æ˜¯æˆ‘å€‘è¦çš„ Toolchain Root
          ACTUAL_ROOT=$(dirname "$BIN_PATH")
          echo "âœ… Found toolchain root at: $ACTUAL_ROOT"
          
          # ç§»å‹•åˆ°ç›®æ¨™ä½ç½®
          mkdir -p "$(dirname "$TOOLCHAIN_DIR")"
          mv "$ACTUAL_ROOT" "$TOOLCHAIN_DIR"
          rm -rf temp_extract
          
          # === ä¿®æ­£åŸ·è¡Œæª”åç¨± (å»ºç«‹ Symlink) ===
          # è¨±å¤šè…³æœ¬å¯«æ­»å‘¼å« mipsel-linux-gccï¼Œä½†æ–° Toolchain åªæœ‰ mipsel-linux-uclibc-gcc
          cd "$TOOLCHAIN_DIR/bin"
          if [ ! -f "mipsel-linux-gcc" ] && [ -f "mipsel-linux-uclibc-gcc" ]; then
             echo "ğŸ”§ Creating symlinks for compatibility..."
             ln -sf mipsel-linux-uclibc-gcc mipsel-linux-gcc
             ln -sf mipsel-linux-uclibc-g++ mipsel-linux-g++
             ln -sf mipsel-linux-uclibc-ld mipsel-linux-ld
             ln -sf mipsel-linux-uclibc-ar mipsel-linux-ar
             ln -sf mipsel-linux-uclibc-strip mipsel-linux-strip
          fi
          
          ls -lh "$TOOLCHAIN_DIR/bin" | head -n 5
          
          # å»ºç«‹ç³»çµ±é€£çµ
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s "$TOOLCHAIN_DIR" /toolchain-4.4.x

      - name: ğŸ“-CORE-Modify-Template-and-Sync-Config
        env:
          RAW_TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
        run: |
          TEMPLATE_DIR="/opt/rt-n56u/trunk/configs/templates"
          TRUNK_CONFIG="/opt/rt-n56u/trunk/.config"
          
          PATTERN_A=$(echo "$RAW_TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$RAW_TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 1 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ] || [ ! -f "$TARGET_FILE" ]; then
             echo "::error:: âŒ æ‰¾ä¸åˆ°è¨­å®šæª”ï¼" && exit 1
          fi
          
          REAL_MODEL=$(basename "$TARGET_FILE" .config)
          echo "REAL_MODEL=$REAL_MODEL" >> $GITHUB_ENV

          # æ¥µé™ç˜¦èº«é‚è¼¯
          if [ "$NANO_OPT" = "true" ] || [[ "$REAL_MODEL" =~ "nano" ]]; then
            modules=(
              UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS \
              NTFS_3G LPRD U2EC HDPARM PARTED SMBD WINS SMBD_SYSLOG \
              FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN \
              SSWAN XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION \
              TRANSMISSION_WEB_CONTROL ARIA ARIA_WEB_CONTROL SCUTCLIENT \
              GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER \
              SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE \
              LRZSZ IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY \
              MENTOHUST FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY \
              TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER \
              SMARTDNS ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER \
              SQM WIREGUARD
            )
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" "$TARGET_FILE"
            done
          fi

          # æ ¸å¿ƒä¿ç•™æ¨¡çµ„
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SFE QOS)
          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$TARGET_FILE"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$TARGET_FILE"
          done
          
          # 3. ã€çµ‚æ¥µå®‰å…¨ç‰ˆã€‘é‡å° GCC 13+ çš„ç·¨è­¯å„ªåŒ–
          # ä¸ä¿®æ”¹ä»»ä½•æ ¸å¿ƒä»£ç¢¼ï¼Œåƒ…é€éåƒæ•¸æŠ‘åˆ¶å ±éŒ¯ï¼Œç¢ºä¿é‚è¼¯çµ•å°å®‰å…¨ï¼
          if [[ "$TOOLCHAIN_CHOICE" == *"Padavan-NG"* ]] || [[ "$TOOLCHAIN_CHOICE" == *"TurboTse"* ]]; then
             echo "ğŸ”§ GCC 13+ detected. Applying SAFE compiler flags..."
             
             # çµ„åˆå®‰å…¨åƒæ•¸ï¼š
             # -std=gnu99: ä½¿ç”¨èˆŠç‰ˆ C æ¨™æº–
             # -Wno-error=...: å°‡ç‰¹å®šçš„éŒ¯èª¤é™ç´šç‚ºè­¦å‘Šï¼Œä¸ä¸­æ–·ç·¨è­¯
             # array-bounds: è§£æ±º traps.c çš„ -1 å ±éŒ¯
             # stringop-overflow: è§£æ±º Realtek é©…å‹•å ±éŒ¯
             # maybe-uninitialized: è§£æ±ºè®Šæ•¸åˆå§‹åŒ–èª¤åˆ¤
             SAFE_FLAGS="-std=gnu99 -Wno-error=array-bounds -Wno-array-bounds -Wno-error=stringop-overflow -Wno-error=maybe-uninitialized -Wno-error=implicit-function-declaration -Wno-error=int-conversion"
             
             echo "CONFIG_FIRMWARE_CFLAGS=\"$SAFE_FLAGS\"" >> "$TARGET_FILE"
             
             echo "âœ… Safe flags injected. Kernel source remains UNTOUCHED."
          fi
          
          cp -f "$TARGET_FILE" "$TRUNK_CONFIG"

      - name: ğŸ”¨-Build-Host-Tools
        run: |
          cd /opt/rt-n56u/trunk
          [ -f "tools/mkimage/mkimage.c" ] && sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
          make tools

      - name: ğŸ“-Apply-Custom-Settings
        run: |
          cd /opt/rt-n56u
          chmod +x trunk/custom/scripts/*.sh
          bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict
          bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/defaults.h
          bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/defaults.h

      - name: ğŸ—ï¸-Build-Firmware
        run: |
          cd /opt/rt-n56u/trunk
          sudo ./clear_tree
          # ä¿®æ”¹é‡é»ï¼š
          # 1. 2>&1 : æŠŠéŒ¯èª¤è¨Šæ¯ (stderr) ä¹Ÿå°å‘åˆ°æ¨™æº–è¼¸å‡ºï¼Œé€™æ¨£å ±éŒ¯ä¹Ÿæœƒè¢«è¨˜éŒ„ã€‚
          # 2. | tee build.log : åƒ T å‹æ°´ç®¡ä¸€æ¨£ï¼Œä¸€é‚Šæµå‘è¢å¹•(çµ¦ä½ çœ‹)ï¼Œä¸€é‚Šæµå‘æª”æ¡ˆ(å­˜æª”)ã€‚
          sudo ./build_firmware_modify "${{ env.REAL_MODEL }}" 0 2>&1 | tee build.log
          
          # æª¢æŸ¥ä¸€ä¸‹æ˜¯å¦çœŸçš„ç”¢ç”Ÿäº† (é™¤éŒ¯ç”¨)
          ls -lh build.log
          
          FINAL_FILENAME="${{ env.REAL_MODEL }}-${{ env.TOOLCHAIN_TAG_FOR_NAME }}-${{ env.BUILD_TIME }}.trx"
          FOUND_FILE=$(find images -name "*.trx" | head -n 1)
          if [ -z "$FOUND_FILE" ]; then echo "::error::æœªç”¢å‡º TRX æª”æ¡ˆ"; exit 1; fi
          sudo mv -f "$FOUND_FILE" "/opt/images/$FINAL_FILENAME"
          echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV

      # =======================================================
      # [ä¿®æ”¹] æ™ºæ…§æ‰“åŒ… (Debugè¿½è¹¤ + ç”¢ç‰©æ”¶é›†)
      # =======================================================
      - name: ğŸ“¦-Smart-Pack-Artifacts-Debug
        run: |
          echo "::group::Smart Packing & Debug Collection"
          
          # å®šç¾©è·¯å¾‘ (é©é… /opt/rt-n56u)
          WORK_DIR="/opt/rt-n56u"
          PACK_DIR="/opt/images/output_pack"
          IMAGES_DIR="/opt/images"
          
          mkdir -p "$PACK_DIR"
          
          # 1. æ”¶é›†é—œéµé…ç½®èˆ‡æ—¥èªŒ
          echo "Collecting Configs and Logs..."
          [ -f "$WORK_DIR/trunk/.config" ] && cp "$WORK_DIR/trunk/.config" "$PACK_DIR/build.config"
          [ -f "$WORK_DIR/trunk/user/shared/defaults.h" ] && cp "$WORK_DIR/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "$WORK_DIR/trunk/linux-4.4.x/.config" ] && cp "$WORK_DIR/trunk/linux-4.4.x/.config" "$PACK_DIR/kernel.config"
          # é€™è£¡è·¯å¾‘è¦å°æ‡‰ä¸Šé¢ç”¢ç”Ÿçš„ä½ç½®
          # å› ç‚ºä¸Šé¢æ˜¯åœ¨ trunk è³‡æ–™å¤¾ä¸‹ç”¢ç”Ÿçš„ build.log
          if [ -f "$WORK_DIR/trunk/build.log" ]; then
              echo "âœ… Found build.log, copying..."
              cp "$WORK_DIR/trunk/build.log" "$PACK_DIR/build.log"
          else
              echo "âš ï¸ Warning: build.log not found in trunk/"
          fi

          # 2. æ”¶é›† iptables Debug æª”æ¡ˆ
          mkdir -p "$PACK_DIR/debug_iptables"
          IPT_BASE_DIR="$WORK_DIR/trunk/user/iptables"
          IPT_SRC_DIR="$IPT_BASE_DIR/iptables-1.8.7"
          
          if [ -f "$IPT_BASE_DIR/999-suppress-warnings.patch" ]; then
              cp "$IPT_BASE_DIR/999-suppress-warnings.patch" "$PACK_DIR/debug_iptables/"
          fi
          if [ -f "$IPT_SRC_DIR/libxtables/xtables.c" ]; then
              cp "$IPT_SRC_DIR/libxtables/xtables.c" "$PACK_DIR/debug_iptables/xtables_patched.c"
          fi

          # 3. ç§»å‹•éŸŒé«”æª”æ¡ˆåˆ°æ‰“åŒ…ç›®éŒ„
          if [ -f "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" ]; then
             cp "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" "$PACK_DIR/"
          else
             echo "::warning:: Firmware file not found in images dir!"
          fi

          # 4. ç”Ÿæˆ MD5
          cd "$PACK_DIR"
          md5sum * > md5sum.txt 2>/dev/null || true
          
          # 5. æ‰“åŒ… Zip
          cd "/opt/images"
          ZIP_NAME="Padavan-${{ env.REAL_MODEL }}-${{ env.BUILD_TIME }}.zip"
          zip -j -r "$ZIP_NAME" "$PACK_DIR"
          
          # è¨­å®šç’°å¢ƒè®Šæ•¸ä¾› Upload èˆ‡ Release ä½¿ç”¨
          echo "FINAL_ZIP_PATH=/opt/images/$ZIP_NAME" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: ğŸ“¦-Upload-Artifacts
        uses: actions/upload-artifact@master
        with:
          name: ${{ inputs.target_select }}-${{ env.BUILD_TIME }}
          path: ${{ env.FINAL_ZIP_PATH }}

      - name: ğŸ·ï¸-Set-Release-Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=build-${{ inputs.target_select }}-${{ env.BUILD_TIME }}" >> $GITHUB_ENV

      - name: ğŸš€-Publish-Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: Build ${{ inputs.target_select }} (${{ env.BUILD_TIME }})
          body: |
            **Padavan ç·¨è­¯å ±å‘Š (Enhanced)**
            * æ©Ÿå‹: ${{ inputs.target_select }}
            * æ™‚é–“: ${{ env.BUILD_TIME }}
            * LAN IP: ${{ env.LANIP }}
            * å·¥å…·éˆ: ${{ inputs.toolchain_select }}
            
            ### åŒ…å«å…§å®¹
            * éŸŒé«”æª”æ¡ˆ (.trx)
            * ç³»çµ±é…ç½® (build.config, kernel.config)
            * Debug è³‡è¨Š (defaults.h, iptables patch check)
          artifacts: ${{ env.FINAL_ZIP_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
