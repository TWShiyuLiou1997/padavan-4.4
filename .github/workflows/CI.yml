name: Custom-Router-Build-Final-Fix

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "é¸æ“‡æ©Ÿå‹ (æ”¯æ´ K2P, K2P-NANO, K2P-USB ç­‰)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
          - MI-R3G
          - NEWIFI3
          - RM2100
        default: K2P

      nanoversion:
        description: "æ˜¯å¦åŸ·è¡Œæ¥µé™ç˜¦èº«"
        type: boolean
        default: true
      
      customization:
        description: 'è‡ªå®šç¾©é…ç½® JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'
      
      toolchain_select:
        description: "é¸æ“‡ç·¨è­¯å·¥å…·éˆ"
        required: true
        type: choice
        options:
          - Default (hanwckf/linux-4.4-v1.0, uclibc)
          - TurboTse/musl (gcc 13.3.0, musl 1.2.5)
          - TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)
          - tsl0922/musl (gcc 13.2.0, musl 1.2.4)
          - tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)
          - hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)
        default: Default (hanwckf/linux-4.4-v1.0, uclibc)

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: ğŸ“¥-Checkout-Repository
        uses: actions/checkout@master
      
      - name: ğŸš€-Install-Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq
          # è¨­å®šå°ç£æ™‚é–“ YYYYMMDD-HHMM
          echo "BUILD_TIME=$(TZ='Asia/Taipei' date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir -p /opt/images/

      - name: ğŸ”-Export-Custom-Variables
        run: |
          jq empty <<< '${{ inputs.customization }}' || { echo "âŒ Invalid JSON"; exit 1; }
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            echo "${k^^}=$v" >> $GITHUB_ENV  
          done

      - name: â¬‡ï¸-Clone-Source-Code
        run: |
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-4.4.git /opt/rt-n56u

      # =======================================================
      # [ä¿®æ­£ç‰ˆ v2] Libmnl å‡ç´šè‡³ 1.0.5 (Sed å–ä»£ Patchï¼Œä¿è­‰æˆåŠŸ)
      # =======================================================
      - name: ğŸ”¥ Upgrade libmnl to 1.0.5 (Robust Sed Method)
        run: |
          echo "::group::Libmnl Upgrade 1.0.5"
          
          # å®šç¾©è·¯å¾‘
          LIBMNL_DIR="/opt/rt-n56u/trunk/libs/libmnl"
          
          echo "ğŸ—‘ï¸ æ¸…ç†èˆŠç‰ˆ libmnl..."
          rm -rf "$LIBMNL_DIR"
          mkdir -p "$LIBMNL_DIR"
          cd "$LIBMNL_DIR"

          # 1. å¯«å…¥ C2 ç‰ˆæœ¬çš„ Makefile (æ”¹ç”¨ sed ä¿®æ”¹æºç¢¼)
          # æ³¨æ„ï¼šæˆ‘å€‘ç§»é™¤äº† patch æª”æ¡ˆï¼Œç›´æ¥åœ¨ extract_test ç”¨ sed æ“ä½œ
          cat << 'EOF' > Makefile
          SRC_NAME=libmnl-1.0.5
          SRC_URL=https://www.netfilter.org/pub/libmnl/$(SRC_NAME).tar.bz2

          all: download_test extract_test config_test
          	$(MAKE) -j$(HOST_NCPU) -C $(SRC_NAME)

          download_test:
          	( if [ ! -f $(SRC_NAME).tar.bz2 ]; then \
          		wget -t5 --timeout=20 --no-check-certificate -O $(SRC_NAME).tar.bz2 $(SRC_URL); \
          	fi )

          extract_test:
          	( if [ ! -d $(SRC_NAME) ]; then \
          		tar xjf $(SRC_NAME).tar.bz2; \
          		cd $(SRC_NAME); \
          		echo "ğŸ”§ Applying Sed patches to remove examples/doxygen..."; \
          		\
          		# [ä¿®æ”¹ 1] Makefile.am: ç§»é™¤ examples å’Œ doxygen ç›®éŒ„ \
          		sed -i 's/ examples doxygen//g' Makefile.am; \
          		\
          		# [ä¿®æ”¹ 2] configure.ac: ç§»é™¤æ‰€æœ‰ examples ä¸‹çš„ Makefile å®šç¾© \
          		# ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ç²¾æº–åˆªé™¤ \
          		sed -i 's| examples/[a-zA-Z0-9_/]*||g' configure.ac; \
          		\
          		# [é‡è¦] å› ç‚ºä¿®æ”¹äº† .am å’Œ .ac æª”ï¼Œå¿…é ˆé‡æ–°ç”Ÿæˆ configure \
          		autoreconf -vfi; \
          	fi )

          config_test:
          	( if [ -f ./config_done ]; then \
          		echo "the same configuration"; \
          	else \
          		make configure && touch config_done; \
          	fi )

          configure:
          	( cd $(SRC_NAME) ; \
          	./configure \
          		--prefix=$(STAGEDIR) \
          		--enable-static \
          		--disable-shared \
          		--host=$(HOST_TARGET) \
          		--build=$(HOST_BUILD) ; \
          	)

          clean:
          	if [ -f $(SRC_NAME)/Makefile ] ; then \
          		$(MAKE) -C $(SRC_NAME) distclean ; \
          	fi ; \
          	rm -f config_done

          install:
          	$(MAKE) -C $(SRC_NAME) install DESTDIR="" ;

          romfs:
          EOF

          echo "âœ… Libmnl 1.0.5 å‡ç´šé…ç½®å®Œæˆ (Ready to build)"
          echo "::endgroup::"
            
      # =======================================================
      # [ä¿®æ­£ç‰ˆ] iptables å‡ç´šèˆ‡ä¿®å¾© (ç²¾æº–åŒ¹é… 1.8.7)
      # =======================================================
      - name: ğŸ”¥ Auto Upgrade iptables 1.8.11 & Patch
        run: |
          echo "::group::Iptables Upgrade & Patching"
          NEW_VER="iptables-1.8.11"
          
          # 1. é–å®š Makefile è·¯å¾‘ä¸¦åµæ¸¬èˆŠç‰ˆæœ¬
          IPT_MAKEFILE=$(find /opt/rt-n56u/trunk/user/iptables -name Makefile | head -n 1)
          IPT_DIR=$(dirname "$IPT_MAKEFILE")
          
          # å¾ Makefile è£¡é¢æŠ“å‡ºç›®å‰çš„ç‰ˆæœ¬ (ä¾‹å¦‚ iptables-1.8.7)
          OLD_VER_STR=$(grep -o 'iptables-[0-9.]*' "$IPT_MAKEFILE" | head -n 1)
          echo "âœ… åµæ¸¬åˆ°èˆŠç‰ˆæœ¬: $OLD_VER_STR"
          echo "âœ… æº–å‚™å‡ç´šè‡³: $NEW_VER"

          # 2. ä¿®æ”¹ä¸» Makefile çš„ç‰ˆæœ¬è™Ÿ
          sed -i "s/$OLD_VER_STR/$NEW_VER/g" "$IPT_MAKEFILE"
          
          # 3. æ³¨å…¥ä¸‹è¼‰èˆ‡è§£å£“é‚è¼¯ (å› ç‚ºåŸæœ¬çš„ Makefile æ²’å¯«ä¸‹è¼‰)
          # åœ¨ all: ç›®æ¨™å‰æ’å…¥ä¸‹è¼‰æŒ‡ä»¤
          cd "$IPT_DIR"
          wget --no-check-certificate "https://www.netfilter.org/projects/iptables/files/${NEW_VER}.tar.xz"
          tar -xJf "${NEW_VER}.tar.xz"
          
          # 4. ç§»é™¤ autogen.sh èª¿ç”¨ (Release ç‰ˆä¸éœ€è¦ï¼Œä¸”å¸¸å ±éŒ¯)
          sed -i '/.\/autogen.sh/d' "$IPT_MAKEFILE"
          
          # 4. æ¸…ç†éæ™‚æŒ‡ä»¤
          sed -i '/extensions\/disabled\//d' "$IPT_MAKEFILE"

          # 5. ç”Ÿæˆå±è”½è­¦å‘Šçš„è£œä¸
          cat << 'EOF' > "$IPT_DIR/999-suppress-warnings.patch"
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          EOF
          
          # 6. æ³¨å…¥è£œä¸æ‡‰ç”¨é‚è¼¯
          sed -i 's|tar xJf $(SRC_NAME).tar.xz;|tar xJf $(SRC_NAME).tar.xz \&\& patch -d $(SRC_NAME) -p1 < 999-suppress-warnings.patch;|' "$IPT_MAKEFILE"
          
          echo "âœ… Iptables æœ¬é«”ä¿®å¾©å®Œæˆã€‚"

          # --- Part 2: ä¿®å¾©æ‰€æœ‰ä¾è³´èˆŠç‰ˆ iptables çš„å…¶ä»–è»Ÿé«” ---
          echo "ğŸ” é–‹å§‹æƒæä¸¦ä¿®å¾©ä¾è³´èˆŠç‰ˆ iptables çš„å…¶ä»–å¥—ä»¶..."
          
          # æœå°‹ /opt/rt-n56u/trunk/user ä¸‹æ‰€æœ‰å«æœ‰ "iptables-1.8.7" å­—ä¸²çš„ Makefile
          grep -rl "$OLD_VER_STR" /opt/rt-n56u/trunk/user/ | while read -r file ; do
              echo "  - ä¿®å¾©è·¯å¾‘: $file"
              sed -i "s/$OLD_VER_STR/$NEW_VER/g" "$file"
          done
          
          echo "ğŸ‰ å…¨å±€è·¯å¾‘æ›¿æ›å®Œæˆï¼æ‰€æœ‰å¥—ä»¶ç¾åœ¨éƒ½æŒ‡å‘ $NEW_VER"
          echo "::endgroup::"

      # =======================================================
      # [æ–°å¢] ç¶²è·¯å·¥å…·å‡ç´š v31 (è·¯å¾‘é©é… /opt/rt-n56u)
      # =======================================================
      - name: ğŸ”¥ Network Tools (Smart Compile & Robust Kernel Config)
        run: |
          echo "::group::Smart Compile Network Tools"
          
          # === è¨­å®šè·¯å¾‘ (é©é…æ­¤ workflow) ===
          BASE_DIR="/opt/rt-n56u/trunk/user"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. Arptables (ä¿®å¾© Tab åŒ¹é…å•é¡Œ + ç¢ºä¿åå–®æœ‰å®ƒ)
          # ========================================
          echo "â¬‡ï¸ Processing Arptables..."
          
          # [æ­¥é©Ÿ A] ç¢ºä¿ Userland Config é–‹å•Ÿ
          USER_CONFIG="/opt/rt-n56u/trunk/.config"
          if [ -f "$USER_CONFIG" ]; then
              echo "ğŸ”§ Enabling CONFIG_USER_ARPTABLES in Userland .config..."
              sed -i 's/^CONFIG_USER_ARPTABLES=.*/CONFIG_USER_ARPTABLES=y/' "$USER_CONFIG"
              if ! grep -q "CONFIG_USER_ARPTABLES=y" "$USER_CONFIG"; then
                  echo "CONFIG_USER_ARPTABLES=y" >> "$USER_CONFIG"
              fi
          fi

          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          # ä¸‹è¼‰æºç¢¼
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            wget --no-check-certificate "https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz" -O src.tar.gz
            tar -xf src.tar.gz && rm -f src.tar.gz
            
            ARP_SRC_NAME=$(ls -d arptables-0*/ | head -n 1 | sed 's/\///')
            chmod -R u+w "$ARP_SRC_NAME"
            
            echo "ğŸ”§ Creating Arptables Wrapper Makefile..."
            
            # [æ­¥é©Ÿ B] Wrapper
            cat << EOF > Makefile
          SRC_NAME=$ARP_SRC_NAME
          all:
          	\$(MAKE) -C \$(SRC_NAME) \
          		CC="\$(CC)" \
          		KERNEL_DIR=\$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		all
          	@if [ -f \$(SRC_NAME)/arptables ] && [ ! -f \$(SRC_NAME)/arptables-legacy ]; then \
          		cp \$(SRC_NAME)/arptables \$(SRC_NAME)/arptables-legacy; \
          	fi
          romfs:
          	\$(ROMFSINST) \$(SRC_NAME)/arptables-legacy /bin/arptables
          clean:
          	\$(MAKE) -C \$(SRC_NAME) clean
          	rm -f \$(SRC_NAME)/arptables-legacy
          EOF
          
            # [æ­¥é©Ÿ C] è¨»å†Šç›®éŒ„ (é‡å° Tab å„ªåŒ–)
            echo "ğŸ”§ Registering arptables in trunk/user/Makefile..."
            cd "$BASE_DIR" || exit 1
            
            # 1. å…ˆå‚™ä»½ä¸€ä¸‹
            cp Makefile Makefile.bak
            
            # 2. ä½¿ç”¨ .* ä¾†å¿½ç•¥ç©ºæ ¼æˆ– Tab çš„å·®ç•°ï¼Œç¢ºä¿æŠ“å¾—åˆ° ebtables é‚£ä¸€è¡Œ
            #    å¦‚æœ Makefile è£¡æ²’æœ‰ arptablesï¼Œå°±æ’åœ¨ ebtables å¾Œé¢
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                sed -i '/dir_y.*+=.*ebtables/a dir_y += arptables' Makefile
            else
                echo "âš ï¸ Arptables already in Makefile."
            fi

            # 3. [é›™é‡ä¿éšª] å¦‚æœ sed é‚„æ˜¯å¤±æ•—ï¼Œç›´æ¥è¿½åŠ åˆ°æª”æ¡ˆæœ€å¾Œé¢ (ä½†æ˜¯åœ¨ all: ä¹‹å‰)
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                echo "âš ï¸ Sed failed, forcing append..."
                # é€™è£¡æ¯”è¼ƒæš´åŠ›ï¼Œç›´æ¥æ’åœ¨ busybox å¾Œé¢ (busybox è‚¯å®šåœ¨æœ€å‰é¢)
                sed -i '/dir_y.*+=.*busybox/a dir_y += arptables' Makefile
            fi
            
            # 4. [é©—è­‰] å°å‡ºçµæœçµ¦ä½ çœ‹ï¼Œè®“ä½ æ”¾å¿ƒ
            echo "ğŸ” Checking Makefile content for arptables:"
            grep "arptables" Makefile || echo "âŒ ERROR: Arptables install failed!"
          fi
          
          # ========================================
          # 2. æ ¸å¿ƒæ¨¡çµ„æ”¯æ´ (Kernel Config)
          # ========================================
          cd "/opt/rt-n56u"
          # è‡ªå‹•åˆ¤æ–·æ ¸å¿ƒç‰ˆæœ¬è·¯å¾‘
          TARGET_KCONF="trunk/linux-4.4.x/.config"
          [ ! -f "$TARGET_KCONF" ] && TARGET_KCONF="trunk/linux-3.4.x/.config"
          
          if [ -f "$TARGET_KCONF" ]; then
             MODULES="CONFIG_IP_NF_ARPTABLES CONFIG_IP_NF_ARPFILTER CONFIG_IP_NF_ARP_MANGLE CONFIG_NF_LOG_ARP CONFIG_BRIDGE_EBT_ARP CONFIG_BRIDGE_EBT_ARPREPLY"
             for mod in $MODULES; do
                if grep -q "$mod" "$TARGET_KCONF"; then
                   sed -i "s|^.*$mod.*$|$mod=m|" "$TARGET_KCONF"
                else
                   echo "$mod=m" >> "$TARGET_KCONF"
                fi
             done
          fi
          
          echo "::endgroup::"

      - name: â¬‡ï¸-Prepare-Toolchain
        env:
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
          TOOLCHAIN_DIR: /opt/rt-n56u/toolchain-mipsel/toolchain-4.4.x
        run: |
          cd /opt/rt-n56u/toolchain-mipsel
          TOOLCHAIN_TAG_FOR_NAME=$(echo "${{ inputs.toolchain_select }}" | sed 's/ (.*//g' | sed 's/\//-/g')
          echo "TOOLCHAIN_TAG_FOR_NAME=$TOOLCHAIN_TAG_FOR_NAME" >> $GITHUB_ENV
          
          case "$TOOLCHAIN_CHOICE" in
            "Default (hanwckf/linux-4.4-v1.0, uclibc)") sh dl_toolchain.sh ;;
            "TurboTse/musl (gcc 13.3.0, musl 1.2.5)") URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)") URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "tsl0922/musl (gcc 13.2.0, musl 1.2.4)") URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)") URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)") URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" ;;
          esac
          
          if [ ! -z "$URL" ]; then
            curl -O -L "$URL"
            rm -rf "$TOOLCHAIN_DIR"; mkdir -p "$TOOLCHAIN_DIR"
            tar -xf "$(basename $URL)" -C "$TOOLCHAIN_DIR" --strip-components=1
          fi
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s "$TOOLCHAIN_DIR" /toolchain-4.4.x

      - name: ğŸ“-CORE-Modify-Template-and-Sync-Config
        env:
          RAW_TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
        run: |
          TEMPLATE_DIR="/opt/rt-n56u/trunk/configs/templates"
          TRUNK_CONFIG="/opt/rt-n56u/trunk/.config"
          
          # è§£æ±º - èˆ‡ _ çš„åŒ¹é…å•é¡Œ
          PATTERN_A=$(echo "$RAW_TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$RAW_TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 1 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ] || [ ! -f "$TARGET_FILE" ]; then
             echo "::error:: âŒ æ‰¾ä¸åˆ°è¨­å®šæª”ï¼" && exit 1
          fi
          
          REAL_MODEL=$(basename "$TARGET_FILE" .config)
          echo "REAL_MODEL=$REAL_MODEL" >> $GITHUB_ENV

          # æ¥µé™ç˜¦èº«é‚è¼¯
          if [ "$NANO_OPT" = "true" ] || [[ "$REAL_MODEL" =~ "nano" ]]; then
            modules=(
              UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS \
              NTFS_3G LPRD U2EC HDPARM PARTED SMBD WINS SMBD_SYSLOG \
              FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN \
              SSWAN XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION \
              TRANSMISSION_WEB_CONTROL ARIA ARIA_WEB_CONTROL SCUTCLIENT \
              GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER \
              SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE \
              LRZSZ IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY \
              MENTOHUST FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY \
              TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER \
              SMARTDNS ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER \
              SQM WIREGUARD
            )
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" "$TARGET_FILE"
            done
          fi

          # æ ¸å¿ƒä¿ç•™æ¨¡çµ„ (ç¢ºä¿ç§»é™¤ HTOP/NANO)
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SFE QOS)
          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$TARGET_FILE"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$TARGET_FILE"
          done
          
          cp -f "$TARGET_FILE" "$TRUNK_CONFIG"

      - name: ğŸ”¨-Build-Host-Tools
        run: |
          cd /opt/rt-n56u/trunk
          [ -f "tools/mkimage/mkimage.c" ] && sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
          make tools

      - name: ğŸ“-Apply-Custom-Settings
        run: |
          cd /opt/rt-n56u
          chmod +x trunk/custom/scripts/*.sh
          bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict
          bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/defaults.h
          bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/defaults.h

      - name: ğŸ—ï¸-Build-Firmware
        run: |
          cd /opt/rt-n56u/trunk
          sudo ./clear_tree
          sudo ./build_firmware_modify "${{ env.REAL_MODEL }}" 0
          
          FINAL_FILENAME="${{ env.REAL_MODEL }}-${{ env.TOOLCHAIN_TAG_FOR_NAME }}-${{ env.BUILD_TIME }}.trx"
          FOUND_FILE=$(find images -name "*.trx" | head -n 1)
          if [ -z "$FOUND_FILE" ]; then echo "::error::æœªç”¢å‡º TRX æª”æ¡ˆ"; exit 1; fi
          sudo mv -f "$FOUND_FILE" "/opt/images/$FINAL_FILENAME"
          echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV

      # =======================================================
      # [ä¿®æ”¹] æ™ºæ…§æ‰“åŒ… (Debugè¿½è¹¤ + ç”¢ç‰©æ”¶é›†)
      # =======================================================
      - name: ğŸ“¦-Smart-Pack-Artifacts-Debug
        run: |
          echo "::group::Smart Packing & Debug Collection"
          
          # å®šç¾©è·¯å¾‘ (é©é… /opt/rt-n56u)
          WORK_DIR="/opt/rt-n56u"
          PACK_DIR="/opt/images/output_pack"
          IMAGES_DIR="/opt/images"
          
          mkdir -p "$PACK_DIR"
          
          # 1. æ”¶é›†é—œéµé…ç½®èˆ‡æ—¥èªŒ
          echo "Collecting Configs and Logs..."
          [ -f "$WORK_DIR/trunk/.config" ] && cp "$WORK_DIR/trunk/.config" "$PACK_DIR/build.config"
          [ -f "$WORK_DIR/trunk/user/shared/defaults.h" ] && cp "$WORK_DIR/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "$WORK_DIR/trunk/linux-4.4.x/.config" ] && cp "$WORK_DIR/trunk/linux-4.4.x/.config" "$PACK_DIR/kernel.config"
          # æ³¨æ„ï¼šæ­¤è…³æœ¬çš„ build log å¯èƒ½ç”± CI ç³»çµ±æ¥ç®¡ï¼Œé€™é‚Šå˜—è©¦æ‰¾å¸¸è¦‹ä½ç½®
          [ -f "$WORK_DIR/trunk/build.log" ] && cp "$WORK_DIR/trunk/build.log" "$PACK_DIR/build.log"

          # 2. æ”¶é›† iptables Debug æª”æ¡ˆ
          mkdir -p "$PACK_DIR/debug_iptables"
          IPT_BASE_DIR="$WORK_DIR/trunk/user/iptables"
          IPT_SRC_DIR="$IPT_BASE_DIR/iptables-1.8.11"
          
          if [ -f "$IPT_BASE_DIR/999-suppress-warnings.patch" ]; then
              cp "$IPT_BASE_DIR/999-suppress-warnings.patch" "$PACK_DIR/debug_iptables/"
          fi
          if [ -f "$IPT_SRC_DIR/libxtables/xtables.c" ]; then
              cp "$IPT_SRC_DIR/libxtables/xtables.c" "$PACK_DIR/debug_iptables/xtables_patched.c"
          fi

          # 3. ç§»å‹•éŸŒé«”æª”æ¡ˆåˆ°æ‰“åŒ…ç›®éŒ„
          if [ -f "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" ]; then
             cp "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" "$PACK_DIR/"
          else
             echo "::warning:: Firmware file not found in images dir!"
          fi

          # 4. ç”Ÿæˆ MD5
          cd "$PACK_DIR"
          md5sum * > md5sum.txt 2>/dev/null || true
          
          # 5. æ‰“åŒ… Zip
          cd "/opt/images"
          ZIP_NAME="Padavan-${{ env.REAL_MODEL }}-${{ env.BUILD_TIME }}.zip"
          zip -j -r "$ZIP_NAME" "$PACK_DIR"
          
          # è¨­å®šç’°å¢ƒè®Šæ•¸ä¾› Upload èˆ‡ Release ä½¿ç”¨
          echo "FINAL_ZIP_PATH=/opt/images/$ZIP_NAME" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: ğŸ“¦-Upload-Artifacts
        uses: actions/upload-artifact@master
        with:
          name: ${{ inputs.target_select }}-${{ env.BUILD_TIME }}
          path: ${{ env.FINAL_ZIP_PATH }}

      - name: ğŸ·ï¸-Set-Release-Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=build-${{ inputs.target_select }}-${{ env.BUILD_TIME }}" >> $GITHUB_ENV

      - name: ğŸš€-Publish-Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: Build ${{ inputs.target_select }} (${{ env.BUILD_TIME }})
          body: |
            **Padavan ç·¨è­¯å ±å‘Š (Enhanced)**
            * æ©Ÿå‹: ${{ inputs.target_select }}
            * æ™‚é–“: ${{ env.BUILD_TIME }}
            * LAN IP: ${{ env.LANIP }}
            * å·¥å…·éˆ: ${{ inputs.toolchain_select }}
            
            ### åŒ…å«å…§å®¹
            * éŸŒé«”æª”æ¡ˆ (.trx)
            * ç³»çµ±é…ç½® (build.config, kernel.config)
            * Debug è³‡è¨Š (defaults.h, iptables patch check)
          artifacts: ${{ env.FINAL_ZIP_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
