name: Custom-Router-Build-Final-Fix

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "ÈÅ∏ÊìáÊ©üÂûã (ÊîØÊè¥ K2P, K2P-NANO, K2P-USB Á≠â)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
          - MI-R3G
          - NEWIFI3
          - RM2100
        default: K2P

      nanoversion:
        description: "ÊòØÂê¶Âü∑Ë°åÊ•µÈôêÁò¶Ë∫´"
        type: boolean
        default: true
      
      customization:
        description: 'Ëá™ÂÆöÁæ©ÈÖçÁΩÆ JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'
      
      toolchain_select:
        description: "ÈÅ∏ÊìáÁ∑®Ë≠ØÂ∑•ÂÖ∑Èèà"
        required: true
        type: choice
        options:
          - Default (hanwckf/linux-4.4-v1.0, uclibc)
          - Padavan-NG (GCC 13+, uClibc-ng, ZSTD)
          - TurboTse/musl (gcc 13.3.0, musl 1.2.5)
          - TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)
          - tsl0922/musl (gcc 13.2.0, musl 1.2.4)
          - tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)
          - hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)
        default: Default (hanwckf/linux-4.4-v1.0, uclibc)

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: üì•-Checkout-Repository
        uses: actions/checkout@master
      
      - name: üöÄ-Install-Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git zstd \
            build-essential fakeroot flex bison gawk gperf \
            autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq
          # Ë®≠ÂÆöÂè∞ÁÅ£ÊôÇÈñì YYYYMMDD-HHMM
          echo "BUILD_TIME=$(TZ='Asia/Taipei' date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir -p /opt/images/

      - name: üîé-Export-Custom-Variables
        run: |
          jq empty <<< '${{ inputs.customization }}' || { echo "‚ùå Invalid JSON"; exit 1; }
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            echo "${k^^}=$v" >> $GITHUB_ENV  
          done

      - name: ‚¨áÔ∏è-Clone-Source-Code
        run: |
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-4.4.git /opt/rt-n56u

      # =======================================================
      # [Ê≠•È©ü A] Áµ±‰∏ÄÊ∫ñÂÇôË≥áÊ∫ê (Âè™ Clone ‰∏ÄÊ¨°ÔºÅ)
      # =======================================================
      - name: ‚¨áÔ∏è Prepare Reference Source (padavan-ng)
        run: |
          echo "::group::Clone padavan-ng to /tmp"
          # Á¢∫‰øùÁí∞Â¢É‰πæÊ∑®
          rm -rf /tmp/padavan-ng
          
          # Áµ±‰∏Ä Clone Âà∞Ëá®ÊôÇÁõÆÈåÑ
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-ng.git /tmp/padavan-ng
          
          echo "‚úÖ Reference repo ready at /tmp/padavan-ng"
          echo "::endgroup::"

      # =======================================================
      # [Ê≠•È©ü B] BusyBox 1.37.0 Âö¥Ê†ºÈô§ÈåØÊºîÈÄ≤Áâà (Fix: TIME64 + No rule for olddefconfig)
      # =======================================================
      - name: üî• Sync & Evolve BusyBox (Debug Mode)
        run: |
          # 1. ÈñãÂïüÊ•µËá¥Èô§ÈåØÊ®°Âºè
          set -x
          
          echo "::group::BusyBox Evolution (Debug)"
          
          # ÂÆöÁæ©Ë∑ØÂæë
          REPO_ROOT="/opt/rt-n56u"
          ORIGINAL_CONFIG="$REPO_ROOT/trunk/configs/boards/busybox.config"
          SOURCE_DIR="/tmp/padavan-ng/trunk/user/busybox"
          TARGET_DIR="$REPO_ROOT/trunk/user/busybox"

          # =======================================================
          # A. [Ë°ìÂâçÊ™¢Êü•] ÊéÉÊèèÁèæÁãÄ
          # =======================================================
          echo "üîç [PRE-CHECK] 1. Inspecting Build Scripts (Target: busybox_id)..."
          find "$REPO_ROOT/trunk" -maxdepth 1 -name "build_firmware*" -o -name "*.sh" | xargs grep -n "busybox_id=" || true

          echo "üîç [PRE-CHECK] 2. Inspecting Makefiles (Target: busybox-1.24.x)..."
          grep -rn "busybox-1.24.x" "$REPO_ROOT/trunk/user" | head -n 20 || true
          
          echo "üîç [PRE-CHECK] 3. Inspecting Config Header..."
          head -n 5 "$ORIGINAL_CONFIG" || true

          # =======================================================
          # B. [Ê∫ñÂÇôÈöéÊÆµ] ÂéüÂßãÁ¢ºÊõøÊèõ
          # =======================================================
          echo "üóëÔ∏è Cleaning old busybox..."
          rm -rf "$TARGET_DIR"
          
          if [ ! -d "$SOURCE_DIR" ]; then
             echo "‚ùå Error: Padavan-ng source not found!"
             exit 1
          fi

          echo "üöö Copying BusyBox 1.37.0 source..."
          cp -rf "$SOURCE_DIR" "$TARGET_DIR"
          cd "$TARGET_DIR"

          # =======================================================
          # C. [ÊºîÈÄ≤ÈöéÊÆµ] Config Evolution (1.24.2 -> 1.37.0)
          # =======================================================
          echo "üß¨ Evolving config..."
          
          if [ ! -f "$ORIGINAL_CONFIG" ]; then
              echo "‚ùå Error: Original config not found!"
              exit 1
          fi

          # 1. Ê≥®ÂÖ•ËàäÈùàÈ≠Ç
          cp -f "$ORIGINAL_CONFIG" busybox-1.37.0/.config
          
          # 2. Ëá™ÂãïÊºîÈÄ≤ (ÊîπÁî® yes "" | make oldconfig)
          cd busybox-1.37.0
          
          # [FIX] olddefconfig Â§±ÊïóÔºåÊîπÁî® yes "" | make oldconfig
          yes "" | make oldconfig
          
          # 3. È©óË≠âÊºîÈÄ≤ÁµêÊûú
          if grep -q "Busybox version: 1.37.0" .config; then
              echo "‚úÖ Config successfully evolved to 1.37.0"
          else
              echo "‚ùå Error: Config evolution failed!"
              head -n 10 .config
              exit 1
          fi

          # =======================================================
          # [ÈóúÈçµ‰øÆÊ≠£] TIME64 Âº∑Âà∂ÈóúÈñâËàáÈõôÈáçÈ©óË≠â
          # =======================================================
          echo "üöë Patching TIME64 setting..."
          
          # 3.1 ‰øÆÊîπÂâçÈ©óË≠â (Post-Make Check)
          echo "üîç Checking TIME64 before sed..."
          grep "CONFIG_TIME64" .config || echo "TIME64 not found before sed (Might be default)"
          
          # 3.2 Âü∑Ë°å‰øÆÊ≠£ (ÁÑ°Ë´ñ‰πãÂâçÊòØ‰ªÄÈ∫ºÔºåÂº∑Âà∂ÊîπÁÇ∫ is not set)
          #     Ê≥®ÊÑèÔºöÂ¶ÇÊûúÂéüÊú¨Ê≤íÈÄôË°åÔºåsed ÊõøÊèõÂèØËÉΩÊúÉÂ§±ÊïàÔºåÊâÄ‰ª•ÊàëÂÄëÂÖàÂòóË©¶ÊõøÊèõÔºåËã•Ê≤íÊõøÊèõÊàêÂäüÂâáËøΩÂä†
          if grep -q "CONFIG_TIME64" .config; then
             sed -i 's/^CONFIG_TIME64=.*/# CONFIG_TIME64 is not set/' .config
             sed -i 's/^# CONFIG_TIME64 is not set/# CONFIG_TIME64 is not set/' .config # Èò≤ÂëÜÔºåÈÅøÂÖçÈáçË§áË®ªËß£
          else
             echo "# CONFIG_TIME64 is not set" >> .config
          fi
          
          # 3.3 ‰øÆÊîπÂæåÈ©óË≠â (Post-Sed Check)
          echo "üîç Checking TIME64 after sed..."
          if grep -q "^# CONFIG_TIME64 is not set" .config; then
             echo "‚úÖ TIME64 is correctly disabled."
          else
             echo "‚ùå Error: TIME64 is NOT disabled! dumping config grep..."
             grep "CONFIG_TIME64" .config
             exit 1
          fi

          # 4. ÂõûÂØ´ËàáÂêåÊ≠•
          echo "üíæ Saving evolved config..."
          cp -f .config "$ORIGINAL_CONFIG"
          cp -f .config ../config
          
          cd .. # ÂõûÂà∞ user/busybox

          # =======================================================
          # D. [‰øÆÊ≠£ÈöéÊÆµ] ‰øÆÊîπÁ∑®Ë≠ØËÖ≥Êú¨Ëàá‰æùË≥¥
          # =======================================================
          echo "üõ†Ô∏è Patching build scripts..."
          
          # 1. ‰øÆÊ≠£ build_firmware*
          find "$REPO_ROOT/trunk" -maxdepth 1 -name "*.sh" -o -name "build_firmware*" | while read -r script; do
              if grep -q 'busybox_id="1.24.x"' "$script"; then
                  echo "   -> [SED] Patching $script ..."
                  sed -i 's/busybox_id="1.24.x"/busybox_id="1.37.0"/' "$script"
              fi
          done

          echo "üîç Patching source dependencies..."
          # 2. ‰øÆÊ≠£ user/ ‰∏ãÊâÄÊúâ Makefile
          OLD_VER="busybox-1.24.x"
          NEW_VER="busybox-1.37.0"
          
          grep -rl "$OLD_VER" "$REPO_ROOT/trunk/user" | xargs -r sed -i "s/$OLD_VER/$NEW_VER/g"
          grep -rl "busybox-1.24.2" "$REPO_ROOT/trunk/user" | xargs -r sed -i "s/busybox-1.24.2/$NEW_VER/g"

          # =======================================================
          # E. [Ë°ìÂæåÊ™¢Êü•] È©óË≠âÁµêÊûú
          # =======================================================
          echo "üîç [POST-CHECK] 1. Verifying Build Scripts (Should be 1.37.0)..."
          find "$REPO_ROOT/trunk" -maxdepth 1 -name "build_firmware*" -o -name "*.sh" | xargs grep -n "busybox_id=" || true

          echo "üîç [POST-CHECK] 2. Verifying Makefiles (Should be 1.37.0)..."
          REMAINING_OLD=$(grep -rn "busybox-1.24.x" "$REPO_ROOT/trunk/user" | wc -l)
          if [ "$REMAINING_OLD" -eq 0 ]; then
             echo "‚úÖ All references to 1.24.x have been removed."
          else
             echo "‚ö†Ô∏è Warning: Found $REMAINING_OLD remaining references to 1.24.x:"
             grep -rn "busybox-1.24.x" "$REPO_ROOT/trunk/user" || true
          fi
          
          echo "üîç [POST-CHECK] 3. Verifying New Config Header..."
          head -n 5 "$ORIGINAL_CONFIG"

          echo "üîç [POST-CHECK] 4. Final TIME64 Verification..."
          grep "CONFIG_TIME64" "$ORIGINAL_CONFIG"
          
          # ÈóúÈñâÈô§ÈåØÊ®°Âºè
          set +x
          echo "üéâ Strict Debug Verification Complete!"
          echo "::endgroup::"

      # =======================================================
      # [Ê≠•È©ü C] ÂêåÊ≠• libmnl (ÈáçË§áÂà©Áî®Âêå‰∏ÄÂÄã‰æÜÊ∫ê)
      # =======================================================
      - name: üî• Sync libmnl from padavan-ng
        run: |
          echo "::group::Sync libmnl"
          
          TARGET_DIR="/opt/rt-n56u/trunk/libs/libmnl"
          SOURCE_DIR="/tmp/padavan-ng/trunk/libs/libmnl"

          # 1. ÁßªÈô§ËàäÁâà
          rm -rf "$TARGET_DIR"
          
          # 2. Ê™¢Êü•‰æÜÊ∫ê
          if [ ! -d "$SOURCE_DIR" ]; then
             echo "‚ùå Error: ‰æÜÊ∫êË≥áÊñôÂ§æ $SOURCE_DIR ‰∏çÂ≠òÂú®"
             exit 1
          fi
          
          # 3. Êê¨ÈÅã
          cp -rf "$SOURCE_DIR" "$TARGET_DIR"
          
          # 4. È©óË≠â
          if [ -f "$TARGET_DIR/Makefile" ]; then
            echo "‚úÖ libmnl Êê¨ÈÅãÊàêÂäüÔºÅ"
          else
            echo "::error::‚ùå Êê¨ÈÅãÂ§±ÊïóÔºÅÊâæ‰∏çÂà∞ Makefile"
            exit 1
          fi
          
          # 5. Ê∏ÖÁêÜËá®ÊôÇÊ™îÊ°à
          rm -rf /tmp/padavan-ng
          echo "::endgroup::"

      # =======================================================
      # [ÁµÇÊ•µÊî∂ÈõÜÁâà] iptables Patch Collector & Patcher
      # =======================================================
      - name: üî• Collect & Patch iptables (Enhanced Logic)
        run: |
          set +e  # ÈóúÈñâÈåØË™§‰∏≠Êñ∑ÔºåÁ¢∫‰øùË∑ëÂÆåÂÖ®Á®ã
          set -x  # Â¶ÇÊûúÈúÄË¶ÅÊ•µËá¥ Debug ÂèØÊâìÈñãÊ≠§Ë°å
          
          echo "::group::Patching Iptables 1.8.7 (Collector Mode)"
          
          # =======================================================
          # ‚öôÔ∏è Ë®≠ÂÆöÂçÄ
          # =======================================================
          IPT_ROOT="/opt/rt-n56u/trunk/user/iptables/iptables-1.8.7"
          PATCH_DIR="patches_archive"
          LOG_FILE="patch_summary.log"
          
          # [ÂàùÂßãÂåñ] ÊµÅÁ®ãÊéßÂà∂ËÆäÊï∏
          SKIP_PATCHING=false
          
          # ÂÑ™ÂåñÂÖ®Â±ÄÁ∂≤Ë∑ØË®≠ÁΩÆ
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global http.sslVerify false
          
          # Ê™¢Êü•ÂéüÂßãÁ¢ºÁõÆÈåÑÊòØÂê¶Â≠òÂú®
          if [ ! -d "$IPT_ROOT" ]; then
             echo "‚ùå CRITICAL: Source directory '$IPT_ROOT' NOT FOUND!"
             # ‰æùÊìöÂÆåÁæéÈÇèËºØË®≠ÂÆö SKIP_PATCHINGÔºåÁ¢∫‰øùÊµÅÁ®ãÂèØÊéß
             SKIP_PATCHING=true
          else
             cd "$IPT_ROOT"
             mkdir -p "$PATCH_DIR"
             touch "$LOG_FILE"
          fi

          # ‚öôÔ∏è Ê†πÊìöÁãÄÊÖãÊ±∫ÂÆöÊòØÂê¶Â•óÁî® Patch
          if [ "$SKIP_PATCHING" = true ]; then
              APPLY_PATCHES=false
              echo "‚ö†Ô∏è Skipping Patch Application due to directory check failure."
          else
              APPLY_PATCHES=true
          fi

          # =======================================================
          # üõ†Ô∏è [Ê†∏ÂøÉÂáΩÊï∏] Áç®Á´ãÈ©óË≠âÈÇèËºØ (V12.3: Awk Êô∫ÊÖßÈÇäÁïåÂà§ÂÆö + Ë°åÊï∏Èò≤Á¶¶)
          # =======================================================
          verify_patch_integrity() {
              local F_PATH="$1"
              local EXP_ID="$2"
              local EXP_SUBJ="$3"
              
              # 1. Âü∫Á§éÊ™îÊ°àÊ™¢Êü•
              if [ ! -s "$F_PATH" ]; then return 1; fi
              if ! grep -qE "^diff --git|^--- a/" "$F_PATH"; then return 1; fi

              local CHECK_PASS=true

              # 2. Commit ID ÊØîÂ∞ç
              if [ -n "$EXP_ID" ]; then
                  local FILE_ID=$(grep "^From " "$F_PATH" | head -n 1 | awk '{print $2}')
                  if [[ "$FILE_ID" == "$EXP_ID"* ]]; then
                      echo "   ‚úÖ ID Check: MATCH ($EXP_ID)"
                  else
                      echo "   ‚ùå ID Check: MISMATCH (File: ${FILE_ID:0:8} vs Url: ${EXP_ID:0:8})"
                      CHECK_PASS=false
                  fi
              fi

              # 3. Subject Ê®ôÈ°åÊØîÂ∞ç (‰ΩøÁî® awk ÈÄ≤Ë°åÂ§öË°åÂêà‰ΩµËàáÊô∫ÊÖßÈÇäÁïåÂÅµÊ∏¨)
              if [ -n "$EXP_SUBJ" ]; then
                  # Awk ÈÇèËºØÔºö
                  # 1. ÊâæÂà∞ Subject: ÈñãÈ†≠ÔºåË®≠ÂÆö flag=1„ÄÇ
                  # 2. Â¶ÇÊûú flag=1ÔºåÊ™¢Êü•Áï∂ÂâçË°åÊòØÂê¶ÁÇ∫ÈÇäÁïåÔºàÁ©∫Ë°åÊàñÊñ∞ HeaderÔºâ„ÄÇ
                  # 3. Â¶ÇÊûúÊòØÈÇäÁïåÔºåÂÅúÊ≠¢ËÆÄÂèñÔºõÂê¶ÂâáÂ∞áÂÖßÂÆπ‰∏≤Êé•„ÄÇ
                  # 4. Ëº∏Âá∫‰∏≤Êé•ÂæåÁöÑÁµêÊûú„ÄÇ
                  local RAW_SUBJ_BLOCK=$(awk '
                      /^Subject: / { flag=1; sub(/^Subject: /, ""); printf "%s", $0; next }
                      flag == 1 {
                          # „Äê‰øÆÊ≠£Èªû„ÄëÂä†ÂÖ•Ë°åÊï∏ÈôêÂà∂ÔºåÈò≤Ê≠¢Á∑©Ë°ùÂçÄÊ∫¢‰Ωç
                          c++; if (c > 10) exit; 
                          if (/^$/) exit;  # ÈÅáÂà∞Á©∫Ë°å -> ÁµêÊùü
                          if (/^[A-Za-z0-9-]+:/) exit; # ÈÅáÂà∞Êñ∞ Header (Â¶Ç MIME-Version:) -> ÁµêÊùü
                          printf " %s", $0; # Âê¶ÂâáË¶ñÁÇ∫ Subject ÁöÑÂª∂Á∫å (ÊèõË°åËÆäÁ©∫Ê†º)
                      }
                  ' "$F_PATH" | sed 's/\[PATCH\] //g')
                  
                  # Âü∑Ë°åÊ®ôÊ∫ñÂåñÔºöÂè™‰øùÁïôËã±Êï∏Â≠ó
                  local FILE_NORM_SUBJ=$(echo "$RAW_SUBJ_BLOCK" | tr -dc 'a-zA-Z0-9')
                  
                  if [ "$FILE_NORM_SUBJ" == "$EXP_SUBJ" ]; then
                      echo "   ‚úÖ Subject Check: MATCH"
                  else
                      echo "   ‚ùå Subject Check: MISMATCH"
                      CHECK_PASS=false
                  fi
              fi

              if [ "$CHECK_PASS" = true ]; then return 0; else return 1; fi
          }

          # =======================================================
          # üõ†Ô∏è [‰∏ªËôïÁêÜÂáΩÊï∏] V12.3 ÈÇèËºØÔºöProcess Loop (Âø´ÂèñÂ§±Êïó -> ÂõûÊ≠∏‰∏ª‰∏ãËºâÊµÅÁ®ã)
          # =======================================================
          download_and_process() {
              local DATE=$1
              local RAW_NAME=$2
              local URL=$3
              local COUNT=$4
              
              # A. ÂèÉÊï∏Ê∫ñÂÇô
              local SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9]/_/g')
              local PATCH_FILENAME="$PATCH_DIR/${COUNT}_${DATE}_${SAFE_NAME}.patch"
              # ‰ΩøÁî®Áï∂ÂâçÁõÆÈåÑ (iptables root) Â≠òÊîæËá®ÊôÇÊ™îÊ°à
              local COOKIE_FILE="cookies.txt"
              local UA_CACHE="ua_cache.txt"
              
              local TARGET_COMMIT_ID=$(echo "$URL" | grep -o 'id=[a-f0-9]*' | cut -d= -f2)
              local TARGET_NORM_SUBJECT=$(echo "$RAW_NAME" | tr -dc 'a-zA-Z0-9')

              echo "---------------------------------------------------"
              echo "Processing Patch #$COUNT: $RAW_NAME"

              local PROCESS_ATTEMPT=0
              local PROCESS_SUCCESS=false

              # üî• V12 Ê†∏ÂøÉÔºö‰ΩøÁî® while Ëø¥ÂúàËôïÁêÜÈáçË©¶
              while [ $PROCESS_ATTEMPT -lt 2 ]; do
                  PROCESS_ATTEMPT=$((PROCESS_ATTEMPT+1))
                  local NEED_DOWNLOAD=true

                  # ==========================================
                  # B. ÁãÄÊÖãÊ™¢Êü• (Check Phase)
                  # ==========================================
                  if [ -f "$PATCH_FILENAME" ]; then
                      echo "üîç [Attempt $PROCESS_ATTEMPT] Verifying local cache..."
                      if verify_patch_integrity "$PATCH_FILENAME" "$TARGET_COMMIT_ID" "$TARGET_NORM_SUBJECT"; then
                          echo "‚úÖ Local cache verified valid."
                          NEED_DOWNLOAD=false
                      else
                          echo "‚ö†Ô∏è Cache verification failed. Deleting..."
                          rm -f "$PATCH_FILENAME"
                          NEED_DOWNLOAD=true
                      fi
                  else
                      NEED_DOWNLOAD=true
                  fi

                  # ==========================================
                  # C. ‰∏ãËºâÊµÅÁ®ã (Download Phase) - ÂÆåÊï¥ÁöÑ V9 ÂèÉÊï∏Èò≤Á¶¶
                  # ==========================================
                  if [ "$NEED_DOWNLOAD" = true ]; then
                      echo "‚¨áÔ∏è [Attempt $PROCESS_ATTEMPT] Starting Full Download Sequence..."

                      # [UA ÁîüÊàê]
                      if [ $((10#$COUNT % 10)) -eq 1 ] || [ ! -f "$UA_CACHE" ]; then
                          local MINOR_VER=$((RANDOM % 100))
                          echo "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.${MINOR_VER}.0 Safari/537.36" > "$UA_CACHE"
                          rm -f "$COOKIE_FILE"
                          echo "üîÑ Session Rotate: New UA Generated."
                      fi
                      local UA=$(cat "$UA_CACHE")
                      
                      # [Headers Ë®≠ÂÆö]
                      local H_SEC_CH_UA='"Not(A:Brand";v="8", "Chromium";v="144", "Google Chrome";v="144"'
                      local H_SEC_PLATFORM='"Windows"'
                      local H_LANG="en-US,en;q=0.9"
                      local ACCEPT_FILE="text/x-diff,text/plain,application/octet-stream;q=0.9,*/*;q=0.8"
                      
                      local COMMIT_URL=$(echo "$URL" | sed 's|/patch/|/commit/|')
                      local LOG_URL="https://git.netfilter.org/iptables/log/"
                      
                      # [Êà∞Áï• 3] Èö®Ê©üÈï∑‰ºëÊÅØ (Human Fatigue)
                      if [ $((COUNT % 30)) -eq 0 ]; then
                          local SLEEP_LONG=$(shuf -i 20-40 -n 1)
                          echo "‚òï Coffee Break: Sleeping for ${SLEEP_LONG}s..."
                          sleep $SLEEP_LONG
                      else
                          sleep $(shuf -i 2-4 -n 1)
                      fi

                      local MAX_RETRIES=5
                      local DOWNLOAD_OK=false

                      for ((i=1; i<=MAX_RETRIES; i++)); do
                          local BACKOFF_TIME=$((5 * i + 5))
                          
                          # [Pre-flight Check]
                          local PREFLIGHT_DONE=false
                          if [ $((RANDOM % 5)) -eq 0 ] || [ $i -gt 1 ]; then
                              echo "üé≠ Performing Pre-flight check..."
                              curl -k -L -s -o /dev/null \
                                   -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                                   -H "User-Agent: $UA" -H "Referer: $LOG_URL" \
                                   "$COMMIT_URL"
                              sleep 1
                              PREFLIGHT_DONE=true
                          fi

                          local CUR_REFERER="$LOG_URL"
                          [ "$PREFLIGHT_DONE" = true ] && CUR_REFERER="$COMMIT_URL"

                          # 1. ÂòóË©¶ Curl
                          if curl -k -L -s \
                               -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                               -H "User-Agent: $UA" \
                               -H "Accept: $ACCEPT_FILE" \
                               -H "Accept-Language: $H_LANG" \
                               -H "Referer: $CUR_REFERER" \
                               -H "sec-ch-ua: $H_SEC_CH_UA" \
                               -H "sec-ch-ua-platform: $H_SEC_PLATFORM" \
                               --connect-timeout 20 --retry 2 \
                               -o "$PATCH_FILENAME" "$URL"; then
                              
                              if verify_patch_integrity "$PATCH_FILENAME" "$TARGET_COMMIT_ID" "$TARGET_NORM_SUBJECT"; then
                                  echo "‚úÖ [Attempt $i] Download Success & Verified"
                                  DOWNLOAD_OK=true
                                  break
                              else
                                  echo "‚ö†Ô∏è [Attempt $i] Content invalid. Rotating identity..."
                                  rm -f "$COOKIE_FILE" "$UA_CACHE"
                              fi
                          fi
                          
                          # 2. Á≠ñÁï• B: Wget (Clean Request)
                          echo "‚ö†Ô∏è Curl failed/invalid. Switching to Wget..."
                          rm -f "$PATCH_FILENAME"
                          if wget --no-check-certificate -q \
                               --user-agent="$UA" \
                               --header="Accept: $ACCEPT_FILE" \
                               --header="Referer: $COMMIT_URL" \
                               --header="sec-ch-ua: $H_SEC_CH_UA" \
                               --header="sec-ch-ua-platform: $H_SEC_PLATFORM" \
                               -O "$PATCH_FILENAME" "$URL"; then
                               
                               if verify_patch_integrity "$PATCH_FILENAME" "$TARGET_COMMIT_ID" "$TARGET_NORM_SUBJECT"; then
                                   echo "‚úÖ [Attempt $i] Download Success (Wget)"
                                   DOWNLOAD_OK=true
                                   break
                               fi
                          fi
                          
                          echo "‚ùå [Attempt $i] Failed. Cooling down ${BACKOFF_TIME}s..."
                          rm -f "$PATCH_FILENAME"
                          [ $i -lt $MAX_RETRIES ] && sleep $BACKOFF_TIME
                      done

                      if [ "$DOWNLOAD_OK" = false ]; then
                           echo "‚ùå DOWNLOAD FAILED: $RAW_NAME"
                           # Â¶ÇÊûúÂÖ©Ê¨°ÂòóË©¶ÈÉΩÂ§±ÊïóÔºåÊúÄÂæåÊúÉ return
                      fi
                  fi 

                  # ==========================================
                  # D. Âü∑Ë°å Patch (Apply Phase)
                  # ==========================================
                  if [ "$APPLY_PATCHES" = false ]; then
                      echo "üì¶ Patch downloaded (or failed) but NOT applied (Collection Mode/Skip)."
                      PROCESS_SUCCESS=true
                      break
                  fi
                  
                  if [ ! -f "$PATCH_FILENAME" ]; then
                      echo "‚ùå CRITICAL: Patch file missing '$PATCH_FILENAME'"
                      # ÈÄôË£°‰∏ç returnÔºåËÆìÂÆÉË∑ëÁ¨¨‰∫åÊ¨°Ëø¥ÂúàÁúãÁúã
                  fi
                  
                  # Ê™¢Êü•ÁõÆÈåÑ (ÈõñÁÑ∂‰∏äÈù¢ÊúâÊ™¢Êü•Ôºå‰ΩÜÁÇ∫‰∫ÜÈÇèËºØÂÆåÊï¥ÊÄß)
                  if [ ! -d "$IPT_ROOT" ]; then
                       echo "‚ùå CRITICAL: Source directory '$IPT_ROOT' NOT FOUND!"
                       return 1
                  fi

                  # 3. Âü∑Ë°å Patch
                  echo "ü©π Applying patch (Pass $PROCESS_ATTEMPT)..."
                  # ÈÄôË£°‰ΩøÁî® -d "$IPT_ROOT" Á¢∫‰øùË∑ØÂæëÊ≠£Á¢∫ÔºåÈõñÂ∑≤ cd ÈÄ≤ÂÖ•Ôºå‰ΩÜÂä†Âº∑‰øùÈö™
                  if patch -d "$IPT_ROOT" -t -N -l -F 10 -p1 --no-backup-if-mismatch --reject-file=- < "$PATCH_FILENAME"; then
                      echo "‚úÖ Patch Applied Successfully."
                      PROCESS_SUCCESS=true
                      break 
                  else
                      # üî• [V12 ‰øÆÊ≠£] Êô∫ÊÖßÂà§Êñ∑ÈÇèËºØ
                      if [ "$NEED_DOWNLOAD" = false ]; then
                          # Âø´ÂèñÂ§±Êïà -> Âà™Èô§Âø´Âèñ -> ÈáçË∑ëËø¥Âúà
                          echo "‚ö†Ô∏è Apply failed using cached file."
                          echo "üîÑ Deleting stale cache and forcing FRESH download loop..."
                          rm -f "$PATCH_FILENAME"
                          continue
                      else
                          # Êñ∞‰∏ãËºâ‰πüÂ§±Êïó -> Âö¥ÈáçÈåØË™§
                          echo "‚ùå CRITICAL: Patch failed even with fresh download."
                          echo "[$DATE] #$COUNT PATCH_FAIL : $RAW_NAME" >> "$LOG_FILE"
                          return 1
                      fi
                  fi
              done
          }

          # -------------------------------------------------------
          # 2. ÂØ´ÂÖ• "‰πæÊ∑®Áâà" Patch Ê∏ÖÂñÆ (Final Clean List - 53 Patches)
          # Â∑≤ÁßªÈô§: xsharedÈáçÊßã, xlateÁøªË≠Ø, ICMPËß£Êûê, IPv6Ë®àÊï∏Âô®(-c)
          # -------------------------------------------------------
          cat << 'EOL' > patch_list.txt
          2021-03-09|libxtables: Simplify xtables_ipmask_to_cidr() a bit|https://git.netfilter.org/iptables/patch/?id=831f57c7fbdc8d79e34b1d7d81ca6f6a8e6bae87
          2021-04-02|extensions: libxt_conntrack: use bitops for state negation|https://git.netfilter.org/iptables/patch/?id=18e334da7363ba186edb1700056e26ded27ca5ba
          2021-04-02|extensions: libxt_conntrack: use bitops for status negation|https://git.netfilter.org/iptables/patch/?id=18d7535d8bce1a13668e9982f53cbd3e56e8c634
          2021-06-07|libxtables: Fix memleak in xtopt_parse_hostmask()|https://git.netfilter.org/iptables/patch/?id=ffe88f8f01263687e82ef4d3d2bdc0cb5444711e
          2021-06-07|nft: Avoid memleak in error path of nft_cmd_new()|https://git.netfilter.org/iptables/patch/?id=eab75ed36a4f204ddab0c40ba42c5a300634d5c3
          2021-07-14|xtables: Call init_extensions6() for static builds|https://git.netfilter.org/iptables/patch/?id=e727ccad036e2cdba3339536c65c7ceef43c0740
          2021-08-04|libxtables: exit if called by setuid executeable|https://git.netfilter.org/iptables/patch/?id=ef7781eb1437a2d6fd37eb3567c599e3ea682b96
          2021-08-04|ip6tables: masquerade: use fully-random so that nft can understand the rule|https://git.netfilter.org/iptables/patch/?id=943fbf3e1850ae1f52f29c2f4f2aca399779b368
          2021-08-10|extensions: hashlimit: Fix tests with HZ=100|https://git.netfilter.org/iptables/patch/?id=bef9dc575625a98a5e6ed8ca37e49031cdba5937
          2021-08-31|extensions: libxt_mac: Fix for missing space in listing|https://git.netfilter.org/iptables/patch/?id=cf410aa6604d92faf2a2a5051ec18b7d9482e752
          2021-10-20|xtables-standalone: Drop version number from init errors|https://git.netfilter.org/iptables/patch/?id=0687852da7ed0a7ec8ebc88b41031dcae18c8898
          2021-11-23|extensions: hashlimit: Fix tests with HZ=1000|https://git.netfilter.org/iptables/patch/?id=1eab8e83aec0e6965f11f8cad460add1caeae629
          2022-01-18|extensions: libxt_NFLOG: don't truncate log prefix on print/save|https://git.netfilter.org/iptables/patch/?id=62ad29e9b778f4419573c6b43fe7a0a00d783fe6
          2022-01-18|extensions: libxt_NFLOG: fix --nflog-prefix Python test-cases|https://git.netfilter.org/iptables/patch/?id=f0d02998883d2efcb316cd6f524e2f7b3c4d055b
          2022-01-18|extensions: libxt_NFLOG: remove extra space when saving targets with prefixes|https://git.netfilter.org/iptables/patch/?id=05286bab77a6e0f9502e8fb99e1c53ed15663f3f
          2022-02-04|iptables-restore: Support for extra debug output|https://git.netfilter.org/iptables/patch/?id=17ed253f9dd401d7b83b81f5db93411bee592a40
          2022-03-02|libxtables: Register only the highest revision extension|https://git.netfilter.org/iptables/patch/?id=2dbb49d15fb44ddd521a734eca3be3f940b7c1ba
          2022-05-25|build: Fix error during out of tree build|https://git.netfilter.org/iptables/patch/?id=0ebf52fc951b2a4d98a166afb34af4f364bbeece
          2022-06-17|iptables.8: mention that iptables exits when setuid|https://git.netfilter.org/iptables/patch/?id=15a31ba8e8e146a5dafce59160b2eeefb00bccca
          2022-07-23|extensions: libxt_conntrack: remove always-false conditionals|https://git.netfilter.org/iptables/patch/?id=e88085ac41b4c962e1d85dcc8dc6fa0d1f80dc12
          2022-10-02|extensions: TCPOPTSTRIP: Do not print empty options|https://git.netfilter.org/iptables/patch/?id=dba32a76aacf84181a9bd3ba1e301e59ab49d370
          2022-10-07|libiptc: Fix for segfault when renaming a chain|https://git.netfilter.org/iptables/patch/?id=97bf4e68fc0794adba3243fd96f40f4568e7216f
          2022-12-02|iptables-xml: Free allocated chain strings|https://git.netfilter.org/iptables/patch/?id=73da7fb74c1089391dac0aca70e13e5f5999ace7
          2022-12-02|nft: Plug memleak in nft_rule_zero_counters()|https://git.netfilter.org/iptables/patch/?id=aa0c54030300441e9fd66c7016d0090f6736d449
          2022-12-02|iptables-restore: Free handle with --test also|https://git.netfilter.org/iptables/patch/?id=18880dbde615449d00a3e38f3713a19d4566258e
          2022-12-02|iptables: Plug memleaks in print_firewall()|https://git.netfilter.org/iptables/patch/?id=fb63f8b7337aa11a667537e6a3b399062ede2eb5
          2022-12-02|libiptc: Eliminate garbage access|https://git.netfilter.org/iptables/patch/?id=39a2aa8cbfc99f4a75dfc0786a80ced90952ab29
          2023-01-31|Proper fix for unknown argument error message|https://git.netfilter.org/iptables/patch/?id=d6eb6a9fd3878ce4fa01f8d4127f1735988bd07b
          2023-06-21|iptables: Fix handling of non-existent chains|https://git.netfilter.org/iptables/patch/?id=82ccfb488eeac5507471099b9b4e6d136cc06e3b
          2023-08-01|iptables-restore: Drop dead code|https://git.netfilter.org/iptables/patch/?id=4d9453233538200e9663c6bd0c2df09e1671b5f4
          2023-08-01|iptables-apply: Eliminate shellcheck warnings|https://git.netfilter.org/iptables/patch/?id=9f98550d58a49fc95d529ebdc0173579d957b425
          2023-08-04|extensions: libipt_icmp: Fix confusion between 255/255 and any|https://git.netfilter.org/iptables/patch/?id=5b5430d627bbc227a2d51d4312c371f2015834c6
          2023-08-10|Revert libiptc: fix wrong maptype of base chain counters on restore|https://git.netfilter.org/iptables/patch/?id=43f78733059ecd28d8567d8205cab5ed62d93458
          2023-09-14|extensions: Fix checking of conntrack --ctproto 0|https://git.netfilter.org/iptables/patch/?id=2e704f6ddd6d056e360f3d9c11e8b6c56a20cf23
          2023-10-12|libiptc: Fix for another segfault due to chain index NULL pointer|https://git.netfilter.org/iptables/patch/?id=e2d7ee9c49b582f399ad4ba2da2ee1b3e1f89620
          2023-10-12|extensions: string: Clarify description of --to|https://git.netfilter.org/iptables/patch/?id=920ece2b392fb83bd26416e0e6f8f6a847aacbaa
          2023-10-25|extensions: string: Adjust description of --to to recent kernel changes|https://git.netfilter.org/iptables/patch/?id=ccecb1b90ae2af6e963d27ada8d5fd69d40231c4
          2023-11-07|ebtables: Fix corner-case noflush restore bug|https://git.netfilter.org/iptables/patch/?id=c1083acea70787eea3f7929fd04718434bb05ba8
          2023-12-15|build: replace echo -e with printf|https://git.netfilter.org/iptables/patch/?id=f5cf76626d95d2c491a80288bccc160c53b44e88
          2024-01-10|extensions: libxt_limit: Use guided option parser for NFPROTO_BRIDGE, too|https://git.netfilter.org/iptables/patch/?id=84915856a892ca316ecf427cb17f8344a999083b
          2024-01-10|extensions: libxt_HMARK: Review HMARK_parse()|https://git.netfilter.org/iptables/patch/?id=f4721951baca81b7d74c5551d0f5c599dbb89bf1
          2024-01-24|iptables: Add missing error codes|https://git.netfilter.org/iptables/patch/?id=0a118c474924f05224b215cf38b7b3a19a9f0265
          2024-02-01|libxtables: Fix memleak of matches udata|https://git.netfilter.org/iptables/patch/?id=e7366db80740d34d2fe4ba8d12ef86a423e66280
          2024-02-01|ebtables: Fix for memleak with change counters command|https://git.netfilter.org/iptables/patch/?id=11c77ed471f2d8a6dc60c17aef1e1a3b52ff3591
          2024-02-07|libxtables: Add dccp and ipcomp to xtables_chain_protos|https://git.netfilter.org/iptables/patch/?id=a369c736a7fa88a176dbdb17fd50cf30074f54ab
          2024-04-25|configure: Add option to enable/disable libnfnetlink|https://git.netfilter.org/iptables/patch/?id=653db8b938166db7833135f615b90c38a3f27a30
          2024-06-12|man: extensions: recent: Clarify default value of ip_list_hash_size|https://git.netfilter.org/iptables/patch/?id=14f313ec68e2e4ff7eeb94b0fd125f7adcab77e3
          2024-07-27|extensions: conntrack: Use the right callbacks|https://git.netfilter.org/iptables/patch/?id=bb2ee075d8a626f2249ef9507927fae155b24093
          2024-07-27|extensions: recent: Fix format string for unsigned values|https://git.netfilter.org/iptables/patch/?id=8696f659eadd58505469841a3af16ad2c830e8e5
          2024-07-27|extensions: recent: New kernels support 999 hits|https://git.netfilter.org/iptables/patch/?id=d859b91e6f3ed055c22ee7b984b481c5b518d9e1
          2024-07-31|extensions: conntrack: Reuse print_state() for old state match|https://git.netfilter.org/iptables/patch/?id=1c86d5513cd79c1df1a5e473ce51256129723f3e
          2024-08-14|ebtables: Zero freed pointers in ebt_cs_clean()|https://git.netfilter.org/iptables/patch/?id=7b7c0936303abd0a7b26c8bc1382136265815677
          2024-08-29|configure: Determine if musl is used for build|https://git.netfilter.org/iptables/patch/?id=76fce22826f8e860b5eb5b5a2463040c17ff85da
          EOL

          # -------------------------------------------------------
          # 2. ËÆÄÂèñÊ∏ÖÂñÆ‰∏¶Âü∑Ë°å
          # -------------------------------------------------------
          COUNT=0
          if [ -f patch_list.txt ]; then
              while IFS='|' read -r P_DATE P_MSG P_URL; do
                  # ÈÅéÊøæÁ©∫Ë°åÊàñË®ªËß£ (Êõ¥Âö¥Ë¨πÁöÑÈÅéÊøæ)
                  [[ -z "$P_DATE" || "$P_DATE" =~ ^# ]] && continue
                  
                  COUNT=$((COUNT + 1))
                  download_and_process "$P_DATE" "$P_MSG" "$P_URL" "$COUNT"
              done < patch_list.txt
          fi
          
          echo "üéâ Main patch processing cycle completed!"

          # =======================================================
          # [Á¨¨100Ëôü Patch] ÊáâÁî®Â±èËîΩË≠¶ÂëäË£ú‰∏Å (ÂØ¨ÂÆπÊ®°Âºè)
          # =======================================================
          echo "üîß Generating warning suppression patch (Patch #100)..."
          
          PATCH_100="$PATCH_DIR/100_Custom_Suppress_Warnings.patch"
          
          # Ê≥®ÊÑèÔºöÈÄôË£°ÂòóË©¶ÈáùÂ∞ç 1.8.7 ÁöÑË°åËôüÈÄ≤Ë°åÂæÆË™øÔºå‰ΩÜ‰ªçÂèØËÉΩÂ§±Êïó
          cat << 'END_PATCH' > "$PATCH_100"
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          END_PATCH

          # Âè™ÊúâÂú®ÈñãÂïüÂ•óÁî®Ê®°ÂºèÊôÇÊâçÂü∑Ë°å
          if [ "$APPLY_PATCHES" = true ]; then
              echo "ü©π Applying Custom Patch #100 IMMEDIATELY..."
              # -t:Ëá™ÂãïË∑≥ÈÅéÁº∫Ê™î, -N:Ë∑≥ÈÅéÂ∑≤‰øÆÂæ©, -F 10:ÂÖÅË®±10Ë°åË™§Â∑Æ, -d:ÊåáÂÆöÁõÆÈåÑ
              if patch -d "$IPT_ROOT" -t -N -l -F 10 -p1 --no-backup-if-mismatch --reject-file=- < "$PATCH_100"; then
                  echo "‚úÖ Patch #100 Applied Successfully."
              else
                  echo "‚ö†Ô∏è Patch #100 Failed (Skipped or Mismatch)."
                  echo "[LOCAL] #100 PATCH_FAIL : Custom_Suppress_Warnings" >> "$LOG_FILE"
              fi
          else
              echo "üì¶ Custom Patch #100 generated but NOT applied."
          fi

          # =======================================================
          # 5. [‰øÆÊ≠£‰ΩçÁΩÆ] Á∏ΩÁµêÂ†±Âëä (ÁèæÂú®ÂèØ‰ª•ÂåÖÂê´ Patch #100 ÁöÑÁµêÊûú)
          # =======================================================
          if [ -s "$LOG_FILE" ]; then
              echo "‚ö†Ô∏è ================= SUMMARY ================="
              cat "$LOG_FILE"
              echo "=========================================="
          else
              echo "‚úÖ Perfect! No errors recorded (All 53+1 patches applied)."
          fi

          # =======================================================
          # üîç ÁÑ°Ê¢ù‰ª∂È©óË≠â‰ª£Á¢ºÂÖßÂÆπ (Â¢ûÂº∑ÁâàÔºöÈ°ØÁ§∫Á®ãÂºèÁ¢º‰∏ä‰∏ãÊñá)
          # =======================================================
          echo "üîç Verifying code content..."
          TARGET_FILE="libxtables/xtables.c"
          # Âõ†ÁÇ∫ÊàëÂÄëÂ∑≤Á∂ì cd ÈÄ≤ÂÖ• IPT_ROOTÔºåÊâÄ‰ª•Áõ¥Êé•Êü• libxtables
          if [ -f "$TARGET_FILE" ]; then
              # Ê™¢Êü•ÊòØÂê¶Âê´ÊúâÁâπÂæµÁ¢º (#if 0 ÂåÖË£πËëó Warning)
              if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
                  echo "‚úÖ Verification Passed: Code is correctly patched!"
                  echo "üëá Current Code Snippet (Looks Good):"
                  # È°ØÁ§∫ÂåπÈÖçË°åÂèäÂÖ∂‰∏ä‰∏ã 3 Ë°åÔºåÊñπ‰æø‰∫∫Â∑•Á¢∫Ë™ç
                  grep -nC 3 "Warning: Extension %s is not supported" "$TARGET_FILE"
              else
                  echo "‚ö†Ô∏è Verification Failed: Code was NOT patched. (Warning suppression might not work)"
                  echo "üëá Current Code Snippet (Original/Unpatched):"
                  grep -nC 3 "Warning: Extension %s is not supported" "$TARGET_FILE"
              fi
          else
              echo "‚ÑπÔ∏è Verification skipped: Source file '$TARGET_FILE' not found yet."
              echo "   (This is normal for a clean build before compilation starts)"
          fi
          
          echo "::endgroup::"

      # =======================================================
      # [Êñ∞Â¢û] Á∂≤Ë∑ØÂ∑•ÂÖ∑ÂçáÁ¥ö v31 (Ë∑ØÂæëÈÅ©ÈÖç /opt/rt-n56u)
      # =======================================================
      - name: üî• Network Tools (Smart Compile & Robust Kernel Config)
        run: |
          echo "::group::Smart Compile Network Tools"
          
          # === Ë®≠ÂÆöË∑ØÂæë (ÈÅ©ÈÖçÊ≠§ workflow) ===
          BASE_DIR="/opt/rt-n56u/trunk/user"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. Arptables (‰øÆÂæ© Tab ÈÖçÂ∞çÂïèÈ°å + Á¢∫‰øùÂêçÂñÆÊúâÂÆÉ)
          # ========================================
          echo "‚¨áÔ∏è Processing Arptables..."
          
          # [Ê≠•È©ü A] Á¢∫‰øù Userland Config ÈñãÂïü
          USER_CONFIG="/opt/rt-n56u/trunk/.config"
          if [ -f "$USER_CONFIG" ]; then
              echo "üîß Enabling CONFIG_USER_ARPTABLES in Userland .config..."
              sed -i 's/^CONFIG_USER_ARPTABLES=.*/CONFIG_USER_ARPTABLES=y/' "$USER_CONFIG"
              if ! grep -q "CONFIG_USER_ARPTABLES=y" "$USER_CONFIG"; then
                  echo "CONFIG_USER_ARPTABLES=y" >> "$USER_CONFIG"
              fi
          fi

          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          # ‰∏ãËºâÂéüÂßãÁ¢º
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            wget --no-check-certificate "https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz" -O src.tar.gz
            tar -xf src.tar.gz && rm -f src.tar.gz
            
            ARP_SRC_NAME=$(ls -d arptables-0*/ | head -n 1 | sed 's/\///')
            chmod -R u+w "$ARP_SRC_NAME"
            
            echo "üîß Creating Arptables Wrapper Makefile..."
            
            # [Ê≠•È©ü B] Wrapper
            cat << EOF > Makefile
          SRC_NAME=$ARP_SRC_NAME
          all:
          	\$(MAKE) -C \$(SRC_NAME) \
          		CC="\$(CC)" \
          		KERNEL_DIR=\$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		all
          	@if [ -f \$(SRC_NAME)/arptables ] && [ ! -f \$(SRC_NAME)/arptables-legacy ]; then \
          		cp \$(SRC_NAME)/arptables \$(SRC_NAME)/arptables-legacy; \
          	fi
          romfs:
          	\$(ROMFSINST) \$(SRC_NAME)/arptables-legacy /bin/arptables
          clean:
          	\$(MAKE) -C \$(SRC_NAME) clean
          	rm -f \$(SRC_NAME)/arptables-legacy
          EOF
          
            # [Ê≠•È©ü C] Ë®ªÂÜäÁõÆÈåÑ (ÈáùÂ∞ç Tab ÊúÄ‰Ω≥Âåñ)
            echo "üîß Registering arptables in trunk/user/Makefile..."
            cd "$BASE_DIR" || exit 1
            
            # 1. ÂÖàÂÇô‰ªΩ‰∏Ä‰∏ã
            cp Makefile Makefile.bak
            
            # 2. ‰ΩøÁî® .* ‰æÜÂøΩÁï•Á©∫Ê†ºÊàñ Tab ÁöÑÂ∑ÆÁï∞ÔºåÁ¢∫‰øùÊäìÂæóÂà∞ ebtables ÈÇ£‰∏ÄË°å
            #    Â¶ÇÊûú Makefile Ë£°Ê≤íÊúâ arptablesÔºåÂ∞±ÊèíÂú® ebtables ÂæåÈù¢
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                sed -i '/dir_y.*+=.*ebtables/a dir_y += arptables' Makefile
            else
                echo "‚ö†Ô∏è Arptables already in Makefile."
            fi

            # 3. [ÈõôÈáç‰øùÈö™] Â¶ÇÊûú sed ÈÇÑÊòØÂ§±ÊïóÔºåÁõ¥Êé•ËøΩÂä†Âà∞Ê™îÊ°àÊúÄÂæåÈù¢ (‰ΩÜÊòØÂú® all: ‰πãÂâç)
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                echo "‚ö†Ô∏è Sed failed, forcing append..."
                # ÈÄôË£°ÊØîËºÉÊö¥ÂäõÔºåÁõ¥Êé•ÊèíÂú® busybox ÂæåÈù¢ (busybox ËÇØÂÆöÂú®ÊúÄÂâçÈù¢)
                sed -i '/dir_y.*+=.*busybox/a dir_y += arptables' Makefile
            fi
            
            # 4. [È©óË≠â] Âç∞Âá∫ÁµêÊûúÁµ¶‰Ω†ÁúãÔºåËÆì‰Ω†ÊîæÂøÉ
            echo "üîé Checking Makefile content for arptables:"
            grep "arptables" Makefile || echo "‚ùå ERROR: Arptables install failed!"
          fi
          
          # ========================================
          # 2. Ê†∏ÂøÉÊ®°ÁµÑÊîØÊè¥ (Kernel Config)
          # ========================================
          cd "/opt/rt-n56u"
          # Ëá™ÂãïÂà§Êñ∑Ê†∏ÂøÉÁâàÊú¨Ë∑ØÂæë
          TARGET_KCONF="trunk/linux-4.4.x/.config"
          [ ! -f "$TARGET_KCONF" ] && TARGET_KCONF="trunk/linux-3.4.x/.config"
          
          if [ -f "$TARGET_KCONF" ]; then
             MODULES="CONFIG_IP_NF_ARPTABLES CONFIG_IP_NF_ARPFILTER CONFIG_IP_NF_ARP_MANGLE CONFIG_NF_LOG_ARP CONFIG_BRIDGE_EBT_ARP CONFIG_BRIDGE_EBT_ARPREPLY"
             for mod in $MODULES; do
                if grep -q "$mod" "$TARGET_KCONF"; then
                   sed -i "s|^.*$mod.*$|$mod=m|" "$TARGET_KCONF"
                else
                   echo "$mod=m" >> "$TARGET_KCONF"
                fi
             done
          fi
          
          echo "::endgroup::"

      - name: ‚¨áÔ∏è-Prepare-Toolchain
        env:
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
          TOOLCHAIN_DIR: /opt/rt-n56u/toolchain-mipsel/toolchain-4.4.x
        run: |
          cd /opt/rt-n56u/toolchain-mipsel
          TOOLCHAIN_TAG_FOR_NAME=$(echo "${{ inputs.toolchain_select }}" | sed 's/ (.*//g' | sed 's/\//-/g')
          echo "TOOLCHAIN_TAG_FOR_NAME=$TOOLCHAIN_TAG_FOR_NAME" >> $GITHUB_ENV
          
          # Ê∏ÖÁêÜÁí∞Â¢É
          rm -rf "$TOOLCHAIN_DIR" toolchain-4.4.x
          # Âª∫Á´ã‰∏ÄÂÄãËá®ÊôÇËß£Â£ìÂçÄÔºåÈÅøÂÖçË∑ØÂæëÊ∑∑‰∫Ç
          mkdir -p "temp_extract"

          echo "üîß Processing: $TOOLCHAIN_CHOICE"

          case "$TOOLCHAIN_CHOICE" in
            "Padavan-NG (GCC 13+, uClibc-ng, ZSTD)")
              URL="https://gitlab.com/api/v4/projects/hadzhioglu%2Fpadavan-ng/packages/generic/toolchain/latest/toolchain.tzst"
              echo "‚¨áÔ∏è Downloading Padavan-NG..."
              curl -L "$URL" | tar --zstd -xf - -C "temp_extract"
              ;;
            
            "Default (hanwckf/linux-4.4-v1.0, uclibc)") 
              sh dl_toolchain.sh 
              # Default ËÖ≥Êú¨ÈÄöÂ∏∏ÊúÉÂª∫Á´ãÊ≠£Á¢∫ÁõÆÈåÑÔºå‰∏çÈúÄË¶ÅÂæåÁ∫åÊê¨Áßª
              rm -rf temp_extract
              exit 0
              ;;
            
            "TurboTse/musl (gcc 13.3.0, musl 1.2.5)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
              
            "tsl0922/musl (gcc 13.2.0, musl 1.2.4)") 
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)") 
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)") 
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
          esac
          
          # === Êô∫ÊÖßÂûãÁõÆÈåÑÂÅµÊ∏¨ËàáÊê¨Áßª ===
          echo "üîç Locating toolchain bin directory..."
          # ÊâæÂá∫Âê´Êúâ 'mipsel-linux-gcc' ÁöÑ bin ÁõÆÈåÑ
          BIN_PATH=$(find temp_extract -type f -name "mipsel-linux-gcc" -o -name "mipsel-linux-uclibc-gcc" | head -n 1 | xargs dirname)
          
          if [ -z "$BIN_PATH" ]; then
             echo "::error:: ‚ùå Critical: Could not find gcc binary in extracted files!"
             ls -R temp_extract
             exit 1
          fi
          
          # BIN_PATH ÁöÑ‰∏ä‰∏ÄÂ±§Â∞±ÊòØÊàëÂÄëË¶ÅÁöÑ Toolchain Root
          ACTUAL_ROOT=$(dirname "$BIN_PATH")
          echo "‚úÖ Found toolchain root at: $ACTUAL_ROOT"
          
          # ÁßªÂãïÂà∞ÁõÆÊ®ô‰ΩçÁΩÆ
          mkdir -p "$(dirname "$TOOLCHAIN_DIR")"
          mv "$ACTUAL_ROOT" "$TOOLCHAIN_DIR"
          rm -rf temp_extract
          
          # === ‰øÆÊ≠£Âü∑Ë°åÊ™îÂêçÁ®± (Âª∫Á´ã Symlink) ===
          # Ë®±Â§öËÖ≥Êú¨ÂØ´Ê≠ªÂëºÂè´ mipsel-linux-gccÔºå‰ΩÜÊñ∞ Toolchain Âè™Êúâ mipsel-linux-uclibc-gcc
          cd "$TOOLCHAIN_DIR/bin"
          if [ ! -f "mipsel-linux-gcc" ] && [ -f "mipsel-linux-uclibc-gcc" ]; then
             echo "üîß Creating symlinks for compatibility..."
             ln -sf mipsel-linux-uclibc-gcc mipsel-linux-gcc
             ln -sf mipsel-linux-uclibc-g++ mipsel-linux-g++
             ln -sf mipsel-linux-uclibc-ld mipsel-linux-ld
             ln -sf mipsel-linux-uclibc-ar mipsel-linux-ar
             ln -sf mipsel-linux-uclibc-strip mipsel-linux-strip
          fi
          
          ls -lh "$TOOLCHAIN_DIR/bin" | head -n 5
          
          # Âª∫Á´ãÁ≥ªÁµ±ÈÄ£Áµê
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s "$TOOLCHAIN_DIR" /toolchain-4.4.x

      - name: üìù-CORE-Modify-Template-and-Sync-Config
        env:
          RAW_TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
        run: |
          TEMPLATE_DIR="/opt/rt-n56u/trunk/configs/templates"
          TRUNK_CONFIG="/opt/rt-n56u/trunk/.config"
          
          PATTERN_A=$(echo "$RAW_TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$RAW_TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 1 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ] || [ ! -f "$TARGET_FILE" ]; then
             echo "::error:: ‚ùå Êâæ‰∏çÂà∞Ë®≠ÂÆöÊ™îÔºÅ" && exit 1
          fi
          
          REAL_MODEL=$(basename "$TARGET_FILE" .config)
          echo "REAL_MODEL=$REAL_MODEL" >> $GITHUB_ENV

          # Ê•µÈôêÁò¶Ë∫´ÈÇèËºØ
          if [ "$NANO_OPT" = "true" ] || [[ "$REAL_MODEL" =~ "nano" ]]; then
            modules=(
              UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS \
              NTFS_3G LPRD U2EC HDPARM PARTED SMBD WINS SMBD_SYSLOG \
              FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN \
              SSWAN XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION \
              TRANSMISSION_WEB_CONTROL ARIA ARIA_WEB_CONTROL SCUTCLIENT \
              GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER \
              SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE \
              LRZSZ IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY \
              MENTOHUST FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY \
              TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER \
              SMARTDNS ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER \
              SQM WIREGUARD
            )
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" "$TARGET_FILE"
            done
          fi

          # Ê†∏ÂøÉ‰øùÁïôÊ®°ÁµÑ
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SFE QOS)
          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$TARGET_FILE"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$TARGET_FILE"
          done
          
          # 3. „ÄêÁµÇÊ•µÂÆâÂÖ®Áâà„ÄëÈáùÂ∞ç GCC 13+ ÁöÑÁ∑®Ë≠ØÊúÄ‰Ω≥Âåñ
          # ‰∏ç‰øÆÊîπ‰ªª‰ΩïÊ†∏ÂøÉ‰ª£Á¢ºÔºåÂÉÖÈÄèÈÅéÂèÉÊï∏ÊäëÂà∂Â†±ÈåØÔºåÁ¢∫‰øùÈÇèËºØÁµïÂ∞çÂÆâÂÖ®ÔºÅ
          if [[ "$TOOLCHAIN_CHOICE" == *"Padavan-NG"* ]] || [[ "$TOOLCHAIN_CHOICE" == *"TurboTse"* ]]; then
             echo "üîß GCC 13+ detected. Applying SAFE compiler flags..."
             
             # ÁµÑÂêàÂÆâÂÖ®ÂèÉÊï∏Ôºö
             # -std=gnu99: ‰ΩøÁî®ËàäÁâà C Ê®ôÊ∫ñ
             # -Wno-error=...: Â∞áÁâπÂÆöÁöÑÈåØË™§ÈôçÁ¥öÁÇ∫Ë≠¶ÂëäÔºå‰∏ç‰∏≠Êñ∑Á∑®Ë≠Ø
             # array-bounds: Ëß£Ê±∫ traps.c ÁöÑ -1 Â†±ÈåØ
             # stringop-overflow: Ëß£Ê±∫ Realtek È©ÖÂãïÂ†±ÈåØ
             # maybe-uninitialized: Ëß£Ê±∫ËÆäÊï∏ÂàùÂßãÂåñË™§Âà§
             SAFE_FLAGS="-std=gnu99 -Wno-error=array-bounds -Wno-array-bounds -Wno-error=stringop-overflow -Wno-error=maybe-uninitialized -Wno-error=implicit-function-declaration -Wno-error=int-conversion"
             
             echo "CONFIG_FIRMWARE_CFLAGS=\"$SAFE_FLAGS\"" >> "$TARGET_FILE"
             
             echo "‚úÖ Safe flags injected. Kernel source remains UNTOUCHED."
          fi
          
          cp -f "$TARGET_FILE" "$TRUNK_CONFIG"

      - name: üî®-Build-Host-Tools
        run: |
          cd /opt/rt-n56u/trunk
          [ -f "tools/mkimage/mkimage.c" ] && sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
          make tools

      - name: üìù-Apply-Custom-Settings
        run: |
          cd /opt/rt-n56u
          chmod +x trunk/custom/scripts/*.sh
          bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict
          bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/defaults.h
          bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/defaults.h

      - name: üèóÔ∏è-Build-Firmware
        run: |
          cd /opt/rt-n56u/trunk
          sudo ./clear_tree
          # ‰øÆÊîπÈáçÈªûÔºö
          # 1. 2>&1 : ÊääÈåØË™§Ë®äÊÅØ (stderr) ‰πüÂ∞éÂêëÂà∞Ê®ôÊ∫ñËº∏Âá∫ÔºåÈÄôÊ®£Â†±ÈåØ‰πüÊúÉË¢´Ë®òÈåÑ„ÄÇ
          # 2. | tee build.log : ÂÉè T ÂûãÊ∞¥ÁÆ°‰∏ÄÊ®£Ôºå‰∏ÄÈÇäÊµÅÂêëËû¢Âπï(Áµ¶‰Ω†Áúã)Ôºå‰∏ÄÈÇäÊµÅÂêëÊ™îÊ°à(Â≠òÊ™î)„ÄÇ
          sudo ./build_firmware_modify "${{ env.REAL_MODEL }}" 0 2>&1 | tee build.log
          
          # Ê™¢Êü•‰∏Ä‰∏ãÊòØÂê¶ÁúüÁöÑÁî¢Áîü‰∫Ü (Èô§ÈåØÁî®)
          ls -lh build.log
          
          FINAL_FILENAME="${{ env.REAL_MODEL }}-${{ env.TOOLCHAIN_TAG_FOR_NAME }}-${{ env.BUILD_TIME }}.trx"
          FOUND_FILE=$(find images -name "*.trx" | head -n 1)
          if [ -z "$FOUND_FILE" ]; then echo "::error::Êú™Áî¢Âá∫ TRX Ê™îÊ°à"; exit 1; fi
          sudo mv -f "$FOUND_FILE" "/opt/images/$FINAL_FILENAME"
          echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV

      # =======================================================
      # [‰øÆÊîπ] Êô∫ÊÖßÊâìÂåÖ (DebugËøΩËπ§ + Áî¢Áâ©Êî∂ÈõÜ)
      # =======================================================
      - name: üì¶-Smart-Pack-Artifacts-Debug
        run: |
          echo "::group::Smart Packing & Debug Collection"
          
          # ÂÆöÁæ©Ë∑ØÂæë (ÈÅ©ÈÖç /opt/rt-n56u)
          WORK_DIR="/opt/rt-n56u"
          PACK_DIR="/opt/images/output_pack"
          IMAGES_DIR="/opt/images"
          
          mkdir -p "$PACK_DIR"
          
          # 1. Êî∂ÈõÜÈóúÈçµÈÖçÁΩÆËàáÊó•Ë™å
          echo "Collecting Configs and Logs..."
          [ -f "$WORK_DIR/trunk/.config" ] && cp "$WORK_DIR/trunk/.config" "$PACK_DIR/build.config"
          [ -f "$WORK_DIR/trunk/configs/boards/busybox.config" ] && cp "$WORK_DIR/trunk/configs/boards/busybox.config" "$PACK_DIR/busybox.config"
          [ -f "$WORK_DIR/trunk/user/shared/defaults.h" ] && cp "$WORK_DIR/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "$WORK_DIR/trunk/linux-4.4.x/.config" ] && cp "$WORK_DIR/trunk/linux-4.4.x/.config" "$PACK_DIR/kernel.config"
          # ÈÄôË£°Ë∑ØÂæëË¶ÅÂ∞çÊáâ‰∏äÈù¢Áî¢ÁîüÁöÑ‰ΩçÁΩÆ
          # Âõ†ÁÇ∫‰∏äÈù¢ÊòØÂú® trunk Ë≥áÊñôÂ§æ‰∏ãÁî¢ÁîüÁöÑ build.log
          if [ -f "$WORK_DIR/trunk/build.log" ]; then
              echo "‚úÖ Found build.log, copying..."
              cp "$WORK_DIR/trunk/build.log" "$PACK_DIR/build.log"
          else
              echo "‚ö†Ô∏è Warning: build.log not found in trunk/"
          fi

          # =======================================================
          # üî• 2. Âº∑ÂåñÔºöÊî∂ÈõÜ iptables Áõ∏ÈóúÁî¢Áâ© (Êô∫ÊÖßÈ©óË≠âÁâà)
          # =======================================================
          # ÂÆöÁæ© Padavan 4.4 ÁöÑ iptables Ë∑ØÂæë
          IPT_SRC_DIR="$WORK_DIR/trunk/user/iptables/iptables-1.8.7"
          PATCH_ARCHIVE_DIR="$IPT_SRC_DIR/patches_archive"
          DEBUG_DIR="$PACK_DIR/debug_iptables"
          
          mkdir -p "$DEBUG_DIR"
          
          # 2.1 Êî∂ÈõÜ Patch Ê™îÊ°à
          if [ -d "$PATCH_ARCHIVE_DIR" ]; then
              cp "$PATCH_ARCHIVE_DIR"/*.patch "$DEBUG_DIR/"
              echo "‚úÖ All patches collected in debug_iptables"
          else
              echo "‚ö†Ô∏è Warning: Patches archive directory not found!"
          fi
          
          # 2.2 Êî∂ÈõÜ Patch ÈÅéÁ®ãÊó•Ë™å
          if [ -f "$IPT_SRC_DIR/patch_summary.log" ]; then
              cp "$IPT_SRC_DIR/patch_summary.log" "$DEBUG_DIR/patch_summary.log"
              echo "‚úÖ patch_summary.log collected"
          fi

          # 2.3 Êô∫ÊÖßË§áË£Ω xtables.c (Ê†πÊìöÂÖßÂÆπÊ±∫ÂÆöÊ™îÂêç)
          TARGET_FILE="$IPT_SRC_DIR/libxtables/xtables.c"
          
          if [ -f "$TARGET_FILE" ]; then
              # Ê™¢Êü•ÊòØÂê¶Âê´ÊúâÊàëÂÄë Patch #100 ÁöÑÁâπÂæµÁ¢º (Â±èËîΩË≠¶ÂëäÁöÑ if 0)
              if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
                  # Âà§ÂÆöÁÇ∫Â∑≤ Patch
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_patched.c"
                  echo "‚úÖ Detected PATCHED xtables.c - Saving as xtables_patched.c"
              else
                  # Âà§ÂÆöÁÇ∫Êú™ Patch (ÂéüÁâàÊàñ Patch Â§±Êïó)
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_original.c"
                  echo "‚ÑπÔ∏è Detected UNPATCHED xtables.c - Saving as xtables_original.c"
              fi
          else
               echo "‚ö†Ô∏è Warning: xtables.c not found (Maybe build failed or path differs)"
          fi
          
          # 2.4 È°çÂ§ñÊî∂ÈõÜ config.log
          if [ -f "$IPT_SRC_DIR/config.log" ]; then
              cp "$IPT_SRC_DIR/config.log" "$DEBUG_DIR/config.log"
              echo "‚úÖ config.log collected"
          fi
          # =======================================================

          # 3. ÁßªÂãïÈüåÈ´îÊ™îÊ°àÂà∞ÊâìÂåÖÁõÆÈåÑ
          if [ -f "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" ]; then
             cp "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" "$PACK_DIR/"
          else
             echo "::warning:: Firmware file not found in images dir!"
          fi

          # 4. Áî¢Áîü MD5
          cd "$PACK_DIR"
          md5sum * > md5sum.txt 2>/dev/null || true
          
          # 5. ÊâìÂåÖ Zip
          cd "/opt/images"
          ZIP_NAME="Padavan-${{ env.REAL_MODEL }}-${{ env.BUILD_TIME }}.zip"
          zip -j -r "$ZIP_NAME" "$PACK_DIR"
          
          # Ë®≠ÂÆöÁí∞Â¢ÉËÆäÊï∏‰æõ Upload Ëàá Release ‰ΩøÁî®
          echo "FINAL_ZIP_PATH=/opt/images/$ZIP_NAME" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: üì¶-Upload-Artifacts
        uses: actions/upload-artifact@master
        with:
          name: ${{ inputs.target_select }}-${{ env.BUILD_TIME }}
          path: ${{ env.FINAL_ZIP_PATH }}

      - name: üè∑Ô∏è-Set-Release-Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=build-${{ inputs.target_select }}-${{ env.BUILD_TIME }}" >> $GITHUB_ENV

      - name: üöÄ-Publish-Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: Build ${{ inputs.target_select }} (${{ env.BUILD_TIME }})
          body: |
            **Padavan Á∑®Ë≠ØÂ†±Âëä (Enhanced)**
            * Ê©üÂûã: ${{ inputs.target_select }}
            * ÊôÇÈñì: ${{ env.BUILD_TIME }}
            * LAN IP: ${{ env.LANIP }}
            * Â∑•ÂÖ∑Èèà: ${{ inputs.toolchain_select }}
            
            ### ÂåÖÂê´ÂÖßÂÆπ
            * ÈüåÈ´îÊ™îÊ°à (.trx)
            * Á≥ªÁµ±ÈÖçÁΩÆ (build.config, kernel.config)
            * Debug Ë≥áË®ä (defaults.h, iptables patch check)
          artifacts: ${{ env.FINAL_ZIP_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
