name: Custom-Router-Build-Final-Fix

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "é¸æ“‡æ©Ÿå‹ (æ”¯æ´ K2P, K2P-NANO, K2P-USB ç­‰)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
          - MI-R3G
          - NEWIFI3
          - RM2100
        default: K2P

      nanoversion:
        description: "æ˜¯å¦åŸ·è¡Œæ¥µé™ç˜¦èº«"
        type: boolean
        default: true
      
      customization:
        description: 'è‡ªå®šç¾©é…ç½® JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'
      
      toolchain_select:
        description: "é¸æ“‡ç·¨è­¯å·¥å…·éˆ"
        required: true
        type: choice
        options:
          - Default (hanwckf/linux-4.4-v1.0, uclibc)
          - Padavan-NG (GCC 13+, uClibc-ng, ZSTD)
          - TurboTse/musl (gcc 13.3.0, musl 1.2.5)
          - TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)
          - tsl0922/musl (gcc 13.2.0, musl 1.2.4)
          - tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)
          - hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)
        default: Default (hanwckf/linux-4.4-v1.0, uclibc)

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: ğŸ“¥-Checkout-Repository
        uses: actions/checkout@master
      
      - name: ğŸš€-Install-Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git zstd \
            build-essential fakeroot flex bison gawk gperf \
            autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq
          # è¨­å®šå°ç£æ™‚é–“ YYYYMMDD-HHMM
          echo "BUILD_TIME=$(TZ='Asia/Taipei' date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          mkdir -p /opt/images/

      - name: ğŸ”-Export-Custom-Variables
        run: |
          jq empty <<< '${{ inputs.customization }}' || { echo "âŒ Invalid JSON"; exit 1; }
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            echo "${k^^}=$v" >> $GITHUB_ENV  
          done

      - name: â¬‡ï¸-Clone-Source-Code
        run: |
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-4.4.git /opt/rt-n56u

      # =======================================================
      # [å®Œå…¨æ¬é‹ç‰ˆ] ç›´æ¥å¾ Repo ä¸‹è¼‰ libmnl è¦†è“‹
      # =======================================================
      - name: ğŸ”¥ Sync libmnl from padavan-ng repo
        run: |
          echo "::group::Direct Sync libmnl"
          
          # 1. é€²å…¥ libs ç›®éŒ„ä¸¦ç§»é™¤èˆŠçš„ libmnl
          cd /opt/rt-n56u/trunk/libs
          rm -rf libmnl
          
          # 2. é€éè‡¨æ™‚ç›®éŒ„ Clone è©² Repo (åªæŠ“ master åˆ†æ”¯)
          git clone --depth=1 https://github.com/TWShiyuLiou1997/padavan-ng.git /tmp/padavan-ng
          
          # 3. æŠŠè©² Repo è£¡çš„ libmnl å®Œæ•´æ‹·è²éä¾†
          cp -rf /tmp/padavan-ng/trunk/libs/libmnl ./libmnl
          
          # 4. æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
          rm -rf /tmp/padavan-ng
          
          # 5. æª¢æŸ¥ç¢ºèªæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "./libmnl/Makefile" ]; then
            echo "âœ… libmnl æ¬é‹æˆåŠŸï¼ä½¿ç”¨ padavan-ng åŸå§‹è…³æœ¬ã€‚"
            ls -al ./libmnl
          else
            echo "::error::âŒ æ¬é‹å¤±æ•—ï¼æ‰¾ä¸åˆ° Makefile"
            exit 1
          fi
          
          echo "::endgroup::"

      # =======================================================
      # [ä¿®å¾©ç‰ˆ] iptables 1.8.7 Patch (Debug Mode)
      # =======================================================
      - name: ğŸ”¥ Patch iptables 1.8.7 with 100 Fixes
        run: |
          # é–‹å•Ÿè©³ç´°é™¤éŒ¯æ¨¡å¼ï¼Œå‡ºéŒ¯æ™‚æœƒé¡¯ç¤ºæŒ‡ä»¤
          set -x
          
          echo "::group::Patching Iptables 1.8.7"
          
          # å®šç¾©ç›®æ¨™è·¯å¾‘
          IPT_ROOT="/opt/rt-n56u/trunk/user/iptables/iptables-1.8.7"
          
          if [ ! -d "$IPT_ROOT" ]; then
             echo "âŒ Error: æ‰¾ä¸åˆ°åŸå§‹ç¢¼ç›®éŒ„ $IPT_ROOT"
             ls -R /opt/rt-n56u/trunk/user/iptables/
             exit 1
          fi
          
          cd "$IPT_ROOT"
          echo "ğŸ“‚ Entered directory: $(pwd)"

          # å»ºç«‹å­˜æ”¾ patch çš„è³‡æ–™å¤¾
          mkdir -p patches_archive

          # -------------------------------------------------------
          # 1. å…ˆå°‡æ¸…å–®å¯«å…¥æš«å­˜æª” (é¿å… YAML HEREDOC ç¸®æ’éŒ¯èª¤)
          # -------------------------------------------------------
          cat << 'EOL' > patch_list.txt
          2021-06-07|libxtables: Fix memleak in xtopt_parse_hostmask()|https://git.netfilter.org/iptables/patch/?id=ffe88f8f01263687e82ef4d3d2bdc0cb5444711e
          2021-06-07|nft: Avoid memleak in error path of nft_cmd_new()|https://git.netfilter.org/iptables/patch/?id=eab75ed36a4f204ddab0c40ba42c5a300634d5c3
          2021-11-28|extensions: tcpmss: add iptables-translate support|https://git.netfilter.org/iptables/patch/?id=273d88a7744ea5638969ad3252acf518e5ec6cc2
          2022-10-02|extensions: TCPOPTSTRIP: Do not print empty options|https://git.netfilter.org/iptables/patch/?id=dba32a76aacf84181a9bd3ba1e301e59ab49d370
          2022-10-07|libiptc: Fix for segfault when renaming a chain|https://git.netfilter.org/iptables/patch/?id=97bf4e68fc0794adba3243fd96f40f4568e7216f
          2022-11-24|extensions: TCPMSS: Use xlate callback for IPv6, too|https://git.netfilter.org/iptables/patch/?id=e05d9af176cb2a62c1bd24fa1d82b12a8ad00221
          2022-11-24|extensions: tcp: Translate TCP option match|https://git.netfilter.org/iptables/patch/?id=0b946dabf34a068adf3e35924578ffb06a249bb8
          2022-12-02|iptables-xml: Free allocated chain strings|https://git.netfilter.org/iptables/patch/?id=73da7fb74c1089391dac0aca70e13e5f5999ace7
          2022-12-02|nft: Plug memleak in nft_rule_zero_counters()|https://git.netfilter.org/iptables/patch/?id=aa0c54030300441e9fd66c7016d0090f6736d449
          2022-12-02|iptables-restore: Free handle with --test also|https://git.netfilter.org/iptables/patch/?id=18880dbde615449d00a3e38f3713a19d4566258e
          2022-12-02|iptables: Plug memleaks in print_firewall()|https://git.netfilter.org/iptables/patch/?id=fb63f8b7337aa11a667537e6a3b399062ede2eb5
          2022-12-02|iptables: Properly clear iptables_command_state object|https://git.netfilter.org/iptables/patch/?id=8bee0db39f7553589c2cec58cc92ed2eafd2eb57
          2022-12-02|libiptc: Eliminate garbage access|https://git.netfilter.org/iptables/patch/?id=39a2aa8cbfc99f4a75dfc0786a80ced90952ab29
          2023-08-10|Revert libiptc: fix wrong maptype of base chain counters on restore|https://git.netfilter.org/iptables/patch/?id=43f78733059ecd28d8567d8205cab5ed62d93458
          2023-09-14|extensions: Fix checking of conntrack --ctproto 0|https://git.netfilter.org/iptables/patch/?id=2e704f6ddd6d056e360f3d9c11e8b6c56a20cf23
          2023-10-12|libiptc: Fix for another segfault due to chain index NULL pointer|https://git.netfilter.org/iptables/patch/?id=e2d7ee9c49b582f399ad4ba2da2ee1b3e1f89620
          2023-11-07|ebtables: Fix corner-case noflush restore bug|https://git.netfilter.org/iptables/patch/?id=c1083acea70787eea3f7929fd04718434bb05ba8
          2023-11-29|libxtables: xtoptions: Fix for garbage access in xtables_options_xfrm()|https://git.netfilter.org/iptables/patch/?id=584569727dc0fc52f401db628059807030138a99
          2023-12-15|build: replace echo -e with printf|https://git.netfilter.org/iptables/patch/?id=f5cf76626d95d2c491a80288bccc160c53b44e88
          2023-12-21|iptables-legacy: Fix for mandatory lock waiting|https://git.netfilter.org/iptables/patch/?id=63ab5b8906f6913a14d38ec231f21daa760339a9
          2024-02-01|libxtables: Fix memleak of matches udata|https://git.netfilter.org/iptables/patch/?id=e7366db80740d34d2fe4ba8d12ef86a423e66280
          2024-02-01|xshared: Fix for memleak in option merging with ebtables|https://git.netfilter.org/iptables/patch/?id=933e605154c439218f73f48b028abbeed336c3c5
          2024-02-01|ebtables: Fix for memleak with change counters command|https://git.netfilter.org/iptables/patch/?id=11c77ed471f2d8a6dc60c17aef1e1a3b52ff3591
          2024-04-10|libxtables: Attenuate effects of functions internal static buffers|https://git.netfilter.org/iptables/patch/?id=8bf2bab8eb2e4f5ae2fef859ea7c877662854101
          2024-07-31|xshared: Move NULL pointer check into save_iface()|https://git.netfilter.org/iptables/patch/?id=8e3e579e753f7a00c099a37ca8601d0da19f14bf
          2024-08-14|ebtables: Zero freed pointers in ebt_cs_clean()|https://git.netfilter.org/iptables/patch/?id=7b7c0936303abd0a7b26c8bc1382136265815677
          2021-08-04|libxtables: exit if called by setuid executeable|https://git.netfilter.org/iptables/patch/?id=ef7781eb1437a2d6fd37eb3567c599e3ea682b96
          2021-08-04|ip6tables: masquerade: use fully-random so that nft can understand the rule|https://git.netfilter.org/iptables/patch/?id=943fbf3e1850ae1f52f29c2f4f2aca399779b368
          2021-08-31|extensions: libxt_mac: Fix for missing space in listing|https://git.netfilter.org/iptables/patch/?id=cf410aa6604d92faf2a2a5051ec18b7d9482e752
          2021-10-20|xtables-standalone: Drop version number from init errors|https://git.netfilter.org/iptables/patch/?id=0687852da7ed0a7ec8ebc88b41031dcae18c8898
          2021-11-23|xshared: Share print_header() with legacy iptables|https://git.netfilter.org/iptables/patch/?id=24f30842d979da464c1c3ef106d2efa66a480735
          2021-12-16|xshared: Share a common printhelp function|https://git.netfilter.org/iptables/patch/?id=56ac0452a4968f1af8d3ad1717c8646593177155
          2022-01-12|xshared: Store parsed wait and wait_interval in xtables_args|https://git.netfilter.org/iptables/patch/?id=ded7b57977f3fa619975f752a342046225b56935
          2022-05-25|build: Fix error during out of tree build|https://git.netfilter.org/iptables/patch/?id=0ebf52fc951b2a4d98a166afb34af4f364bbeece
          2023-01-12|extensions: NAT: Fix for -Werror=format-security|https://git.netfilter.org/iptables/patch/?id=ed4082a7405a5838c205a34c1559e289949200cc
          2023-11-29|libxtables: xtoptions: Fix for non-CIDR-compatible hostmasks|https://git.netfilter.org/iptables/patch/?id=41139aee5e53304182a25f1e573f034b313f7232
          2024-02-07|iptables-save: Avoid /etc/protocols lookups|https://git.netfilter.org/iptables/patch/?id=ff57cd48d2b0c01c1519fd8893fc0432ad211702
          2024-04-25|configure: Add option to enable/disable libnfnetlink|https://git.netfilter.org/iptables/patch/?id=653db8b938166db7833135f615b90c38a3f27a30
          2024-08-29|configure: Determine if musl is used for build|https://git.netfilter.org/iptables/patch/?id=76fce22826f8e860b5eb5b5a2463040c17ff85da
          2025-01-28|configure: Avoid addition assignment operators|https://git.netfilter.org/iptables/patch/?id=6310639f697d4a570286960c470a6ec8c324be89
          2022-01-12|iptables: Use xtables do_parse() function|https://git.netfilter.org/iptables/patch/?id=9baf3bf0e77dab6ca4b167554ec0e57b65d0af01
          2023-06-21|iptables: Fix handling of non-existent chains|https://git.netfilter.org/iptables/patch/?id=82ccfb488eeac5507471099b9b4e6d136cc06e3b
          2023-06-21|iptables: Fix setting of ipv6 counters|https://git.netfilter.org/iptables/patch/?id=ed839159edf8bda8e9196f1056c4038c22d78bfd
          2024-01-24|iptables: Add missing error codes|https://git.netfilter.org/iptables/patch/?id=0a118c474924f05224b215cf38b7b3a19a9f0265
          2024-02-01|xshared: Introduce xtables_clear_args()|https://git.netfilter.org/iptables/patch/?id=d109e41344b8f54741c0862a44d544a713178dd3
          2024-02-02|libxtables: xtoptions: Respect min/max values when completing ranges|https://git.netfilter.org/iptables/patch/?id=a392cf0e9b11b01352d02e81fbd5ad4da49bce94
          2024-02-02|libxtables: Reject negative port ranges|https://git.netfilter.org/iptables/patch/?id=9d41421a887f4bc4b3ba10174cf43ee2c6b76956
          2024-02-02|libxtables: xtoptions: Assert ranges are monotonic increasing|https://git.netfilter.org/iptables/patch/?id=30a7f11234a81bd2389c7e7224769b1fdd192239
          2024-04-10|xshared: Fix parsing of empty string arg in -c option|https://git.netfilter.org/iptables/patch/?id=a2911408959d7e86bc4bad4f1be2551a19ad125c
          2024-10-16|xshared: iptables does not support -b|https://git.netfilter.org/iptables/patch/?id=05af72ca6184f08435c1ef31436e1eb7ac931e14
          2024-11-07|libxtables: Hide xtables_strtoul_base() symbol|https://git.netfilter.org/iptables/patch/?id=b15981e6ff2138b45bce3867454ae084790cbf43
          2025-04-23|xshared: Accept an option if any given command allows it|https://git.netfilter.org/iptables/patch/?id=192c3a6bc18f206895ec5e38812d648ccfe7e281
          2021-03-09|xtables-translate: Fix translation of odd netmasks|https://git.netfilter.org/iptables/patch/?id=46f9d3a9a61ee80fa94b7fa7b3b36045c92606ae
          2021-03-09|libxtables: Simplify xtables_ipmask_to_cidr() a bit|https://git.netfilter.org/iptables/patch/?id=831f57c7fbdc8d79e34b1d7d81ca6f6a8e6bae87
          2021-04-02|extensions: libxt_conntrack: use bitops for state negation|https://git.netfilter.org/iptables/patch/?id=18e334da7363ba186edb1700056e26ded27ca5ba
          2021-04-02|extensions: libxt_conntrack: use bitops for status negation|https://git.netfilter.org/iptables/patch/?id=18d7535d8bce1a13668e9982f53cbd3e56e8c634
          2021-05-17|xtables: Make invflags 16bit wide|https://git.netfilter.org/iptables/patch/?id=f647f61f273a15ed25307d7ca7a19cefc828c54c
          2021-05-17|xshared: Eliminate iptables_command_state->invert|https://git.netfilter.org/iptables/patch/?id=3664249f520308e8d9ce6238374f08ac96aedbb6
          2021-05-17|xshared: Merge invflags handling code|https://git.netfilter.org/iptables/patch/?id=9dc50b5b8e4416219c700331c6e301d840f6e55d
          2021-06-07|extensions: libxt_connlimit: add translation|https://git.netfilter.org/iptables/patch/?id=bb01e33d3828d08cd77cc3c9664b2a995ee150cc
          2021-06-07|extensions: libxt_tcp: rework translation to use flags match representation|https://git.netfilter.org/iptables/patch/?id=1c934617f661dc0bc471c0f0b4ace254c55182df
          2021-06-07|extensions: libxt_conntrack: simplify translation using negation|https://git.netfilter.org/iptables/patch/?id=c8145139cb230ff22837795c97f2e264c574c64c
          2021-06-25|extensions: libxt_multiport: add translation for -m multiport --ports|https://git.netfilter.org/iptables/patch/?id=9e1fffdfeb29a0638e10fda3c0e984d3592e3124
          2021-07-14|xtables: Call init_extensions6() for static builds|https://git.netfilter.org/iptables/patch/?id=e727ccad036e2cdba3339536c65c7ceef43c0740
          2021-08-10|extensions: hashlimit: Fix tests with HZ=100|https://git.netfilter.org/iptables/patch/?id=bef9dc575625a98a5e6ed8ca37e49031cdba5937
          2021-11-23|extensions: hashlimit: Fix tests with HZ=1000|https://git.netfilter.org/iptables/patch/?id=1eab8e83aec0e6965f11f8cad460add1caeae629
          2022-01-18|extensions: libxt_NFLOG: don't truncate log prefix on print/save|https://git.netfilter.org/iptables/patch/?id=62ad29e9b778f4419573c6b43fe7a0a00d783fe6
          2022-01-18|extensions: libxt_NFLOG: fix --nflog-prefix Python test-cases|https://git.netfilter.org/iptables/patch/?id=f0d02998883d2efcb316cd6f524e2f7b3c4d055b
          2022-01-18|extensions: libxt_NFLOG: remove extra space when saving targets with prefixes|https://git.netfilter.org/iptables/patch/?id=05286bab77a6e0f9502e8fb99e1c53ed15663f3f
          2022-02-04|iptables-restore: Support for extra debug output|https://git.netfilter.org/iptables/patch/?id=17ed253f9dd401d7b83b81f5db93411bee592a40
          2022-03-02|libxtables: Register only the highest revision extension|https://git.netfilter.org/iptables/patch/?id=2dbb49d15fb44ddd521a734eca3be3f940b7c1ba
          2022-03-02|Improve error messages for unsupported extensions|https://git.netfilter.org/iptables/patch/?id=17534cb18ed0a5052dc45c117401251359dba6aa
          2022-03-17|libxtables: Boost rule target checks by announcing chain names|https://git.netfilter.org/iptables/patch/?id=ac4c84cc63d3cc021ca532692885a644fcde4518
          2022-05-18|treewide: use uint* instead of u_int*|https://git.netfilter.org/iptables/patch/?id=f319389525b066b7dc6d389c88f16a0df3b8f189
          2022-06-17|iptables.8: mention that iptables exits when setuid|https://git.netfilter.org/iptables/patch/?id=15a31ba8e8e146a5dafce59160b2eeefb00bccca
          2022-07-23|extensions: libxt_conntrack: remove always-false conditionals|https://git.netfilter.org/iptables/patch/?id=e88085ac41b4c962e1d85dcc8dc6fa0d1f80dc12
          2022-07-25|iptables: xshared: Ouptut -- in the opt field in ipv6 fake mode|https://git.netfilter.org/iptables/patch/?id=6e41c2d8747b25ed08dff41bbb9f77fb35bc1851
          2022-11-15|extensions: Unify ICMP parser into libxt_icmp.h|https://git.netfilter.org/iptables/patch/?id=be8c6056040848b019e76e8b578598b35bae2655
          2022-11-29|extensions: libxt_conntrack: Drop extra whitespace in xlate|https://git.netfilter.org/iptables/patch/?id=116848ea1e5d8d02fd766356a642bd81574e2723
          2023-01-31|Proper fix for unknown argument error message|https://git.netfilter.org/iptables/patch/?id=d6eb6a9fd3878ce4fa01f8d4127f1735988bd07b
          2023-08-01|iptables-restore: Drop dead code|https://git.netfilter.org/iptables/patch/?id=4d9453233538200e9663c6bd0c2df09e1671b5f4
          2023-08-01|iptables-apply: Eliminate shellcheck warnings|https://git.netfilter.org/iptables/patch/?id=9f98550d58a49fc95d529ebdc0173579d957b425
          2023-08-04|extensions: libipt_icmp: Fix confusion between 255/255 and any|https://git.netfilter.org/iptables/patch/?id=5b5430d627bbc227a2d51d4312c371f2015834c6
          2023-10-12|extensions: string: Clarify description of --to|https://git.netfilter.org/iptables/patch/?id=920ece2b392fb83bd26416e0e6f8f6a847aacbaa
          2023-10-25|extensions: string: Adjust description of --to to recent kernel changes|https://git.netfilter.org/iptables/patch/?id=ccecb1b90ae2af6e963d27ada8d5fd69d40231c4
          2024-01-10|extensions: libxt_limit: Use guided option parser for NFPROTO_BRIDGE, too|https://git.netfilter.org/iptables/patch/?id=84915856a892ca316ecf427cb17f8344a999083b
          2024-01-10|extensions: libxt_HMARK: Review HMARK_parse()|https://git.netfilter.org/iptables/patch/?id=f4721951baca81b7d74c5551d0f5c599dbb89bf1
          2024-02-02|extensions: tcp/udp: Save/xlate inverted full ranges|https://git.netfilter.org/iptables/patch/?id=a86eb41ef2987a9f99cb2ef644fbe2a2096d58b2
          2024-02-07|libxtables: Add dccp and ipcomp to xtables_chain_protos|https://git.netfilter.org/iptables/patch/?id=a369c736a7fa88a176dbdb17fd50cf30074f54ab
          2024-04-09|xlate: libip6t_mh: Fix and simplify plain -m mh match|https://git.netfilter.org/iptables/patch/?id=400fb98dde882da4c1d2c763de3f16a8ba1484b4
          2024-06-12|man: extensions: recent: Clarify default value of ip_list_hash_size|https://git.netfilter.org/iptables/patch/?id=14f313ec68e2e4ff7eeb94b0fd125f7adcab77e3
          2024-07-27|xtables-monitor: Print commands instead of -4/-6/-0 flags|https://git.netfilter.org/iptables/patch/?id=73ac92c769c5f27ac59266ad94031ab6d54af80b
          2024-07-27|extensions: conntrack: Use the right callbacks|https://git.netfilter.org/iptables/patch/?id=bb2ee075d8a626f2249ef9507927fae155b24093
          2024-07-27|extensions: recent: Fix format string for unsigned values|https://git.netfilter.org/iptables/patch/?id=8696f659eadd58505469841a3af16ad2c830e8e5
          2024-07-31|extensions: conntrack: Reuse print_state() for old state match|https://git.netfilter.org/iptables/patch/?id=1c86d5513cd79c1df1a5e473ce51256129723f3e
          2025-04-23|extensions: icmp: Support info-request/-reply type names|https://git.netfilter.org/iptables/patch/?id=1e6a2812971a268428b04b03520cd68cb61d76e3
          2025-07-04|extensions: sctp: Translate bare -m sctp match|https://git.netfilter.org/iptables/patch/?id=12e6b5ed65fd91ea413a2e45201289c3d01c4e29
          2025-07-22|xtables-monitor: Print -X command for base chains, too|https://git.netfilter.org/iptables/patch/?id=8cb0c13b7777e72ca6f4265845dc99eff7cdf679
          EOL

          # -------------------------------------------------------
          # 2. å®šç¾©ä¸‹è¼‰èˆ‡å¥—ç”¨é‚è¼¯ (ç§»é™¤ function é—œéµå­—ä»¥ç›¸å®¹ sh)
          # -------------------------------------------------------
          download_and_apply() {
              local DATE=$1
              local RAW_NAME=$2
              local URL=$3
              local COUNT=$4
              
              # å‘½åæ¸…æ´—
              local SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9]/_/g')
              local PATCH_FILENAME="patches_archive/${COUNT}_${DATE}_${SAFE_NAME}.patch"
              
              echo "---------------------------------------------------"
              echo "Processing Patch #$COUNT"
              echo "ğŸ“… Date: $DATE"
              echo "ğŸ“ Name: $RAW_NAME"
              
              # ä¸‹è¼‰æµç¨‹ (å¢åŠ éŒ¯èª¤é‡è©¦é¡¯ç¤º)
              if wget --no-check-certificate -q -O "$PATCH_FILENAME" "$URL"; then
                  echo "âœ… Download Success (wget)"
              elif curl -k -L -o "$PATCH_FILENAME" "$URL"; then
                  echo "âœ… Download Success (curl fallback)"
              else
                  echo "âŒ Critical Error: Failed to download patch!"
                  exit 1
              fi
              
              # æª¢æŸ¥æª”æ¡ˆ
              if [ ! -s "$PATCH_FILENAME" ]; then
                  echo "âŒ Error: Downloaded patch is empty."
                  exit 1
              fi
              
              # å¥—ç”¨ Patch
              echo "ğŸ©¹ Applying patch..."
              if patch -p1 < "$PATCH_FILENAME"; then
                  echo "âœ… Patch Applied Successfully."
              else
                  echo "âŒ Error: Failed to apply patch."
                  exit 1
              fi
          }

          # -------------------------------------------------------
          # 3. è®€å–æ¸…å–®ä¸¦åŸ·è¡Œ (ä½¿ç”¨ read è®€å–å‰›å‰›ç”Ÿæˆçš„æª”æ¡ˆ)
          # -------------------------------------------------------
          count=0
          while IFS='|' read -r p_date p_name p_url; do
              # è·³éç©ºè¡Œ
              [ -z "$p_date" ] && continue
              
              # [ä¿®æ­£é‡é»] Bash ç®—è¡“é‹ç®—é™·é˜±ä¿®å¾©ï¼š
              # count++ å›å‚³å€¼ç‚º 0 (False)ï¼Œå°è‡´ set -e è§¸ç™¼éŒ¯èª¤é€€å‡º
              # æ”¹ç”¨æ¨™æº–è³¦å€¼å¯«æ³•
              count=$((count+1))
              
              download_and_apply "$p_date" "$p_name" "$p_url" "$count"
              
          done < patch_list.txt

          echo "ğŸ‰ All 99 Upstream Patches applied successfully!"

          # =======================================================
          # [ç¬¬100è™Ÿ Patch] æ‡‰ç”¨å±è”½è­¦å‘Šè£œä¸
          # =======================================================
          echo "ğŸ”§ Generating warning suppression patch (Patch #100)..."
          
          PATCH_100="patches_archive/100_Custom_Suppress_Warnings.patch"
          
          cat << 'END_PATCH' > "$PATCH_100"
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          END_PATCH

          echo "ğŸ©¹ Applying Custom Patch #100..."
          patch -p1 < "$PATCH_100" || echo "âš ï¸ Patch return error (Might be already applied), checking verification..."
          
          echo "ğŸ” verifying code content..."
          TARGET_FILE="libxtables/xtables.c"
          
          if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
              echo "âœ… Verification Passed: Code is correctly patched!"
          else
              echo "âŒ Verification Failed: Code is NOT patched properly!"
              exit 1
          fi
          
          echo "::endgroup::"

      # =======================================================
      # [æ–°å¢] ç¶²è·¯å·¥å…·å‡ç´š v31 (è·¯å¾‘é©é… /opt/rt-n56u)
      # =======================================================
      - name: ğŸ”¥ Network Tools (Smart Compile & Robust Kernel Config)
        run: |
          echo "::group::Smart Compile Network Tools"
          
          # === è¨­å®šè·¯å¾‘ (é©é…æ­¤ workflow) ===
          BASE_DIR="/opt/rt-n56u/trunk/user"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. Arptables (ä¿®å¾© Tab é…å°å•é¡Œ + ç¢ºä¿åå–®æœ‰å®ƒ)
          # ========================================
          echo "â¬‡ï¸ Processing Arptables..."
          
          # [æ­¥é©Ÿ A] ç¢ºä¿ Userland Config é–‹å•Ÿ
          USER_CONFIG="/opt/rt-n56u/trunk/.config"
          if [ -f "$USER_CONFIG" ]; then
              echo "ğŸ”§ Enabling CONFIG_USER_ARPTABLES in Userland .config..."
              sed -i 's/^CONFIG_USER_ARPTABLES=.*/CONFIG_USER_ARPTABLES=y/' "$USER_CONFIG"
              if ! grep -q "CONFIG_USER_ARPTABLES=y" "$USER_CONFIG"; then
                  echo "CONFIG_USER_ARPTABLES=y" >> "$USER_CONFIG"
              fi
          fi

          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          # ä¸‹è¼‰åŸå§‹ç¢¼
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            wget --no-check-certificate "https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz" -O src.tar.gz
            tar -xf src.tar.gz && rm -f src.tar.gz
            
            ARP_SRC_NAME=$(ls -d arptables-0*/ | head -n 1 | sed 's/\///')
            chmod -R u+w "$ARP_SRC_NAME"
            
            echo "ğŸ”§ Creating Arptables Wrapper Makefile..."
            
            # [æ­¥é©Ÿ B] Wrapper
            cat << EOF > Makefile
          SRC_NAME=$ARP_SRC_NAME
          all:
          	\$(MAKE) -C \$(SRC_NAME) \
          		CC="\$(CC)" \
          		KERNEL_DIR=\$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		all
          	@if [ -f \$(SRC_NAME)/arptables ] && [ ! -f \$(SRC_NAME)/arptables-legacy ]; then \
          		cp \$(SRC_NAME)/arptables \$(SRC_NAME)/arptables-legacy; \
          	fi
          romfs:
          	\$(ROMFSINST) \$(SRC_NAME)/arptables-legacy /bin/arptables
          clean:
          	\$(MAKE) -C \$(SRC_NAME) clean
          	rm -f \$(SRC_NAME)/arptables-legacy
          EOF
          
            # [æ­¥é©Ÿ C] è¨»å†Šç›®éŒ„ (é‡å° Tab å„ªåŒ–)
            echo "ğŸ”§ Registering arptables in trunk/user/Makefile..."
            cd "$BASE_DIR" || exit 1
            
            # 1. å…ˆå‚™ä»½ä¸€ä¸‹
            cp Makefile Makefile.bak
            
            # 2. ä½¿ç”¨ .* ä¾†å¿½ç•¥ç©ºæ ¼æˆ– Tab çš„å·®ç•°ï¼Œç¢ºä¿æŠ“å¾—åˆ° ebtables é‚£ä¸€è¡Œ
            #    å¦‚æœ Makefile è£¡æ²’æœ‰ arptablesï¼Œå°±æ’åœ¨ ebtables å¾Œé¢
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                sed -i '/dir_y.*+=.*ebtables/a dir_y += arptables' Makefile
            else
                echo "âš ï¸ Arptables already in Makefile."
            fi

            # 3. [é›™é‡ä¿éšª] å¦‚æœ sed é‚„æ˜¯å¤±æ•—ï¼Œç›´æ¥è¿½åŠ åˆ°æª”æ¡ˆæœ€å¾Œé¢ (ä½†æ˜¯åœ¨ all: ä¹‹å‰)
            if ! grep -q "dir_y.*+=.*arptables" Makefile; then
                echo "âš ï¸ Sed failed, forcing append..."
                # é€™è£¡æ¯”è¼ƒæš´åŠ›ï¼Œç›´æ¥æ’åœ¨ busybox å¾Œé¢ (busybox è‚¯å®šåœ¨æœ€å‰é¢)
                sed -i '/dir_y.*+=.*busybox/a dir_y += arptables' Makefile
            fi
            
            # 4. [é©—è­‰] å°å‡ºçµæœçµ¦ä½ çœ‹ï¼Œè®“ä½ æ”¾å¿ƒ
            echo "ğŸ” Checking Makefile content for arptables:"
            grep "arptables" Makefile || echo "âŒ ERROR: Arptables install failed!"
          fi
          
          # ========================================
          # 2. æ ¸å¿ƒæ¨¡çµ„æ”¯æ´ (Kernel Config)
          # ========================================
          cd "/opt/rt-n56u"
          # è‡ªå‹•åˆ¤æ–·æ ¸å¿ƒç‰ˆæœ¬è·¯å¾‘
          TARGET_KCONF="trunk/linux-4.4.x/.config"
          [ ! -f "$TARGET_KCONF" ] && TARGET_KCONF="trunk/linux-3.4.x/.config"
          
          if [ -f "$TARGET_KCONF" ]; then
             MODULES="CONFIG_IP_NF_ARPTABLES CONFIG_IP_NF_ARPFILTER CONFIG_IP_NF_ARP_MANGLE CONFIG_NF_LOG_ARP CONFIG_BRIDGE_EBT_ARP CONFIG_BRIDGE_EBT_ARPREPLY"
             for mod in $MODULES; do
                if grep -q "$mod" "$TARGET_KCONF"; then
                   sed -i "s|^.*$mod.*$|$mod=m|" "$TARGET_KCONF"
                else
                   echo "$mod=m" >> "$TARGET_KCONF"
                fi
             done
          fi
          
          echo "::endgroup::"

      - name: â¬‡ï¸-Prepare-Toolchain
        env:
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
          TOOLCHAIN_DIR: /opt/rt-n56u/toolchain-mipsel/toolchain-4.4.x
        run: |
          cd /opt/rt-n56u/toolchain-mipsel
          TOOLCHAIN_TAG_FOR_NAME=$(echo "${{ inputs.toolchain_select }}" | sed 's/ (.*//g' | sed 's/\//-/g')
          echo "TOOLCHAIN_TAG_FOR_NAME=$TOOLCHAIN_TAG_FOR_NAME" >> $GITHUB_ENV
          
          # æ¸…ç†ç’°å¢ƒ
          rm -rf "$TOOLCHAIN_DIR" toolchain-4.4.x
          # å»ºç«‹ä¸€å€‹è‡¨æ™‚è§£å£“å€ï¼Œé¿å…è·¯å¾‘æ··äº‚
          mkdir -p "temp_extract"

          echo "ğŸ”§ Processing: $TOOLCHAIN_CHOICE"

          case "$TOOLCHAIN_CHOICE" in
            "Padavan-NG (GCC 13+, uClibc-ng, ZSTD)")
              URL="https://gitlab.com/api/v4/projects/hadzhioglu%2Fpadavan-ng/packages/generic/toolchain/latest/toolchain.tzst"
              echo "â¬‡ï¸ Downloading Padavan-NG..."
              curl -L "$URL" | tar --zstd -xf - -C "temp_extract"
              ;;
            
            "Default (hanwckf/linux-4.4-v1.0, uclibc)") 
              sh dl_toolchain.sh 
              # Default è…³æœ¬é€šå¸¸æœƒå»ºç«‹æ­£ç¢ºç›®éŒ„ï¼Œä¸éœ€è¦å¾ŒçºŒæ¬ç§»
              rm -rf temp_extract
              exit 0
              ;;
            
            "TurboTse/musl (gcc 13.3.0, musl 1.2.5)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)") 
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
              
            "tsl0922/musl (gcc 13.2.0, musl 1.2.4)") 
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)") 
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
            
            "hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)") 
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" 
              curl -L "$URL" | tar -xf - -C "temp_extract"
              ;;
          esac
          
          # === æ™ºæ…§å‹ç›®éŒ„åµæ¸¬èˆ‡æ¬ç§» ===
          echo "ğŸ” Locating toolchain bin directory..."
          # æ‰¾å‡ºå«æœ‰ 'mipsel-linux-gcc' çš„ bin ç›®éŒ„
          BIN_PATH=$(find temp_extract -type f -name "mipsel-linux-gcc" -o -name "mipsel-linux-uclibc-gcc" | head -n 1 | xargs dirname)
          
          if [ -z "$BIN_PATH" ]; then
             echo "::error:: âŒ Critical: Could not find gcc binary in extracted files!"
             ls -R temp_extract
             exit 1
          fi
          
          # BIN_PATH çš„ä¸Šä¸€å±¤å°±æ˜¯æˆ‘å€‘è¦çš„ Toolchain Root
          ACTUAL_ROOT=$(dirname "$BIN_PATH")
          echo "âœ… Found toolchain root at: $ACTUAL_ROOT"
          
          # ç§»å‹•åˆ°ç›®æ¨™ä½ç½®
          mkdir -p "$(dirname "$TOOLCHAIN_DIR")"
          mv "$ACTUAL_ROOT" "$TOOLCHAIN_DIR"
          rm -rf temp_extract
          
          # === ä¿®æ­£åŸ·è¡Œæª”åç¨± (å»ºç«‹ Symlink) ===
          # è¨±å¤šè…³æœ¬å¯«æ­»å‘¼å« mipsel-linux-gccï¼Œä½†æ–° Toolchain åªæœ‰ mipsel-linux-uclibc-gcc
          cd "$TOOLCHAIN_DIR/bin"
          if [ ! -f "mipsel-linux-gcc" ] && [ -f "mipsel-linux-uclibc-gcc" ]; then
             echo "ğŸ”§ Creating symlinks for compatibility..."
             ln -sf mipsel-linux-uclibc-gcc mipsel-linux-gcc
             ln -sf mipsel-linux-uclibc-g++ mipsel-linux-g++
             ln -sf mipsel-linux-uclibc-ld mipsel-linux-ld
             ln -sf mipsel-linux-uclibc-ar mipsel-linux-ar
             ln -sf mipsel-linux-uclibc-strip mipsel-linux-strip
          fi
          
          ls -lh "$TOOLCHAIN_DIR/bin" | head -n 5
          
          # å»ºç«‹ç³»çµ±é€£çµ
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s "$TOOLCHAIN_DIR" /toolchain-4.4.x

      - name: ğŸ“-CORE-Modify-Template-and-Sync-Config
        env:
          RAW_TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
        run: |
          TEMPLATE_DIR="/opt/rt-n56u/trunk/configs/templates"
          TRUNK_CONFIG="/opt/rt-n56u/trunk/.config"
          
          PATTERN_A=$(echo "$RAW_TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$RAW_TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 1 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ] || [ ! -f "$TARGET_FILE" ]; then
             echo "::error:: âŒ æ‰¾ä¸åˆ°è¨­å®šæª”ï¼" && exit 1
          fi
          
          REAL_MODEL=$(basename "$TARGET_FILE" .config)
          echo "REAL_MODEL=$REAL_MODEL" >> $GITHUB_ENV

          # æ¥µé™ç˜¦èº«é‚è¼¯
          if [ "$NANO_OPT" = "true" ] || [[ "$REAL_MODEL" =~ "nano" ]]; then
            modules=(
              UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS \
              NTFS_3G LPRD U2EC HDPARM PARTED SMBD WINS SMBD_SYSLOG \
              FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN \
              SSWAN XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION \
              TRANSMISSION_WEB_CONTROL ARIA ARIA_WEB_CONTROL SCUTCLIENT \
              GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER \
              SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE \
              LRZSZ IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY \
              MENTOHUST FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY \
              TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER \
              SMARTDNS ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER \
              SQM WIREGUARD
            )
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" "$TARGET_FILE"
            done
          fi

          # æ ¸å¿ƒä¿ç•™æ¨¡çµ„
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SFE QOS)
          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$TARGET_FILE"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$TARGET_FILE"
          done
          
          # 3. ã€çµ‚æ¥µå®‰å…¨ç‰ˆã€‘é‡å° GCC 13+ çš„ç·¨è­¯å„ªåŒ–
          # ä¸ä¿®æ”¹ä»»ä½•æ ¸å¿ƒä»£ç¢¼ï¼Œåƒ…é€éåƒæ•¸æŠ‘åˆ¶å ±éŒ¯ï¼Œç¢ºä¿é‚è¼¯çµ•å°å®‰å…¨ï¼
          if [[ "$TOOLCHAIN_CHOICE" == *"Padavan-NG"* ]] || [[ "$TOOLCHAIN_CHOICE" == *"TurboTse"* ]]; then
             echo "ğŸ”§ GCC 13+ detected. Applying SAFE compiler flags..."
             
             # çµ„åˆå®‰å…¨åƒæ•¸ï¼š
             # -std=gnu99: ä½¿ç”¨èˆŠç‰ˆ C æ¨™æº–
             # -Wno-error=...: å°‡ç‰¹å®šçš„éŒ¯èª¤é™ç´šç‚ºè­¦å‘Šï¼Œä¸ä¸­æ–·ç·¨è­¯
             # array-bounds: è§£æ±º traps.c çš„ -1 å ±éŒ¯
             # stringop-overflow: è§£æ±º Realtek é©…å‹•å ±éŒ¯
             # maybe-uninitialized: è§£æ±ºè®Šæ•¸åˆå§‹åŒ–èª¤åˆ¤
             SAFE_FLAGS="-std=gnu99 -Wno-error=array-bounds -Wno-array-bounds -Wno-error=stringop-overflow -Wno-error=maybe-uninitialized -Wno-error=implicit-function-declaration -Wno-error=int-conversion"
             
             echo "CONFIG_FIRMWARE_CFLAGS=\"$SAFE_FLAGS\"" >> "$TARGET_FILE"
             
             echo "âœ… Safe flags injected. Kernel source remains UNTOUCHED."
          fi
          
          cp -f "$TARGET_FILE" "$TRUNK_CONFIG"

      - name: ğŸ”¨-Build-Host-Tools
        run: |
          cd /opt/rt-n56u/trunk
          [ -f "tools/mkimage/mkimage.c" ] && sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
          make tools

      - name: ğŸ“-Apply-Custom-Settings
        run: |
          cd /opt/rt-n56u
          chmod +x trunk/custom/scripts/*.sh
          bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict
          bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/defaults.h
          bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/defaults.h

      - name: ğŸ—ï¸-Build-Firmware
        run: |
          cd /opt/rt-n56u/trunk
          sudo ./clear_tree
          # ä¿®æ”¹é‡é»ï¼š
          # 1. 2>&1 : æŠŠéŒ¯èª¤è¨Šæ¯ (stderr) ä¹Ÿå°å‘åˆ°æ¨™æº–è¼¸å‡ºï¼Œé€™æ¨£å ±éŒ¯ä¹Ÿæœƒè¢«è¨˜éŒ„ã€‚
          # 2. | tee build.log : åƒ T å‹æ°´ç®¡ä¸€æ¨£ï¼Œä¸€é‚Šæµå‘è¢å¹•(çµ¦ä½ çœ‹)ï¼Œä¸€é‚Šæµå‘æª”æ¡ˆ(å­˜æª”)ã€‚
          sudo ./build_firmware_modify "${{ env.REAL_MODEL }}" 0 2>&1 | tee build.log
          
          # æª¢æŸ¥ä¸€ä¸‹æ˜¯å¦çœŸçš„ç”¢ç”Ÿäº† (é™¤éŒ¯ç”¨)
          ls -lh build.log
          
          FINAL_FILENAME="${{ env.REAL_MODEL }}-${{ env.TOOLCHAIN_TAG_FOR_NAME }}-${{ env.BUILD_TIME }}.trx"
          FOUND_FILE=$(find images -name "*.trx" | head -n 1)
          if [ -z "$FOUND_FILE" ]; then echo "::error::æœªç”¢å‡º TRX æª”æ¡ˆ"; exit 1; fi
          sudo mv -f "$FOUND_FILE" "/opt/images/$FINAL_FILENAME"
          echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV

      # =======================================================
      # [ä¿®æ”¹] æ™ºæ…§æ‰“åŒ… (Debugè¿½è¹¤ + ç”¢ç‰©æ”¶é›†)
      # =======================================================
      - name: ğŸ“¦-Smart-Pack-Artifacts-Debug
        run: |
          echo "::group::Smart Packing & Debug Collection"
          
          # å®šç¾©è·¯å¾‘ (é©é… /opt/rt-n56u)
          WORK_DIR="/opt/rt-n56u"
          PACK_DIR="/opt/images/output_pack"
          IMAGES_DIR="/opt/images"
          
          mkdir -p "$PACK_DIR"
          
          # 1. æ”¶é›†é—œéµé…ç½®èˆ‡æ—¥èªŒ
          echo "Collecting Configs and Logs..."
          [ -f "$WORK_DIR/trunk/.config" ] && cp "$WORK_DIR/trunk/.config" "$PACK_DIR/build.config"
          [ -f "$WORK_DIR/trunk/user/shared/defaults.h" ] && cp "$WORK_DIR/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "$WORK_DIR/trunk/linux-4.4.x/.config" ] && cp "$WORK_DIR/trunk/linux-4.4.x/.config" "$PACK_DIR/kernel.config"
          # é€™è£¡è·¯å¾‘è¦å°æ‡‰ä¸Šé¢ç”¢ç”Ÿçš„ä½ç½®
          # å› ç‚ºä¸Šé¢æ˜¯åœ¨ trunk è³‡æ–™å¤¾ä¸‹ç”¢ç”Ÿçš„ build.log
          if [ -f "$WORK_DIR/trunk/build.log" ]; then
              echo "âœ… Found build.log, copying..."
              cp "$WORK_DIR/trunk/build.log" "$PACK_DIR/build.log"
          else
              echo "âš ï¸ Warning: build.log not found in trunk/"
          fi

          # 2. æ”¶é›† iptables Debug æª”æ¡ˆ (å«æ‰€æœ‰ 100 å€‹ Patches)
          echo "Collecting Iptables Patches..."
          mkdir -p "$PACK_DIR/debug_iptables"
          
          # åŸå§‹ç¢¼ä½ç½® (éœ€èˆ‡ä¸Šæ–¹ Patch æ­¥é©Ÿä¸€è‡´)
          IPT_SRC_DIR="$WORK_DIR/trunk/user/iptables/iptables-1.8.7"
          PATCH_ARCHIVE_DIR="$IPT_SRC_DIR/patches_archive"
          
          # è¤‡è£½æˆ‘å€‘å‰›å‰›ä¸‹è¼‰ä¸¦ç”¢ç”Ÿçš„ 100 å€‹ patches
          if [ -d "$PATCH_ARCHIVE_DIR" ]; then
              cp "$PATCH_ARCHIVE_DIR"/*.patch "$PACK_DIR/debug_iptables/"
              echo "âœ… All 100 patches collected."
          else
              echo "âš ï¸ Warning: Patches archive directory not found!"
          fi
          
          # è¤‡è£½è¢«ä¿®æ”¹å¾Œçš„é—œéµåŸå§‹ç¢¼ä»¥ä¾›æŸ¥é©—
          if [ -f "$IPT_SRC_DIR/libxtables/xtables.c" ]; then
              cp "$IPT_SRC_DIR/libxtables/xtables.c" "$PACK_DIR/debug_iptables/xtables_patched.c"
          fi

          # 3. ç§»å‹•éŸŒé«”æª”æ¡ˆåˆ°æ‰“åŒ…ç›®éŒ„
          if [ -f "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" ]; then
             cp "$IMAGES_DIR/${{ env.FINAL_FILENAME }}" "$PACK_DIR/"
          else
             echo "::warning:: Firmware file not found in images dir!"
          fi

          # 4. ç”¢ç”Ÿ MD5
          cd "$PACK_DIR"
          md5sum * > md5sum.txt 2>/dev/null || true
          
          # 5. æ‰“åŒ… Zip
          cd "/opt/images"
          ZIP_NAME="Padavan-${{ env.REAL_MODEL }}-${{ env.BUILD_TIME }}.zip"
          zip -j -r "$ZIP_NAME" "$PACK_DIR"
          
          # è¨­å®šç’°å¢ƒè®Šæ•¸ä¾› Upload èˆ‡ Release ä½¿ç”¨
          echo "FINAL_ZIP_PATH=/opt/images/$ZIP_NAME" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: ğŸ“¦-Upload-Artifacts
        uses: actions/upload-artifact@master
        with:
          name: ${{ inputs.target_select }}-${{ env.BUILD_TIME }}
          path: ${{ env.FINAL_ZIP_PATH }}

      - name: ğŸ·ï¸-Set-Release-Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=build-${{ inputs.target_select }}-${{ env.BUILD_TIME }}" >> $GITHUB_ENV

      - name: ğŸš€-Publish-Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: Build ${{ inputs.target_select }} (${{ env.BUILD_TIME }})
          body: |
            **Padavan ç·¨è­¯å ±å‘Š (Enhanced)**
            * æ©Ÿå‹: ${{ inputs.target_select }}
            * æ™‚é–“: ${{ env.BUILD_TIME }}
            * LAN IP: ${{ env.LANIP }}
            * å·¥å…·éˆ: ${{ inputs.toolchain_select }}
            
            ### åŒ…å«å…§å®¹
            * éŸŒé«”æª”æ¡ˆ (.trx)
            * ç³»çµ±é…ç½® (build.config, kernel.config)
            * Debug è³‡è¨Š (defaults.h, iptables patch check)
          artifacts: ${{ env.FINAL_ZIP_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
